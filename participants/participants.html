<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>äºˆç´„ç®¡ç†</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 60px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 10px;border-radius:10px;cursor:pointer;
  font-size:12px;
  text-decoration:none;color:inherit;display:inline-flex;align-items:center;gap:6px;
}
.btn.primary{
  background:linear-gradient(135deg,var(--pri),var(--pri2));
  color:#fff;border:none;
}
.btn.danger{border-color:#fca5a5;color:#b91c1c}
.input{
  border:1px solid var(--line);
  padding:10px 12px;
  border-radius:12px;
  width:100%;
  background:#fff;
  font-size:13px;
}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:#b91c1c}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:900px){ .grid{grid-template-columns:1fr 1fr} }
@media(max-width:520px){ .grid{grid-template-columns:1fr} }

.badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
.badge.ok{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.hint{font-size:12px;color:var(--muted);line-height:1.4}

/* ===== ç”·å¥³åˆ†å‰²ï¼ˆç¢ºå®šä¸€è¦§ï¼‰ ===== */
.split{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media (max-width:720px){ .split{grid-template-columns:1fr} }
.box{border-radius:18px;padding:12px;box-shadow:var(--shadow);border:1px solid var(--line);}
.box.male{background:#eff6ff;border-color:#bfdbfe;}
.box.female{background:#fff1f2;border-color:#fecdd3;}
.boxHd{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.boxHd .ttl{font-weight:900;font-size:14px}
.boxHd .count{font-size:12px;font-weight:700;color:var(--muted)}

.pCard{border-radius:14px;padding:10px;margin-bottom:8px;background:#fff;border:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.pCard.male{ border-color:#dbeafe; }
.pCard.female{ border-color:#ffe4e6; }
.pName{font-weight:800; display:flex; align-items:center; gap:6px; flex-wrap:wrap}
.pMeta{font-size:12px;color:var(--muted);margin-top:4px}
.noteSex{font-size:12px;color:#b45309;margin-top:10px}
.pActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ===== ä¸‹å›ºå®šï¼šäºˆç´„ä¸€è¦§ãƒœã‚¿ãƒ³ ===== */
.bottomBar{
  position:fixed;left:0; right:0; bottom:0;padding:10px;
  background:rgba(246,247,251,.85);backdrop-filter: blur(8px);
  border-top:1px solid var(--line);display:flex;justify-content:center;z-index:20;
}
.bottomBar .btnLike{
  width:min(920px, calc(100% - 24px));
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:12px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.08);
  background:#fff;box-shadow:0 12px 36px rgba(15,23,42,.18);
  cursor:pointer;font-weight:900;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ===== */
.modalBack{position:fixed; inset:0;background:rgba(15,23,42,.35);display:none; align-items:center; justify-content:center;z-index:30;}
.modal{width:min(860px, 96vw);max-height:86vh;background:#fff;border-radius:16px;box-shadow:0 18px 60px rgba(15,23,42,.25);overflow:hidden;display:flex;flex-direction:column;}
.modalHd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.modalBd{padding:12px 14px;overflow:auto;}

/* äºˆç´„ã‚«ãƒ¼ãƒ‰ */
.rCard{
  border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-bottom:10px;background:#fff;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center
}
.rTitle{font-weight:900; display:flex; align-items:center; gap:6px; flex-wrap:wrap}
.rMeta{font-size:12px;color:var(--muted);margin-top:4px}
.rActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ===== æ–°è¦ç™»éŒ² æŠ˜ã‚ŠãŸãŸã¿ ===== */
.hdRow{display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%}
.foldBtn{
  border:1px solid var(--line);
  background:#fff;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  user-select:none;
}
.foldBtn .chev{font-weight:900}
.foldBody{display:block}
.foldBody.isHidden{display:none}

/* ===== ã‚«ãƒƒãƒ—ãƒ«æˆç«‹ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.heartModal .modal{width:min(520px, 92vw)}
.heartGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:420px){ .heartGrid{grid-template-columns:1fr 1fr} }
.heartBtn{
  border:1px solid var(--line);
  background:#fff;
  padding:10px 12px;
  border-radius:14px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
}
.heartBtn small{font-weight:600;color:var(--muted)}

/* ===== æ–™é‡‘ï¼†å‰²å¼•å…¥åŠ› ===== */
.priceRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
.pill{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
.pill strong{font-weight:900}
.smallInput{
  width:110px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--line);
  font-size:12px;
}

/* ===== é›†è¨ˆï¼†æ”¯æ‰•ã„ ===== */
.sumBar{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.sumPill{
  font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
  background:#fff;display:inline-flex;gap:6px;align-items:center
}
.sumPill strong{font-weight:900}
.sumPill.good{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.sumPill.warn{border-color:#fed7aa;background:#fffbeb;color:#92400e}

.payBadge{
  font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);
  background:#fff;display:inline-flex;align-items:center;gap:6px;font-weight:800
}
.payBadge.paid{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.payBadge.unpaid{border-color:#fecaca;background:#fff1f2;color:#9f1239}

/* ===== ã‚µã‚¸ã‚§ã‚¹ãƒˆ ===== */
.suggest{ position:relative; margin-top:6px; }
.suggest .panel{
  position:absolute; left:0; right:0; z-index:40;
  background:#fff; border:1px solid var(--line); border-radius:12px;
  box-shadow:0 16px 40px rgba(15,23,42,.14); overflow:hidden;
}
.suggest .item{
  padding:10px 12px; cursor:pointer;
  display:flex; justify-content:space-between; gap:10px; align-items:center;
}
.suggest .item:hover{ background:#f8fafc; }
.suggest .main{ font-weight:800; font-size:13px; }
.suggest .sub{ font-size:12px; color:var(--muted); }
.suggest .tag{
  font-size:11px; padding:3px 8px; border:1px solid var(--line);
  border-radius:999px; background:#fff; white-space:nowrap;
}

/* ===== äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç”·å¥³ã§åˆ†ã‹ã‚Šã‚„ã™ãï¼ˆã‚¿ãƒ–ï¼‹è‰²ï¼‰ ===== */
.tabRow{display:flex;gap:8px;flex-wrap:wrap}
.tabBtn{
  border:1px solid var(--line);
  background:#fff;
  padding:8px 10px;
  border-radius:999px;
  cursor:pointer;
  font-weight:900;
  font-size:12px;
}
.tabBtn.on{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;border:none}
.tabCnt{font-size:11px;color:var(--muted);font-weight:800}
.resWrap{margin-top:10px}
.resBox{border-radius:18px;padding:12px;border:1px solid var(--line);box-shadow:var(--shadow)}
.resBox.male{background:#eff6ff;border-color:#bfdbfe}
.resBox.female{background:#fff1f2;border-color:#fecdd3}
.resBox.unknown{background:#f8fafc;border-color:#e5e7eb}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>å‚åŠ è€…ç®¡ç†</h1>
      <div class="sub">æ–°è¦ç™»éŒ²ã¯ã€Œäºˆç´„ã€â†’ã€Œå‚åŠ ç¢ºå®šã€ã§å‚åŠ è€…ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn" href="../admin.html">ç®¡ç†ã¸æˆ»ã‚‹</a>
    <a class="btn" href="../customers/customers.html">é¡§å®¢ãƒã‚¹ã‚¿</a>
  </div>
</header>

<section class="card">
  <div class="hd">
    <strong>ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</strong>
    <span class="meta" id="evStatus">-</span>
    <span class="meta" id="loadedAt">-</span>
  </div>
  <div class="bd">
    <select class="input" id="eventSel"></select>
    <div class="hint" style="margin-top:8px">
      â€»ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã¶ã¨ã€ã€Œå‚åŠ ç¢ºå®šè€…ã€ã ã‘ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚äºˆç´„ã¯ä¸‹ã®ã€Œäºˆç´„ä¸€è¦§ã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
    </div>
  </div>
</section>

<!-- â˜…æ–°è¦ç™»éŒ²ã‚«ãƒ¼ãƒ‰ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ -->
<section class="card" style="margin-top:14px" id="newCard">
  <div class="hd">
    <div class="hdRow">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <strong>æ–°è¦ç™»éŒ²ï¼ˆã¾ãšäºˆç´„ã«å…¥ã‚‹ï¼‰</strong>
        <span class="meta">åå‰ or é›»è©±ç•ªå·ã§é¡§å®¢ãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•èª­è¾¼</span>
        <span class="badge" id="autoBadge" style="display:none">è‡ªå‹•èª­è¾¼</span>
      </div>

      <button class="foldBtn" id="btnToggleNew" type="button" aria-expanded="true">
        <span class="chev" id="newChev">â–²</span>
        <span id="newFoldLabel">é–‰ã˜ã‚‹</span>
      </button>
    </div>
  </div>

  <div class="bd foldBody" id="newBody">
    <div class="grid">
      <div>
        <div class="meta" style="margin:0 0 6px">åå‰ï¼ˆå¿…é ˆï¼‰</div>
        <input class="input" id="pName" type="search"
          placeholder="ä¾‹ï¼‰å±±ç”° èŠ±å­"
          autocomplete="new-password"
          autocorrect="off" autocapitalize="off" spellcheck="false"
          inputmode="text"
          readonly>
        <div class="suggest" id="sugName" style="display:none"></div>
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">æ€§åˆ¥ <span style="color:#ef4444;font-weight:700">â€»å¿…é ˆ</span></div>
        <select class="input" id="pGender">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="M">ç”·æ€§</option>
          <option value="F">å¥³æ€§</option>
        </select>
        <div class="hint" style="margin-top:4px">â€»å‚åŠ ç¢ºå®šå¾Œã«ã€Œç”·å¥³åˆ¥ãƒ»è‰²åˆ†ã‘è¡¨ç¤ºã€ã•ã‚Œã¾ã™</div>
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">å¹´é½¢</div>
        <input class="input" id="pAge" placeholder="ä¾‹ï¼‰32" inputmode="numeric">
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">é›»è©±/é€£çµ¡å…ˆ</div>
        <input class="input" id="pContact" type="text"
          placeholder="ä¾‹ï¼‰09012345678ï¼ˆå…ˆé ­0ã‚‚OKï¼‰"
          inputmode="numeric"
          autocomplete="new-password"
          autocorrect="off" autocapitalize="off" spellcheck="false"
          readonly>
        <div class="suggest" id="sugPhone" style="display:none"></div>
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">é€£çµ¡æ–¹æ³•</div>
        <select class="input" id="pContactWay">
          <option value="">æœªè¨­å®š</option>
          <option value="é›»è©±">é›»è©±</option>
          <option value="SMS">SMS</option>
          <option value="LINE">LINE</option>
          <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <div style="grid-column:1/-1">
        <div class="meta" style="margin:0 0 6px">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
        <input class="input" id="pMemo" placeholder="ä¾‹ï¼‰ç´¹ä»‹çµŒç”± / æ¬¡å›æ¡ˆå†…OK">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" id="btnSave" type="button">äºˆç´„ã¨ã—ã¦ç™»éŒ²</button>
      <button class="btn" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button>
      <span class="meta" id="status">-</span>
      <span class="err" id="err"></span>
    </div>

    <div class="hint" style="margin-top:10px">
      ãƒ»æ–°è¦ç™»éŒ²ã¯ã€Œäºˆç´„ä¸€è¦§ã€ã«å…¥ã‚Šã¾ã™ã€‚å‚åŠ ç¢ºå®šã¯äºˆç´„ä¸€è¦§ã§è¡Œã„ã¾ã™ã€‚<br>
      ãƒ»ç™»éŒ²ã¨åŒæ™‚ã«é¡§å®¢ãƒã‚¹ã‚¿ã¸ã‚‚è‡ªå‹•åæ˜ ï¼ˆGASå´ã®ä»•æ§˜ï¼‰ã‚’æƒ³å®šã€‚
    </div>
  </div>
</section>

<section class="card" style="margin-top:14px">
  <div class="hd">
    <strong>å‚åŠ ç¢ºå®šè€…ï¼ˆã“ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰</strong>
    <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆåå‰/é€£çµ¡å…ˆ/é€£çµ¡æ–¹æ³•ï¼‰" style="max-width:260px">
    <button class="btn" id="btnCsvConfirmed" type="button">â¬‡ï¸ ç¢ºå®šCSV</button>
    <span class="meta" id="count">-</span>
  </div>
  <div class="bd">
    <div class="split">
      <div class="box male">
        <div class="boxHd">
          <div class="ttl">ğŸ‘¨ ç”·æ€§ï¼ˆç¢ºå®šï¼‰</div>
          <div class="count" id="cntM">0å</div>
        </div>
        <div id="listM"></div>
      </div>

      <div class="box female">
        <div class="boxHd">
          <div class="ttl">ğŸ‘© å¥³æ€§ï¼ˆç¢ºå®šï¼‰</div>
          <div class="count" id="cntF">0å</div>
        </div>
        <div id="listF"></div>
      </div>
    </div>

    <div class="sumBar" id="sumConfirmed">
      <span class="sumPill"><strong>ç¢ºå®š</strong></span>
      <span class="sumPill">äººæ•° <strong id="sumC_cnt">0</strong></span>
      <span class="sumPill">å‰²å¼•åˆè¨ˆ <strong id="sumC_disc">0å††</strong></span>
      <span class="sumPill good">å£²ä¸Šåˆè¨ˆ <strong id="sumC_sales">0å††</strong></span>
      <span class="sumPill warn">æœªæ‰•ã„ <strong id="sumC_unpaid">0</strong></span>
    </div>

    <div class="noteSex" id="sexWarn" style="display:none"></div>
  </div>
</section>

</div>

<!-- äºˆç´„ä¸€è¦§ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ä¸‹å›ºå®šï¼‰ -->
<div class="bottomBar">
  <button class="btnLike" id="btnOpenRes" type="button">
    ğŸ“‹ äºˆç´„ä¸€è¦§ã‚’é–‹ãï¼ˆ<span id="cntR">0</span>ä»¶ï¼‰
  </button>
</div>

<!-- äºˆç´„ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBack" id="resBack">
  <div class="modal">
    <div class="modalHd">
      <div style="font-weight:900">äºˆç´„ä¸€è¦§ï¼ˆã“ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="meta" id="resMeta">-</span>
        <button class="btn" id="btnCloseRes" type="button">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <!-- â˜…ç”·å¥³ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚¿ãƒ– -->
    <div class="modalBd">
      <div class="tabRow">
        <button class="tabBtn on" id="tabAll" type="button">å…¨ã¦ <span class="tabCnt" id="tabCntAll">(0)</span></button>
        <button class="tabBtn" id="tabM" type="button">ğŸ‘¨ ç”·æ€§ <span class="tabCnt" id="tabCntM">(0)</span></button>
        <button class="tabBtn" id="tabF" type="button">ğŸ‘© å¥³æ€§ <span class="tabCnt" id="tabCntF">(0)</span></button>
        <button class="tabBtn" id="tabU" type="button">æœªè¨­å®š <span class="tabCnt" id="tabCntU">(0)</span></button>
      </div>
      <div class="resWrap" id="resBody"></div>
    </div>
  </div>
</div>

<!-- ã‚«ãƒƒãƒ—ãƒ«æˆç«‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBack heartModal" id="heartBack">
  <div class="modal">
    <div class="modalHd">
      <div style="font-weight:900">ã‚«ãƒƒãƒ—ãƒ«æˆç«‹ï¼ˆãƒãƒ¼ãƒˆè‰²ã‚’é¸æŠï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="meta" id="heartMeta">-</span>
        <button class="btn" id="btnCloseHeart" type="button">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd">
      <div class="heartGrid" id="heartGrid"></div>
      <div class="hint" style="margin-top:10px">
        â€»ã€Œãªã—ã€ã‚’é¸ã¶ã¨æˆç«‹ãƒãƒ¼ã‚¯ã‚’å¤–ã—ã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const $ = id => document.getElementById(id);

let events = [];
let participantsRaw = [];
let participants = [];
let customers = [];
let loadSeq = 0;

// ===== â˜…é«˜é€ŸåŒ–ï¼šã‚¤ãƒ™ãƒ³ãƒˆåˆ¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå³è¡¨ç¤ºâ†’è£ã§æ›´æ–°ï¼‰ =====
const PART_CACHE_KEY = "participants_cache_v1";
const participantsCache = new Map();

// localStorage ã‹ã‚‰å¾©å…ƒ
(function loadCache(){
  try{
    const obj = JSON.parse(localStorage.getItem(PART_CACHE_KEY) || "{}");
    for(const [eventId, payload] of Object.entries(obj)){
      participantsCache.set(eventId, payload);
    }
  }catch(_){}
})();

function saveCache(){
  try{
    const obj = Object.fromEntries(participantsCache.entries());
    localStorage.setItem(PART_CACHE_KEY, JSON.stringify(obj));
  }catch(_){}
}

function setCache(eventId, raw){
  const normalized = normalizeParticipants(raw || []);
  participantsCache.set(String(eventId), {
    ts: Date.now(),
    raw: raw || [],
    normalized
  });
  saveCache();
}
function getCache(eventId){
  return participantsCache.get(String(eventId)) || null;
}

// ===== â˜…å³æ™‚åæ˜ ï¼ˆæ¥½è¦³çš„UIï¼‰ï¼‹äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ =====
const inflight = new Set();

function optimisticUpdate(pid, patch){
  const i = participants.findIndex(x => x.pid === pid);
  if(i < 0) return null;
  const prev = { ...participants[i] };
  participants[i] = { ...participants[i], ...patch };
  return prev;
}
function optimisticRevert(pid, prev){
  if(!prev) return;
  const i = participants.findIndex(x => x.pid === pid);
  if(i < 0) return;
  participants[i] = prev;
}

function lockAction(pid){
  inflight.add(pid);
  // è¡¨ç¤ºçš„ã«ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«ï¼ˆãƒœã‚¿ãƒ³é€£æ‰“ã‚’æŠ‘æ­¢ï¼‰
  document.querySelectorAll(`[data-confirm="${CSS.escape(pid)}"]`).forEach(b=>{
    b.disabled = true;
    b.style.opacity = "0.6";
    b.textContent = "åæ˜ ä¸­â€¦";
  });
}
function unlockAction(pid){
  inflight.delete(pid);
  document.querySelectorAll(`[data-confirm="${CSS.escape(pid)}"]`).forEach(b=>{
    b.disabled = false;
    b.style.opacity = "";
    b.textContent = "å‚åŠ ç¢ºå®š";
  });
}

/* ===== ã‚«ãƒƒãƒ—ãƒ«æˆç«‹ï¼ˆãƒãƒ¼ãƒˆï¼‰ ===== */
const HEARTS = [
  { key:"",        label:"ãªã—", emoji:"" },
  { key:"red",     label:"èµ¤",   emoji:"â¤ï¸" },
  { key:"pink",    label:"ãƒ”ãƒ³ã‚¯",emoji:"ğŸ’—" },
  { key:"purple",  label:"ç´«",   emoji:"ğŸ’œ" },
  { key:"blue",    label:"é’",   emoji:"ğŸ’™" },
  { key:"green",   label:"ç·‘",   emoji:"ğŸ’š" },
  { key:"yellow",  label:"é»„",   emoji:"ğŸ’›" },
];
function heartEmoji(color){
  const hit = HEARTS.find(x=>x.key===String(color||""));
  return hit ? hit.emoji : "";
}
let heartTargetPid = "";
function openHeartModal(pid){
  const p = participants.find(x=>x.pid===pid);
  if(!p) return;
  heartTargetPid = pid;
  $("heartMeta").textContent = `${p.name||"-"}ï¼ˆ${p.contact||"-"}ï¼‰`;
  $("heartBack").style.display="flex";
  renderHeartGrid(p.coupleColor || "");
}
function closeHeartModal(){
  $("heartBack").style.display="none";
  heartTargetPid = "";
}
$("btnCloseHeart").onclick = closeHeartModal;
$("heartBack").addEventListener("click",(e)=>{
  if(e.target === $("heartBack")) closeHeartModal();
});
function renderHeartGrid(currentColor){
  $("heartGrid").innerHTML = HEARTS.map(h=>{
    const active = (String(h.key) === String(currentColor||""));
    return `
      <button class="heartBtn" type="button" data-heart="${h.key}">
        <span style="font-size:18px">${h.emoji}</span>
        <div style="text-align:left">
          <div>${h.label}</div>
          <small>${active ? "é¸æŠä¸­" : " "}</small>
        </div>
      </button>
    `;
  }).join("");
}
$("heartGrid").addEventListener("click", async (e)=>{
  const b = e.target.closest("button[data-heart]");
  if(!b) return;
  const color = b.dataset.heart || "";
  if(!heartTargetPid) return;
  await setCoupleColor(heartTargetPid, color);
});

/* ===== statusè¡¨ç¤º ===== */
function setStatus(msg){ $("status").textContent = msg || "-"; }
function setError(msg){ $("err").textContent = msg || ""; }
function setEvStatus(msg){ $("evStatus").textContent = msg || "-"; }

async function fetchJson(url, opt){
  const res = await fetch(url, Object.assign({cache:"no-store"}, opt||{}));
  const j = await res.json().catch(()=> ({}));
  if(j && j.ok === false && j.error) throw new Error(j.error);
  return j;
}

/* ===== æ–°è¦ç™»éŒ² æŠ˜ã‚ŠãŸãŸã¿ ===== */
const NEW_FOLD_KEY = "participants_newFold_v1";
function setNewFold(isOpen){
  const body = $("newBody");
  const btn = $("btnToggleNew");
  const chev = $("newChev");
  const label = $("newFoldLabel");

  if(isOpen){
    body.classList.remove("isHidden");
    btn.setAttribute("aria-expanded","true");
    chev.textContent = "â–²";
    label.textContent = "é–‰ã˜ã‚‹";
    localStorage.setItem(NEW_FOLD_KEY, "open");
  }else{
    body.classList.add("isHidden");
    btn.setAttribute("aria-expanded","false");
    chev.textContent = "â–¼";
    label.textContent = "é–‹ã";
    localStorage.setItem(NEW_FOLD_KEY, "closed");
  }
}
function initNewFold(){
  const saved = localStorage.getItem(NEW_FOLD_KEY);
  const open = (saved !== "closed");
  setNewFold(open);
}
$("btnToggleNew").onclick = ()=>{
  const isOpen = $("btnToggleNew").getAttribute("aria-expanded") === "true";
  setNewFold(!isOpen);
};

/* ===== normalize ===== */
function zenkakuToHankakuNum(s){
  return String(s??"").replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
}
function normalizeName(s){ return String(s??"").trim().replace(/\s+/g," ").toLowerCase(); }
function normalizePhoneLike(s){ return zenkakuToHankakuNum(String(s??"")).replace(/[^\d]/g,""); }
function normalizeGender(v){
  const s = String(v??"").trim().toUpperCase();
  if(s==="M" || s==="MALE" || s==="ç”·" || s==="ç”·æ€§") return "M";
  if(s==="F" || s==="FEMALE" || s==="å¥³" || s==="å¥³æ€§") return "F";
  return "";
}
function normalizeStatus(v){
  const s = String(v??"").trim().toLowerCase();
  if(s==="confirmed" || s==="ok" || s==="å‚åŠ " || s==="ç¢ºå®š") return "confirmed";
  if(s==="reserved" || s==="reserve" || s==="äºˆç´„") return "reserved";
  return "reserved";
}
function nowIso(){ return new Date().toISOString(); }
function makePid(){
  if(window.crypto?.randomUUID) return crypto.randomUUID();
  return "pid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
}

/* ===== æ–™é‡‘è¨ˆç®— ===== */
function getSelectedEvent(){
  const id = $("eventSel").value;
  return events.find(e => String(e.id) === String(id));
}
function safeInt(v){
  const n = Number(String(v ?? "").replace(/[^\d]/g,""));
  return Number.isFinite(n) ? n : 0;
}
function fmtYen(n){
  const x = Number(n||0);
  return x.toLocaleString("ja-JP") + "å††";
}
function getBasePriceFromEvent(gender){
  const ev = getSelectedEvent() || {};
  const m = ev.priceM ?? ev.malePrice ?? ev.mPrice ?? ev.m_fee ?? ev["ç”·æ€§æ–™é‡‘"] ?? ev["ç”·æ€§å‚åŠ è²»"];
  const f = ev.priceF ?? ev.femalePrice ?? ev.fPrice ?? ev.f_fee ?? ev["å¥³æ€§æ–™é‡‘"] ?? ev["å¥³æ€§å‚åŠ è²»"];
  const uni = ev.price ?? ev.fee ?? ev.basePrice ?? ev["åŸºæœ¬æ–™é‡‘"] ?? ev["å‚åŠ è²»"];
  const raw = (gender==="M" && m!=null) ? m : (gender==="F" && f!=null) ? f : uni;
  const n = safeInt(raw);
  return Number.isFinite(n) ? n : 0;
}
function displayPhone(v){
  const d = normalizePhoneLike(v);
  if(!d) return "";
  if(d.length === 9 || d.length === 10){
    return d.startsWith("0") ? d : ("0" + d);
  }
  return d.startsWith("0") ? d : d;
}
function normalizeContactWay(v){
  const s = String(v??"").trim();
  if(!s) return "";
  const u = s.toLowerCase();
  if(u.includes("line")) return "LINE";
  if(u.includes("sms")) return "SMS";
  if(u.includes("mail") || u.includes("ãƒ¡ãƒ¼ãƒ«") || u.includes("email")) return "ãƒ¡ãƒ¼ãƒ«";
  if(u.includes("insta")) return "Instagram";
  if(u.includes("face")) return "Facebook";
  if(u.includes("é›»è©±") || u.includes("tel") || u.includes("phone")) return "é›»è©±";
  return s;
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function showAutoBadge(on){
  $("autoBadge").style.display = on ? "inline-flex" : "none";
  $("autoBadge").className = on ? "badge ok" : "badge";
}

/* ===== API ===== */
async function apiEvents(){ const j = await fetchJson(API_URL + "?action=list"); return j.events || []; }
async function apiCustomers(){ const j = await fetchJson(API_URL + "?action=customers:list&nocache=1"); return j.customers || []; }
async function apiParticipantsList(eventId){
  const j = await fetchJson(
    API_URL + "?action=participants:list&eventId=" + encodeURIComponent(eventId)
    + "&nocache=1&t=" + Date.now() // â˜…è¿½åŠ ï¼šãƒ–ãƒ©ã‚¦ã‚¶/ä¸­é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
  );
  return j.participants || [];
}
async function apiParticipantsUpsert(p){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:upsert", participant:p })
  });
}
async function apiParticipantsDelete(pid){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:delete", pid })
  });
}
async function apiParticipantsRevert(pid){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:revert", pid })
  });
}

/* ===== UIï¼šã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ ===== */
function fmtDateJa(v){
  if(!v) return "-";
  const d = new Date(v);
  if(Number.isNaN(d.getTime())) return String(v);
  return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
}
function buildEventSelect(){
  const sel = $("eventSel");
  if(!events.length){
    sel.innerHTML = `<option value="">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>`;
    return;
  }
  const sorted = [...events].sort((a,b)=>String(b.date||"").localeCompare(String(a.date||"")));
  sel.innerHTML = sorted.map(e=>{
    const label = `${fmtDateJa(e.date)}ï½œ${e.title||e.name||"(ç„¡é¡Œ)"}ï½œ${e.place||"-"}`;
    return `<option value="${escapeHtml(e.id)}">${escapeHtml(label)}</option>`;
  }).join("");
}

/* ===== é¡§å®¢ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ï¼‹ã‚µã‚¸ã‚§ã‚¹ãƒˆ ===== */
let autoTimer = null;
function scheduleAutoFill(){
  clearTimeout(autoTimer);
  autoTimer = setTimeout(tryAutoFillFromCustomers, 200);
}
function tryAutoFillFromCustomers(){
  showAutoBadge(false);

  const nameIn = normalizeName($("pName").value);
  const phoneIn = normalizePhoneLike($("pContact").value);
  if(!nameIn && !phoneIn) return;

  let hit = null;
  if(phoneIn) hit = customers.find(c => normalizePhoneLike(c.contact) === phoneIn);
  if(!hit && nameIn) hit = customers.find(c => normalizeName(c.name) === nameIn);
  if(!hit) return;

  if(!$("pAge").value.trim() && hit.age) $("pAge").value = hit.age;
  if(!$("pContact").value.trim() && hit.contact) $("pContact").value = displayPhone(hit.contact);

  const cw = hit.contactWay ?? hit.contact_method ?? hit.contactMethod ?? hit.method ?? hit["é€£çµ¡æ–¹æ³•"] ?? hit["é€£çµ¡æ‰‹æ®µ"] ?? "";
  if(!$("pContactWay").value && cw) $("pContactWay").value = normalizeContactWay(cw);

  if(!$("pMemo").value.trim() && hit.memo) $("pMemo").value = hit.memo;

  const g = normalizeGender(hit.gender ?? hit.sex ?? "");
  if(!$("pGender").value && g) $("pGender").value = g;

  showAutoBadge(true);
}
function hideSuggest(){
  $("sugName").style.display="none";
  $("sugPhone").style.display="none";
  $("sugName").innerHTML="";
  $("sugPhone").innerHTML="";
}
function applyCustomer(hit){
  if(!hit) return;
  if(hit.name) $("pName").value = hit.name;
  const g = normalizeGender(hit.gender ?? hit.sex ?? "");
  if(g) $("pGender").value = g;
  if(hit.age) $("pAge").value = hit.age;
  if(hit.contact) $("pContact").value = displayPhone(hit.contact);
  const cw = hit.contactWay ?? hit.contact_method ?? hit.contactMethod ?? hit.method ?? hit["é€£çµ¡æ–¹æ³•"] ?? hit["é€£çµ¡æ‰‹æ®µ"] ?? "";
  if(cw) $("pContactWay").value = normalizeContactWay(cw);
  if(hit.memo) $("pMemo").value = hit.memo;
  showAutoBadge(true);
  hideSuggest();
}
function buildSuggestItems(list, type){
  const top = list.slice(0, 8);
  const html = `
    <div class="panel">
      ${top.map(c=>{
        const name = c.name || "-";
        const phone = displayPhone(c.contact || "");
        const age = c.age ? `å¹´é½¢:${c.age}` : "";
        const way = normalizeContactWay(c.contactWay ?? c.contact_method ?? c.contactMethod ?? c.method ?? c["é€£çµ¡æ–¹æ³•"] ?? "");
        const leftSub = [age, way].filter(Boolean).join(" / ");
        return `
          <div class="item" data-hit='${escapeHtml(JSON.stringify(c))}'>
            <div>
              <div class="main">${escapeHtml(type==="name" ? name : phone)}</div>
              <div class="sub">${escapeHtml(type==="name" ? (phone || "") : (name || ""))}${leftSub ? " / "+escapeHtml(leftSub) : ""}</div>
            </div>
            <span class="tag">é¸æŠ</span>
          </div>
        `;
      }).join("")}
    </div>
  `;
  return html;
}
function renderSuggest(){
  const nameIn = normalizeName($("pName").value);
  const phoneIn = normalizePhoneLike($("pContact").value);

  if(nameIn && nameIn.length >= 2){
    const hits = customers.filter(c => normalizeName(c.name).includes(nameIn));
    if(hits.length){
      $("sugName").style.display="block";
      $("sugName").innerHTML = buildSuggestItems(hits, "name");
    }else{
      $("sugName").style.display="none";
      $("sugName").innerHTML = "";
    }
  }else{
    $("sugName").style.display="none";
    $("sugName").innerHTML = "";
  }

  if(phoneIn && phoneIn.length >= 3){
    const hits = customers.filter(c => normalizePhoneLike(c.contact).includes(phoneIn));
    if(hits.length){
      $("sugPhone").style.display="block";
      $("sugPhone").innerHTML = buildSuggestItems(hits, "phone");
    }else{
      $("sugPhone").style.display="none";
      $("sugPhone").innerHTML = "";
    }
  }else{
    $("sugPhone").style.display="none";
    $("sugPhone").innerHTML = "";
  }
}
$("sugName").addEventListener("click",(e)=>{
  const item = e.target.closest(".item");
  if(!item) return;
  applyCustomer(JSON.parse(item.dataset.hit));
});
$("sugPhone").addEventListener("click",(e)=>{
  const item = e.target.closest(".item");
  if(!item) return;
  applyCustomer(JSON.parse(item.dataset.hit));
});
document.addEventListener("click",(e)=>{
  const inSug = e.target.closest("#sugName") || e.target.closest("#sugPhone");
  const inInputs = e.target.closest("#pName") || e.target.closest("#pContact");
  if(!inSug && !inInputs) hideSuggest();
});

/* ===== å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ï¼šé‡è¤‡æ’é™¤ ===== */
function normalizeParticipants(raw){
  const list = raw.map(p=>{
    const pid = String(p.pid ?? p.participantId ?? p.id ?? "").trim();
    const paidRaw = (p.paid ?? p.isPaid ?? p.payment ?? p["æ”¯æ‰•ã„"] ?? "");
    const paidStr = String(paidRaw ?? "").trim().toLowerCase();
    const paid = paidStr==="true" || paidStr==="1" || paidStr==="æ¸ˆ" || paidStr==="paid";
    return {
      ...p,
      pid,
      gender: normalizeGender(p.gender),
      status: normalizeStatus(p.status),
      contact: displayPhone(p.contact),
      contactWay: normalizeContactWay(p.contactWay ?? p.contact_method ?? p.contactMethod ?? p.method ?? p["é€£çµ¡æ–¹æ³•"] ?? p["é€£çµ¡æ‰‹æ®µ"] ?? ""),
      coupleColor: String(p.coupleColor ?? p.couple ?? p.heartColor ?? p.heart ?? "").trim(),
      discountYen: safeInt(p.discountYen ?? p.discount ?? p.discount_yen ?? p.discountAmount ?? p["å‰²å¼•"] ?? p["å‰²å¼•ï¼ˆå††ï¼‰"] ?? 0),
      paid,
      updatedAt: p.updatedAt || p.ts || p.timestamp || "",
      createdAt: p.createdAt || ""
    };
  });

  const withPid = list.filter(x=>x.pid);
  const noPid = list.filter(x=>!x.pid);

  const map = {};
  for(const x of withPid){
    const key = x.pid;
    const a = map[key];
    if(!a){ map[key]=x; continue; }
    const ta = Date.parse(a.updatedAt||"") || 0;
    const tb = Date.parse(x.updatedAt||"") || 0;
    map[key] = (tb >= ta) ? x : a;
  }
  return [...Object.values(map), ...noPid];
}

/* ===== ã‚«ãƒƒãƒ—ãƒ«æˆç«‹è‰²ã®ä¿å­˜ ===== */
async function setCoupleColor(pid, color){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  const p = participants.find(x=>x.pid===pid);
  if(!p) return;

  setError("");
  try{
    setStatus("æˆç«‹ãƒãƒ¼ã‚¯ä¿å­˜ä¸­â€¦");
    await apiParticipantsUpsert({
      eventId,
      pid: p.pid,
      name: p.name || "",
      gender: normalizeGender(p.gender),
      age: p.age || "",
      contact: displayPhone(p.contact || ""),
      contactWay: normalizeContactWay(p.contactWay || ""),
      memo: p.memo || "",
      status: normalizeStatus(p.status),
      coupleColor: color || "",
      discountYen: safeInt(p.discountYen || 0),
      paid: !!p.paid,
      updatedAt: nowIso()
    });

    await reloadParticipants(eventId);
    setStatus("æˆç«‹ãƒãƒ¼ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    
    closeHeartModal();
  }catch(err){
    setStatus("-");
    setError("æˆç«‹ãƒãƒ¼ã‚¯ã®ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

/* =========================================================
   â‘ å‰²å¼•æ¬„ï¼šã‚«ãƒ¼ã‚½ãƒ«ãŒå¤–ã‚Œã‚‹å¯¾ç­–
   - å…¥åŠ›ä¸­ã¯ DOMå†æç”»ã§ value ã‚’ä¸Šæ›¸ãã—ãªã„ï¼ˆdraftã‚’ä¿æŒï¼‰
   - ä¿å­˜ã¯ input(debounce)+Enter+blur
   - ä¿å­˜å¾Œã«å†æç”»ã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
========================================================= */
const discountDraft = new Map();  // pid -> string
let savingDiscountPid = "";
let restoreFocusPid = "";

function getDraftDiscountValue(pid, fallback){
  if(!pid) return fallback;
  if(discountDraft.has(pid)) return discountDraft.get(pid);
  return String(fallback ?? 0);
}
function setDraft(pid, v){
  if(!pid) return;
  discountDraft.set(pid, String(v ?? ""));
}
function clearDraft(pid){
  if(!pid) return;
  discountDraft.delete(pid);
}

const debounceTimers = new Map();
function debounceByKey(key, fn, ms){
  if(debounceTimers.has(key)) clearTimeout(debounceTimers.get(key));
  debounceTimers.set(key, setTimeout(()=>{ debounceTimers.delete(key); fn(); }, ms));
}

function focusDiscount(pid){
  if(!pid) return;
  const el = document.querySelector(`input[data-discount="${CSS.escape(pid)}"]`);
  if(el){
    el.focus({preventScroll:true});
    try{ el.setSelectionRange(el.value.length, el.value.length); }catch(_){}
  }
}

/* å‰²å¼•ä¿å­˜ï¼ˆå¤‰æ›´ï¼šä¿å­˜ç›´å‰ã« pid ã‚’è¨˜éŒ²â†’reloadå¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°ï¼‰ */
async function setDiscountYen(pid, discountYen){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  const p = participants.find(x=>x.pid===pid);
  if(!p) return;

  const d = Math.max(0, safeInt(discountYen));
  savingDiscountPid = pid;
  restoreFocusPid = pid;

  setError("");
  try{
    setStatus("å‰²å¼•ã‚’ä¿å­˜ä¸­â€¦");
    await apiParticipantsUpsert({
      eventId,
      pid: p.pid,
      name: p.name || "",
      gender: normalizeGender(p.gender),
      age: p.age || "",
      contact: displayPhone(p.contact || ""),
      contactWay: normalizeContactWay(p.contactWay || ""),
      memo: p.memo || "",
      status: normalizeStatus(p.status),
      coupleColor: p.coupleColor || "",
      discountYen: d,
      paid: !!p.paid,
      updatedAt: nowIso()
    });

    clearDraft(pid);
    await reloadParticipants(eventId);

    setStatus("å‰²å¼•ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();

    // â˜…ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°ï¼ˆå…¥åŠ›ä¸­ã«ã‚«ãƒ¼ã‚½ãƒ«ãŒå¤–ã‚Œã‚‹å¯¾ç­–ï¼‰
    if(restoreFocusPid){
      focusDiscount(restoreFocusPid);
      restoreFocusPid = "";
    }

  }catch(err){
    setStatus("-");
    setError("å‰²å¼•ã®ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err));
  }finally{
    savingDiscountPid = "";
  }
}

/* ===== æ”¯æ‰•ã„ãƒˆã‚°ãƒ« ===== */
async function togglePaid(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  const p = participants.find(x=>x.pid===pid);
  if(!p) return;

  const next = !Boolean(p.paid);

  setError("");
  try{
    setStatus("æ”¯æ‰•ã„çŠ¶æ…‹ã‚’ä¿å­˜ä¸­â€¦");
    await apiParticipantsUpsert({
      eventId,
      pid: p.pid,
      name: p.name || "",
      gender: normalizeGender(p.gender),
      age: p.age || "",
      contact: displayPhone(p.contact || ""),
      contactWay: normalizeContactWay(p.contactWay || ""),
      memo: p.memo || "",
      status: normalizeStatus(p.status),
      coupleColor: p.coupleColor || "",
      discountYen: safeInt(p.discountYen || 0),
      paid: next,
      updatedAt: nowIso()
    });

    await reloadParticipants(eventId);
    setStatus("æ”¯æ‰•ã„çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();
  }catch(err){
    setStatus("-");
    setError("æ”¯æ‰•ã„ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

/* ===== å‚åŠ è€…ï¼ˆç¢ºå®šï¼‰æç”» ===== */
function renderConfirmed(){
  const q = $("q").value.trim().toLowerCase();

  const confirmed = participants.filter(p => normalizeStatus(p.status) === "confirmed");
  const filtered = q
    ? confirmed.filter(p=>{
        const s = `${p.name||""} ${p.contact||""} ${p.contactWay||""}`.toLowerCase();
        return s.includes(q);
      })
    : confirmed;

  $("count").textContent = `${filtered.length}ä»¶`;

  const men = filtered.filter(p => normalizeGender(p.gender) === "M");
  const women = filtered.filter(p => normalizeGender(p.gender) === "F");
  const unknown = filtered.filter(p => !normalizeGender(p.gender));

  $("cntM").textContent = `${men.length}å`;
  $("cntF").textContent = `${women.length}å`;

  const mk = (p, sex)=>{
    const heart = heartEmoji(p.coupleColor);
    const base = getBasePriceFromEvent(normalizeGender(p.gender));
    const disc = safeInt(p.discountYen);
    const fee  = Math.max(0, base - disc);

    const payBadge = p.paid
      ? `<span class="payBadge paid">âœ…æ”¯æ‰•æ¸ˆ</span>`
      : `<span class="payBadge unpaid">ğŸ’°æœªæ‰•ã„</span>`;

    const discVal = getDraftDiscountValue(p.pid, safeInt(p.discountYen)||0);

    return `
      <div class="pCard ${sex}">
        <div>
          <div class="pName">
            <span>${escapeHtml(p.name||"-")}</span>
            ${heart ? `<span title="ã‚«ãƒƒãƒ—ãƒ«æˆç«‹">${heart}</span>` : ``}
            ${payBadge}
          </div>
          <div class="pMeta">
            å¹´é½¢:${escapeHtml(p.age||"-")}
            ï½œé€£çµ¡å…ˆ:${escapeHtml(p.contact||"-")}
            ï½œé€£çµ¡æ–¹æ³•:${escapeHtml(p.contactWay||"-")}
          </div>
          <div class="priceRow">
            <span class="pill">åŸºæœ¬ <strong>${fmtYen(base)}</strong></span>
            <span class="pill">å‰²å¼• <strong>-${fmtYen(disc)}</strong></span>
            <span class="pill">å‚åŠ è²» <strong>${fmtYen(fee)}</strong></span>
          </div>
        </div>
        <div class="pActions">
          ${p.pid ? `<input class="smallInput" inputmode="numeric" placeholder="å‰²å¼•(å††)" value="${escapeHtml(String(discVal))}" data-discount="${escapeHtml(p.pid)}">` : ``}
          ${p.pid ? `<button class="btn" data-paid-toggle="${escapeHtml(p.pid)}" type="button">${p.paid ? 'âœ…æ”¯æ‰•æ¸ˆ' : 'ğŸ’°æœªæ‰•ã„'}</button>` : ``}
          ${p.pid ? `<button class="btn" data-heart-open="${escapeHtml(p.pid)}" type="button">ğŸ’–æˆç«‹</button>` : ``}
          ${p.pid ? `<button class="btn danger" data-del-confirm="${escapeHtml(p.pid)}" type="button">äºˆç´„ã«æˆ»ã™</button>` : ``}
        </div>
      </div>
    `;
  };

  $("listM").innerHTML = men.length ? men.map(p=>mk(p,"male")).join("") : `<div class="meta">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>`;
  $("listF").innerHTML = women.length ? women.map(p=>mk(p,"female")).join("") : `<div class="meta">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>`;

  const sexWarn = $("sexWarn");
  if(unknown.length){
    sexWarn.style.display = "block";
    sexWarn.textContent = `âš  æ€§åˆ¥ãŒæœªè¨­å®šã®ç¢ºå®šè€…ãŒ ${unknown.length}åã„ã¾ã™ï¼ˆäºˆç´„ä¸€è¦§ã§æ€§åˆ¥ã‚’ç›´ã—ã¦ã‹ã‚‰ç¢ºå®šã—ã¦ãã ã•ã„ï¼‰`;
  }else{
    sexWarn.style.display = "none";
    sexWarn.textContent = "";
  }

  const discSum = (arr)=>arr.reduce((a,x)=>a+safeInt(x.discountYen),0);
  const feeSum  = (arr)=>arr.reduce((a,x)=>{
    const b = getBasePriceFromEvent(normalizeGender(x.gender));
    const d = safeInt(x.discountYen);
    return a + Math.max(0, b-d);
  },0);
  const unpaidCount = filtered.filter(x=>!x.paid).length;

  $("sumC_cnt").textContent   = String(filtered.length);
  $("sumC_disc").textContent  = fmtYen(discSum(filtered));
  $("sumC_sales").textContent = fmtYen(feeSum(filtered));
  $("sumC_unpaid").textContent= String(unpaidCount);
}

/* ===== äºˆç´„ä¸€è¦§ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ===== */
function countReserved(){
  return participants.filter(p => normalizeStatus(p.status) === "reserved").length;
}
function openResModal(){
  $("resBack").style.display = "flex";
  renderReservations();
}
function closeResModal(){
  $("resBack").style.display = "none";
}
$("btnOpenRes").onclick = openResModal;
$("btnCloseRes").onclick = closeResModal;
$("resBack").addEventListener("click", (e)=>{
  if(e.target === $("resBack")) closeResModal();
});

/* ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼šãƒœã‚¿ãƒ³ */
$("resBody").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.confirm) confirmParticipant(btn.dataset.confirm);
  if(btn.dataset.del) deleteReserved(btn.dataset.del);
  if(btn.dataset.heartOpen) openHeartModal(btn.dataset.heartOpen);
  if(btn.dataset.paidToggle) togglePaid(btn.dataset.paidToggle);
});
$("listM").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.delConfirm) revertConfirmedToReserved(btn.dataset.delConfirm);
  if(btn.dataset.heartOpen) openHeartModal(btn.dataset.heartOpen);
  if(btn.dataset.paidToggle) togglePaid(btn.dataset.paidToggle);
});
$("listF").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.delConfirm) revertConfirmedToReserved(btn.dataset.delConfirm);
  if(btn.dataset.heartOpen) openHeartModal(btn.dataset.heartOpen);
  if(btn.dataset.paidToggle) togglePaid(btn.dataset.paidToggle);
});

/* â˜…å‰²å¼• inputï¼šinput(debounce)+Enter+blur ã§ä¿å­˜ã€‚draftã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒ */
function bindDiscountInputDelegation(container){
  // å…¥åŠ›ä¸­ã¯ draft ã«ä¿æŒ
  container.addEventListener("input", (e)=>{
    const inp = e.target.closest("input[data-discount]");
    if(!inp) return;
    const pid = inp.dataset.discount;
    setDraft(pid, inp.value);

    debounceByKey("disc_"+pid, ()=>{
      // å…¥åŠ›ä¸­ã«ç¢ºå®šä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒã®ãŸã‚ã«ä»Šã®å€¤ã§ä¿å­˜ï¼‰
      setDiscountYen(pid, inp.value);
    }, 600);
  });

  // Enterã§å³ä¿å­˜
  container.addEventListener("keydown", (e)=>{
    const inp = e.target.closest("input[data-discount]");
    if(!inp) return;
    if(e.key === "Enter"){
      e.preventDefault();
      const pid = inp.dataset.discount;
      setDraft(pid, inp.value);
      setDiscountYen(pid, inp.value);
    }
  });

  // blurã§ã‚‚ä¿å­˜ï¼ˆæœ€å¾Œã®ä¿é™ºï¼‰
  container.addEventListener("blur", (e)=>{
    const inp = e.target.closest("input[data-discount]");
    if(!inp) return;
    const pid = inp.dataset.discount;
    setDraft(pid, inp.value);
    setDiscountYen(pid, inp.value);
  }, true);
}
bindDiscountInputDelegation($("resBody"));
bindDiscountInputDelegation($("listM"));
bindDiscountInputDelegation($("listF"));

/* ===== äºˆç´„â†’ç¢ºå®š ===== */
async function confirmParticipant(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;

  if(inflight.has(pid)) return; // äºŒé‡æŠ¼ã—é˜²æ­¢

  const p = participants.find(x => x.pid === pid);
  if(!p){
    alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆpidãŒæœªè¨­å®šã®å¯èƒ½æ€§ï¼‰");
    return;
  }

  setError("");
  lockAction(pid);

  // â˜…(A) ã¾ãšç”»é¢ã ã‘å³åæ˜ ï¼ˆä¿å­˜å‰ã§ã‚‚UIã¯ç¢ºå®šã«ç§»å‹•ï¼‰
  const prev = optimisticUpdate(pid, {
    status: "confirmed",
    updatedAt: nowIso()
  });
  renderConfirmed();
  renderReservations();
  setStatus("å‚åŠ ç¢ºå®šï¼ˆç”»é¢åæ˜ ï¼‰â†’ ä¿å­˜ä¸­â€¦");

  try{
    // â˜…(B) è£ã§ä¿å­˜
    await apiParticipantsUpsert({
      eventId,
      pid: p.pid,
      name: p.name || "",
      gender: normalizeGender(p.gender),
      age: p.age || "",
      contact: displayPhone(p.contact || ""),
      contactWay: normalizeContactWay(p.contactWay || ""),
      memo: p.memo || "",
      status: "confirmed",
      coupleColor: p.coupleColor || "",
      discountYen: safeInt(p.discountYen || 0),
      paid: !!p.paid,
      updatedAt: nowIso()
    });

    // â˜…(C) æœ€å¾Œã«å†èª­è¾¼ã§æ•´åˆï¼ˆã“ã“ãŒé…ãã¦ã‚‚UIã¯æ—¢ã«å‹•ã„ã¦ã‚‹ï¼‰
    await reloadParticipants(eventId);
    renderConfirmed();
    renderReservations();

    setStatus("å‚åŠ ç¢ºå®šã—ã¾ã—ãŸ");
  }catch(err){
    // å¤±æ•—ã—ãŸã‚‰å…ƒã«æˆ»ã™
    optimisticRevert(pid, prev);
    renderConfirmed();
    renderReservations();

    setStatus("-");
    setError("å‚åŠ ç¢ºå®šã«å¤±æ•—ï¼š " + (err.message || err));
  }finally{
    unlockAction(pid);
  }
}

/* ===== äºˆç´„å‰Šé™¤ ===== */
async function deleteReserved(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  if(!pid) return alert("pidãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ï¼‰");
  if(!confirm("ã“ã®äºˆç´„ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  setError("");
  try{
    setStatus("å‰Šé™¤ä¸­â€¦");
    await apiParticipantsDelete(pid);
    await reloadParticipants(eventId);
    setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();
  }catch(err){
    setStatus("-");
    setError("å‰Šé™¤ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

/* ===== ç¢ºå®šâ†’äºˆç´„ã«æˆ»ã™ ===== */
async function revertConfirmedToReserved(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  if(!pid) return alert("pidãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ï¼‰");
  if(!confirm("ã“ã®å‚åŠ ç¢ºå®šè€…ã‚’ã€Œäºˆç´„ä¸€è¦§ã€ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

  setError("");
  try{
    setStatus("äºˆç´„ã«æˆ»ã—ã¦ã„ã¾ã™â€¦");
    await apiParticipantsRevert(pid);
    await reloadParticipants(eventId);
    setStatus("äºˆç´„ä¸€è¦§ã«æˆ»ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();
  }catch(err){
    setStatus("-");
    setError("æˆ»ã™å‡¦ç†ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

/* ===== â‘¡äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç”·å¥³ã‚¿ãƒ–è¡¨ç¤º ===== */
let resTab = "all"; // all / M / F / U
function setResTab(next){
  resTab = next;
  const map = {all:"tabAll", M:"tabM", F:"tabF", U:"tabU"};
  ["tabAll","tabM","tabF","tabU"].forEach(id=>$(id).classList.remove("on"));
  $(map[next]).classList.add("on");
  renderReservations();
}
$("tabAll").onclick = ()=>setResTab("all");
$("tabM").onclick   = ()=>setResTab("M");
$("tabF").onclick   = ()=>setResTab("F");
$("tabU").onclick   = ()=>setResTab("U");

function buildResCard(p){
  const g = normalizeGender(p.gender);
  const heart = heartEmoji(p.coupleColor);

  const base = getBasePriceFromEvent(g);
  const disc = safeInt(p.discountYen);
  const fee  = Math.max(0, base - disc);

  const gLabel = g==="M" ? "ç”·æ€§" : g==="F" ? "å¥³æ€§" : "æœªè¨­å®š";
  const payBadge = p.paid
    ? `<span class="payBadge paid">âœ…æ”¯æ‰•æ¸ˆ</span>`
    : `<span class="payBadge unpaid">ğŸ’°æœªæ‰•ã„</span>`;

  const meta = [
    `æ€§åˆ¥:${gLabel}`,
    `å¹´é½¢:${p.age||"-"}`,
    `é€£çµ¡å…ˆ:${displayPhone(p.contact)||"-"}`,
    `é€£çµ¡æ–¹æ³•:${p.contactWay||"-"}`,
    p.memo ? `ãƒ¡ãƒ¢:${p.memo}` : ""
  ].filter(Boolean).join(" ï½œ ");

  const discVal = getDraftDiscountValue(p.pid, safeInt(p.discountYen)||0);

  const discInput = p.pid
    ? `<input class="smallInput" inputmode="numeric" placeholder="å‰²å¼•(å††)" value="${escapeHtml(String(discVal))}" data-discount="${escapeHtml(p.pid)}">`
    : ``;
  const paidBtn = p.pid
    ? `<button class="btn" data-paid-toggle="${escapeHtml(p.pid)}" type="button">${p.paid ? 'âœ…æ”¯æ‰•æ¸ˆ' : 'ğŸ’°æœªæ‰•ã„'}</button>`
    : ``;
  const heartBtn = p.pid
    ? `<button class="btn" data-heart-open="${escapeHtml(p.pid)}" type="button">ğŸ’–æˆç«‹</button>`
    : ``;
  const confirmBtn = p.pid
    ? `<button class="btn primary" data-confirm="${escapeHtml(p.pid)}" type="button">å‚åŠ ç¢ºå®š</button>`
    : `<span class="meta">pidãªã—ï¼ˆå¤ã„äºˆç´„ï¼‰</span>`;
  const delBtn = p.pid
    ? `<button class="btn danger" data-del="${escapeHtml(p.pid)}" type="button">å‰Šé™¤</button>`
    : ``;

  return `
    <div class="rCard">
      <div>
        <div class="rTitle">
          <span>${escapeHtml(p.name||"-")}</span>
          ${heart ? `<span title="ã‚«ãƒƒãƒ—ãƒ«æˆç«‹">${heart}</span>` : ``}
          ${payBadge}
        </div>
        <div class="rMeta">
          ${escapeHtml(meta)}
          <div class="priceRow">
            <span class="pill">åŸºæœ¬ <strong>${fmtYen(base)}</strong></span>
            <span class="pill">å‰²å¼• <strong>-${fmtYen(disc)}</strong></span>
            <span class="pill">å‚åŠ è²» <strong>${fmtYen(fee)}</strong></span>
          </div>
        </div>
      </div>
      <div class="rActions">
        ${discInput}
        ${paidBtn}
        ${heartBtn}
        ${confirmBtn}
        ${delBtn}
      </div>
    </div>
  `;
}

function renderReservations(){
  const reservedAll = participants.filter(p => normalizeStatus(p.status) === "reserved");
  $("cntR").textContent = String(reservedAll.length);
  $("resMeta").textContent = reservedAll.length ? `${reservedAll.length}ä»¶ã®äºˆç´„` : "äºˆç´„ãªã—";

  const men = reservedAll.filter(p => normalizeGender(p.gender)==="M");
  const women = reservedAll.filter(p => normalizeGender(p.gender)==="F");
  const unknown = reservedAll.filter(p => !normalizeGender(p.gender));

  $("tabCntAll").textContent = `(${reservedAll.length})`;
  $("tabCntM").textContent   = `(${men.length})`;
  $("tabCntF").textContent   = `(${women.length})`;
  $("tabCntU").textContent   = `(${unknown.length})`;

  if(!reservedAll.length){
    $("resBody").innerHTML = `<div class="meta">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  let showList = reservedAll;
  let boxClass = "unknown";
  let title = "å…¨ã¦ï¼ˆäºˆç´„ï¼‰";

  if(resTab==="M"){ showList = men; boxClass = "male"; title = "ğŸ‘¨ ç”·æ€§ï¼ˆäºˆç´„ï¼‰"; }
  if(resTab==="F"){ showList = women; boxClass = "female"; title = "ğŸ‘© å¥³æ€§ï¼ˆäºˆç´„ï¼‰"; }
  if(resTab==="U"){ showList = unknown; boxClass = "unknown"; title = "æœªè¨­å®šï¼ˆäºˆç´„ï¼‰"; }

  $("resBody").innerHTML = `
    <div class="resBox ${boxClass}">
      <div class="boxHd">
        <div class="ttl">${title}</div>
        <div class="count">${showList.length}å</div>
      </div>
      <div>${showList.length ? showList.map(buildResCard).join("") : `<div class="meta">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>`}</div>
    </div>
  `;
}

/* ===== ãƒ•ã‚©ãƒ¼ãƒ  ===== */
function clearForm(){
  $("pName").value="";
  $("pGender").value="";
  $("pAge").value="";
  $("pContact").value="";
  $("pContactWay").value="";
  $("pMemo").value="";
  showAutoBadge(false);
}
$("btnClear").onclick = ()=>{ setError(""); clearForm(); };

$("btnSave").onclick = async ()=>{
  setError("");
  try{
    const eventId = $("eventSel").value;
    if(!eventId){ alert("ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    const name = $("pName").value.trim();
    if(!name){ alert("åå‰ã¯å¿…é ˆã§ã™"); return; }

    const gender = $("pGender").value;
    if(!gender){ alert("æ€§åˆ¥ï¼ˆç”·æ€§/å¥³æ€§ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    // å…¥åŠ›ã‚’ç¢ºå®šï¼ˆå…ˆã«ä½œã‚‹ï¼‰
    const pid = makePid();
    const p = {
      eventId,
      pid,
      name,
      gender,
      age: $("pAge").value.trim(),
      contact: displayPhone($("pContact").value.trim()),
      contactWay: normalizeContactWay($("pContactWay").value),
      memo: $("pMemo").value.trim(),
      status: "reserved",
      coupleColor: "",
      discountYen: 0,
      paid: false,
      createdAt: nowIso(),
      updatedAt: nowIso()
    };

    // â˜…(A) å…ˆã«UIã¸å³åæ˜ ï¼ˆã“ã“ãŒä½“æ„Ÿé€Ÿåº¦ã®è¦ï¼‰
    participants = [p, ...participants];       // å…ˆé ­ã«è¿½åŠ 
    participantsRaw = [p, ...participantsRaw]; // rawã‚‚åˆã‚ã›ã‚‹ï¼ˆç°¡æ˜“ã§OKï¼‰
    setCache(eventId, participantsRaw);        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°

    clearForm();
    renderConfirmed();
    renderReservations();
    setStatus("äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä¿å­˜ä¸­â€¦ï¼‰");

    // â˜…(B) è£ã§ä¿å­˜ï¼ˆå¾…ãŸãªã„ï¼‰
    apiParticipantsUpsert(p).then(async ()=>{
      setStatus("ä¿å­˜ã—ã¾ã—ãŸ");

      // â˜…(C) é‡ã„å†èª­è¾¼ã¯ã€Œã‚ã¨ã§ã€ã€Œå¿…è¦æ™‚ã ã‘ã€
      // ãƒ‡ãƒ¼ã‚¿æ•´åˆãŒå¿…è¦ãªã‚‰ã€æ•°ç§’å¾Œã«1å›ã ã‘åŒæœŸï¼ˆä»»æ„ï¼‰
      setTimeout(async ()=>{
        try{
          await reloadParticipants(eventId);
          setStatus("åŒæœŸã—ã¾ã—ãŸ");
        }catch(_){}
      }, 1200);

    }).catch(err=>{
      // å¤±æ•—ã—ãŸã‚‰ç”»é¢ã‹ã‚‰å–ã‚Šæ¶ˆã™
      participants = participants.filter(x=>x.pid !== pid);
      participantsRaw = participantsRaw.filter(x=>String(x.pid) !== String(pid));
      setCache(eventId, participantsRaw);
      renderConfirmed();
      renderReservations();
      setStatus("-");
      setError("ç™»éŒ²ã«å¤±æ•—ï¼š " + (err.message || err));
    });

  }catch(err){
    setStatus("-");
    setError("ç™»éŒ²ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};
$("q").oninput = renderConfirmed;

$("eventSel").addEventListener("change", async ()=>{
  setError("");
  try{
    const eventId = $("eventSel").value;

    participantsRaw = [];
    participants = [];
    $("count").textContent = "-";
    $("cntM").textContent = "0å";
    $("cntF").textContent = "0å";
    const cached = getCache(eventId);
if(!cached){
  $("listM").innerHTML = `<div class="meta">èª­è¾¼ä¸­â€¦</div>`;
  $("listF").innerHTML = `<div class="meta">èª­è¾¼ä¸­â€¦</div>`;
}
    $("cntR").textContent = "0";
    $("resBody").innerHTML = `<div class="meta">èª­è¾¼ä¸­â€¦</div>`;

    if(!eventId){
      renderConfirmed();
      renderReservations();
      return;
    }

    await reloadParticipants(eventId);
    renderConfirmed();
    renderReservations();

  }catch(err){
    setEvStatus("-");
    setError("å‚åŠ è€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err.message || err));
  }
});

$("pName").addEventListener("input", ()=>{ scheduleAutoFill(); renderSuggest(); });
$("pContact").addEventListener("input", ()=>{ scheduleAutoFill(); renderSuggest(); });

/* ===== CSVï¼ˆç¢ºå®šï¼‰ ===== */
function toCsv(rows){
  const esc = (v)=>('"'+String(v??"").replaceAll('"','""')+'"');
  return rows.map(r=>r.map(esc).join(",")).join("\n");
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}
$("btnCsvConfirmed").onclick = ()=>{
  const ev = getSelectedEvent() || {};
  const eventTitle = (ev.title||ev.name||"event").replace(/[\\\/:*?"<>|]/g,"_");
  const rows = participants
    .filter(p=>normalizeStatus(p.status)==="confirmed")
    .map(p=>{
      const g = normalizeGender(p.gender);
      const base = getBasePriceFromEvent(g);
      const disc = safeInt(p.discountYen);
      const fee  = Math.max(0, base-disc);
      return [
        p.name||"",
        g==="M"?"ç”·æ€§":g==="F"?"å¥³æ€§":"æœªè¨­å®š",
        p.age||"",
        p.contact||"",
        p.contactWay||"",
        disc,
        fee,
        p.paid ? "æ¸ˆ" : "æœª",
        p.memo||""
      ];
    });

  const header = [["åå‰","æ€§åˆ¥","å¹´é½¢","é€£çµ¡å…ˆ","é€£çµ¡æ–¹æ³•","å‰²å¼•(å††)","å‚åŠ è²»(å††)","æ”¯æ‰•ã„","ãƒ¡ãƒ¢"]];
  const csv = toCsv([...header, ...rows]);
  downloadText(`ç¢ºå®š_${eventTitle}.csv`, csv);
};

/* ===== èª­ã¿è¾¼ã¿ ===== */
async function reloadParticipants(eventId){
  const seq = ++loadSeq;
  setEvStatus("å‚åŠ è€…èª­è¾¼ä¸­â€¦");

  // â˜…(A) ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³è¡¨ç¤ºï¼ˆä½“æ„ŸãŒçˆ†é€Ÿï¼‰
  const cached = getCache(eventId);
  if(cached && Array.isArray(cached.raw)){
    participantsRaw = cached.raw;
    participants = cached.normalized || normalizeParticipants(cached.raw);
    $("cntR").textContent = String(countReserved());
    // ã“ã“ã§ä¸€æ—¦æç”»ï¼ˆåˆ‡æ›¿ãŒä¸€ç¬ã§çµ‚ã‚ã‚‹ï¼‰
    renderConfirmed();
    renderReservations();
    setEvStatus("OK");
  }

  // â˜…(B) è£ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾— â†’ å·®ã—æ›¿ãˆ
  try{
    const raw = await apiParticipantsList(eventId);
    if(seq !== loadSeq) return; // é€”ä¸­ã§ã‚¤ãƒ™ãƒ³ãƒˆåˆ‡æ›¿ã•ã‚ŒãŸã‚‰ç ´æ£„

    participantsRaw = raw;
    participants = normalizeParticipants(participantsRaw);
    setCache(eventId, raw);     // â˜…ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°

    $("cntR").textContent = String(countReserved());
    renderConfirmed();
    renderReservations();
    setEvStatus("OK");
  }catch(err){
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¡¨ç¤ºã§ãã¦ã‚Œã°è‡´å‘½çš„ã˜ã‚ƒãªã„
    if(!cached){
      setEvStatus("-");
      throw err;
    }else{
      setEvStatus("OK");
    }
  }
}

/* iOS autofillæŠ‘æ­¢ */
function hardDisableIOSAutofill(){
  const name = $("pName");
  const phone = $("pContact");
  if(!name || !phone) return;

  const rnd = "x_" + Math.random().toString(16).slice(2);
  name.setAttribute("name", "nm_" + rnd);
  phone.setAttribute("name", "ph_" + rnd);

  const unlock = (el)=> {
    el.addEventListener("focus", ()=>{
      el.removeAttribute("readonly");
    }, {once:true});
  };
  unlock(name);
  unlock(phone);
}

/* ===== èµ·å‹• ===== */
(async()=>{
  try{
    initNewFold();
    hardDisableIOSAutofill();

    setEvStatus("èª­è¾¼ä¸­â€¦");
    setStatus("èª­è¾¼ä¸­â€¦");
    setError("");

    // â‘  ã¾ãšã‚¤ãƒ™ãƒ³ãƒˆã ã‘å–å¾— â†’ å³è¡¨ç¤º
events = await apiEvents();
buildEventSelect();

// â‘¡ é¡§å®¢ãƒã‚¹ã‚¿ã¯è£ã§èª­ã¿è¾¼ã‚€ï¼ˆå¾…ãŸãªã„ï¼‰
apiCustomers().then(list=>{
  customers = list;
});

    const firstId = $("eventSel").value;
    if(firstId){
      await reloadParticipants(firstId);
    }else{
      participantsRaw = [];
      participants = [];
      $("cntR").textContent = "0";
    }

    $("loadedAt").textContent = "èª­ã¿è¾¼ã¿ï¼š" + new Date().toLocaleString("ja-JP");
    setEvStatus("OK");
    setStatus("OK");

    renderConfirmed();
    renderReservations();
  }catch(err){
    setEvStatus("-");
    setStatus("-");
    setError("åˆæœŸåŒ–ã«å¤±æ•—ï¼š " + (err.message || err));
  }
})();
</script>

</body>
</html>