<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>äºˆç´„ç®¡ç†</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 60px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 10px;border-radius:10px;cursor:pointer;
  font-size:12px;
  text-decoration:none;color:inherit;display:inline-flex;align-items:center;gap:6px;
}
.btn.primary{
  background:linear-gradient(135deg,var(--pri),var(--pri2));
  color:#fff;border:none;
}
.btn.danger{border-color:#fca5a5;color:#b91c1c}
.input{
  border:1px solid var(--line);
  padding:10px 12px;
  border-radius:12px;
  width:100%;
  background:#fff;
  font-size:13px;
}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:#b91c1c}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:900px){ .grid{grid-template-columns:1fr 1fr} }
@media(max-width:520px){ .grid{grid-template-columns:1fr} }

.badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
.badge.ok{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.hint{font-size:12px;color:var(--muted);line-height:1.4}

/* ===== ç”·å¥³åˆ†å‰²ï¼‹è‰²åˆ†ã‘ï¼ˆå‚åŠ ç¢ºå®šã®ã¿ï¼‰ ===== */
.split{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media (max-width:720px){ .split{grid-template-columns:1fr} }
.box{border-radius:18px;padding:12px;box-shadow:var(--shadow);border:1px solid var(--line);}
.box.male{background:#eff6ff;border-color:#bfdbfe;}
.box.female{background:#fff1f2;border-color:#fecdd3;}
.boxHd{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.boxHd .ttl{font-weight:900;font-size:14px}
.boxHd .count{font-size:12px;font-weight:700;color:var(--muted)}
.pCard{border-radius:14px;padding:10px;margin-bottom:8px;background:#fff;border:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.pCard.male{ border-color:#dbeafe; }
.pCard.female{ border-color:#ffe4e6; }
.pName{font-weight:800}
.pMeta{font-size:12px;color:var(--muted);margin-top:4px}
.noteSex{font-size:12px;color:#b45309;margin-top:10px}
.pActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ===== è¿½è¨˜ï¼šäºˆç´„ä¸€è¦§ãƒœã‚¿ãƒ³ï¼ˆä¸‹ï¼‰ ===== */
.bottomBar{
  position:fixed;left:0; right:0; bottom:0;padding:10px;
  background:rgba(246,247,251,.85);backdrop-filter: blur(8px);
  border-top:1px solid var(--line);display:flex;justify-content:center;z-index:20;
}
.bottomBar .btnLike{
  width:min(920px, calc(100% - 24px));
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:12px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.08);
  background:#fff;box-shadow:0 12px 36px rgba(15,23,42,.18);
  cursor:pointer;font-weight:900;
}

/* ===== è¿½è¨˜ï¼šäºˆç´„ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modalBack{position:fixed; inset:0;background:rgba(15,23,42,.35);display:none; align-items:center; justify-content:center;z-index:30;}
.modal{width:min(860px, 96vw);max-height:86vh;background:#fff;border-radius:16px;box-shadow:0 18px 60px rgba(15,23,42,.25);overflow:hidden;display:flex;flex-direction:column;}
.modalHd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
.modalBd{padding:12px 14px;overflow:auto;}
.rCard{
  border:1px solid var(--line);border-radius:14px;padding:10px 12px;margin-bottom:10px;background:#fff;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center
}
.rTitle{font-weight:900}
.rMeta{font-size:12px;color:var(--muted);margin-top:4px}
.rActions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ===== â˜…è¿½åŠ ï¼šæ–°è¦ç™»éŒ² æŠ˜ã‚ŠãŸãŸã¿ ===== */
.hdRow{display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%}
.foldBtn{
  border:1px solid var(--line);
  background:#fff;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  user-select:none;
}
.foldBtn .chev{font-weight:900}
.foldBody{display:block}
.foldBody.isHidden{display:none}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>å‚åŠ è€…ç®¡ç†</h1>
      <div class="sub">æ–°è¦ç™»éŒ²ã¯ã€Œäºˆç´„ã€â†’ã€Œå‚åŠ ç¢ºå®šã€ã§å‚åŠ è€…ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn" href="../admin.html">ç®¡ç†ã¸æˆ»ã‚‹</a>
    <a class="btn" href="../customers/customers.html">é¡§å®¢ãƒã‚¹ã‚¿</a>
  </div>
</header>

<section class="card">
  <div class="hd">
    <strong>ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</strong>
    <span class="meta" id="evStatus">-</span>
    <span class="meta" id="loadedAt">-</span>
  </div>
  <div class="bd">
    <select class="input" id="eventSel"></select>
    <div class="hint" style="margin-top:8px">
      â€»ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã¶ã¨ã€ã€Œå‚åŠ ç¢ºå®šè€…ã€ã ã‘ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚äºˆç´„ã¯ä¸‹ã®ã€Œäºˆç´„ä¸€è¦§ã€ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
    </div>
  </div>
</section>

<!-- â˜…æ–°è¦ç™»éŒ²ã‚«ãƒ¼ãƒ‰ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾å¿œï¼‰ -->
<section class="card" style="margin-top:14px" id="newCard">
  <div class="hd">
    <div class="hdRow">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <strong>æ–°è¦ç™»éŒ²ï¼ˆã¾ãšäºˆç´„ã«å…¥ã‚‹ï¼‰</strong>
        <span class="meta">åå‰ or é›»è©±ç•ªå·ã§é¡§å®¢ãƒã‚¹ã‚¿ã‹ã‚‰è‡ªå‹•èª­è¾¼</span>
        <span class="badge" id="autoBadge" style="display:none">è‡ªå‹•èª­è¾¼</span>
      </div>

      <button class="foldBtn" id="btnToggleNew" type="button" aria-expanded="true">
        <span class="chev" id="newChev">â–²</span>
        <span id="newFoldLabel">é–‰ã˜ã‚‹</span>
      </button>
    </div>
  </div>

  <div class="bd foldBody" id="newBody">
    <div class="grid">
      <div>
        <div class="meta" style="margin:0 0 6px">åå‰ï¼ˆå¿…é ˆï¼‰</div>
        <input class="input" id="pName" placeholder="ä¾‹ï¼‰å±±ç”° èŠ±å­">
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">æ€§åˆ¥ <span style="color:#ef4444;font-weight:700">â€»å¿…é ˆ</span></div>
        <select class="input" id="pGender">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="M">ç”·æ€§</option>
          <option value="F">å¥³æ€§</option>
        </select>
        <div class="hint" style="margin-top:4px">â€»å‚åŠ ç¢ºå®šå¾Œã«ã€Œç”·å¥³åˆ¥ãƒ»è‰²åˆ†ã‘è¡¨ç¤ºã€ã•ã‚Œã¾ã™</div>
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">å¹´é½¢</div>
        <input class="input" id="pAge" placeholder="ä¾‹ï¼‰32" inputmode="numeric">
      </div>

      <div>
        <div class="meta" style="margin:0 0 6px">é›»è©±/é€£çµ¡å…ˆ</div>
        <input class="input" id="pContact" placeholder="ä¾‹ï¼‰09012345678ï¼ˆå…ˆé ­0ã‚‚OKï¼‰" inputmode="tel">
      </div>

      <!-- â˜…è¿½åŠ ï¼šé€£çµ¡æ–¹æ³• -->
      <div>
        <div class="meta" style="margin:0 0 6px">é€£çµ¡æ–¹æ³•</div>
        <select class="input" id="pContactWay">
          <option value="">æœªè¨­å®š</option>
          <option value="é›»è©±">é›»è©±</option>
          <option value="SMS">SMS</option>
          <option value="LINE">LINE</option>
          <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
          <option value="Instagram">Instagram</option>
          <option value="Facebook">Facebook</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>

      <div style="grid-column:1/-1">
        <div class="meta" style="margin:0 0 6px">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
        <input class="input" id="pMemo" placeholder="ä¾‹ï¼‰ç´¹ä»‹çµŒç”± / æ¬¡å›æ¡ˆå†…OK">
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" id="btnSave" type="button">äºˆç´„ã¨ã—ã¦ç™»éŒ²</button>
      <button class="btn" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button>
      <span class="meta" id="status">-</span>
      <span class="err" id="err"></span>
    </div>

    <div class="hint" style="margin-top:10px">
      ãƒ»æ–°è¦ç™»éŒ²ã¯ã€Œäºˆç´„ä¸€è¦§ã€ã«å…¥ã‚Šã¾ã™ã€‚å‚åŠ ç¢ºå®šã¯äºˆç´„ä¸€è¦§ã§è¡Œã„ã¾ã™ã€‚<br>
      ãƒ»ç™»éŒ²ã¨åŒæ™‚ã«é¡§å®¢ãƒã‚¹ã‚¿ã¸ã‚‚è‡ªå‹•åæ˜ ï¼ˆGASå´ã®ä»•æ§˜ï¼‰ã‚’æƒ³å®šã€‚
    </div>
  </div>
</section>

<section class="card" style="margin-top:14px">
  <div class="hd">
    <strong>å‚åŠ ç¢ºå®šè€…ï¼ˆã“ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰</strong>
    <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆåå‰/é€£çµ¡å…ˆ/é€£çµ¡æ–¹æ³•ï¼‰" style="max-width:260px">
    <span class="meta" id="count">-</span>
  </div>
  <div class="bd">
    <div class="split">
      <div class="box male">
        <div class="boxHd">
          <div class="ttl">ğŸ‘¨ ç”·æ€§ï¼ˆç¢ºå®šï¼‰</div>
          <div class="count" id="cntM">0å</div>
        </div>
        <div id="listM"></div>
      </div>

      <div class="box female">
        <div class="boxHd">
          <div class="ttl">ğŸ‘© å¥³æ€§ï¼ˆç¢ºå®šï¼‰</div>
          <div class="count" id="cntF">0å</div>
        </div>
        <div id="listF"></div>
      </div>
    </div>

    <div class="noteSex" id="sexWarn" style="display:none"></div>
  </div>
</section>

</div>

<!-- äºˆç´„ä¸€è¦§ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ä¸‹å›ºå®šï¼‰ -->
<div class="bottomBar">
  <button class="btnLike" id="btnOpenRes" type="button">
    ğŸ“‹ äºˆç´„ä¸€è¦§ã‚’é–‹ãï¼ˆ<span id="cntR">0</span>ä»¶ï¼‰
  </button>
</div>

<!-- äºˆç´„ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBack" id="resBack">
  <div class="modal">
    <div class="modalHd">
      <div style="font-weight:900">äºˆç´„ä¸€è¦§ï¼ˆã“ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼‰</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <span class="meta" id="resMeta">-</span>
        <button class="btn" id="btnCloseRes" type="button">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd" id="resBody"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const $ = id => document.getElementById(id);

let events = [];
let participantsRaw = [];
let participants = [];     // æ­£è¦åŒ–ï¼†é‡è¤‡æ’é™¤å¾Œ
let customers = [];

function setStatus(msg){ $("status").textContent = msg || "-"; }
function setError(msg){ $("err").textContent = msg || ""; }
function setEvStatus(msg){ $("evStatus").textContent = msg || "-"; }

async function fetchJson(url, opt){
  const res = await fetch(url, Object.assign({cache:"no-store"}, opt||{}));
  const j = await res.json().catch(()=> ({}));
  if(j && j.ok === false && j.error) throw new Error(j.error);
  return j;
}

/* ===== â˜…è¿½åŠ ï¼šæ–°è¦ç™»éŒ² æŠ˜ã‚ŠãŸãŸã¿ï¼ˆçŠ¶æ…‹ä¿å­˜ï¼‰ ===== */
const NEW_FOLD_KEY = "participants_newFold_v1";
function setNewFold(isOpen){
  const body = $("newBody");
  const btn = $("btnToggleNew");
  const chev = $("newChev");
  const label = $("newFoldLabel");

  if(isOpen){
    body.classList.remove("isHidden");
    btn.setAttribute("aria-expanded","true");
    chev.textContent = "â–²";
    label.textContent = "é–‰ã˜ã‚‹";
    localStorage.setItem(NEW_FOLD_KEY, "open");
  }else{
    body.classList.add("isHidden");
    btn.setAttribute("aria-expanded","false");
    chev.textContent = "â–¼";
    label.textContent = "é–‹ã";
    localStorage.setItem(NEW_FOLD_KEY, "closed");
  }
}
function initNewFold(){
  const saved = localStorage.getItem(NEW_FOLD_KEY);
  const open = (saved !== "closed"); // åˆæœŸã¯é–‹ã
  setNewFold(open);
}
$("btnToggleNew").onclick = ()=>{
  const isOpen = $("btnToggleNew").getAttribute("aria-expanded") === "true";
  setNewFold(!isOpen);
};

/* ===== normalize ===== */
function zenkakuToHankakuNum(s){
  return String(s??"").replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
}
function normalizeName(s){
  return String(s??"").trim().replace(/\s+/g," ").toLowerCase();
}
function normalizePhoneLike(s){
  return zenkakuToHankakuNum(String(s??"")).replace(/[^\d]/g,"");
}
function normalizeGender(v){
  const s = String(v??"").trim().toUpperCase();
  if(s==="M" || s==="MALE" || s==="ç”·" || s==="ç”·æ€§") return "M";
  if(s==="F" || s==="FEMALE" || s==="å¥³" || s==="å¥³æ€§") return "F";
  return "";
}
function normalizeStatus(v){
  const s = String(v??"").trim().toLowerCase();
  if(s==="confirmed" || s==="ok" || s==="å‚åŠ " || s==="ç¢ºå®š") return "confirmed";
  if(s==="reserved" || s==="reserve" || s==="äºˆç´„") return "reserved";
  return "reserved";
}
function nowIso(){ return new Date().toISOString(); }
function makePid(){
  if(window.crypto?.randomUUID) return crypto.randomUUID();
  return "pid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
}

/* â˜…è¿½åŠ ï¼šè¡¨ç¤ºç”¨ã«é›»è©±ã®å…ˆé ­0ã‚’è£œæ­£ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå´ã§ç¢ºå®Ÿã«ï¼‰ */
function displayPhone(v){
  const d = normalizePhoneLike(v);
  if(!d) return "";
  if(d.length === 9 || d.length === 10){
    return d.startsWith("0") ? d : ("0" + d);
  }
  return d.startsWith("0") ? d : d;
}

/* â˜…è¿½åŠ ï¼šé€£çµ¡æ–¹æ³•ã®æ­£è¦åŒ– */
function normalizeContactWay(v){
  const s = String(v??"").trim();
  if(!s) return "";
  const u = s.toLowerCase();
  if(u.includes("line")) return "LINE";
  if(u.includes("sms")) return "SMS";
  if(u.includes("mail") || u.includes("ãƒ¡ãƒ¼ãƒ«") || u.includes("email")) return "ãƒ¡ãƒ¼ãƒ«";
  if(u.includes("insta")) return "Instagram";
  if(u.includes("face")) return "Facebook";
  if(u.includes("é›»è©±") || u.includes("tel") || u.includes("phone")) return "é›»è©±";
  return s;
}

function showAutoBadge(on){
  $("autoBadge").style.display = on ? "inline-flex" : "none";
  $("autoBadge").className = on ? "badge ok" : "badge";
}

/* ===== API ===== */
async function apiEvents(){
  const j = await fetchJson(API_URL + "?action=list");
  return j.events || [];
}
async function apiCustomers(){
  const j = await fetchJson(API_URL + "?action=customers:list&nocache=1");
  return j.customers || [];
}
async function apiParticipantsList(eventId){
  const j = await fetchJson(API_URL + "?action=participants:list&eventId=" + encodeURIComponent(eventId));
  return j.participants || [];
}
async function apiParticipantsUpsert(p){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:upsert", participant:p })
  });
}
async function apiParticipantsDelete(pid){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:delete", pid })
  });
}
/* â˜…è¿½è¨˜ï¼šç¢ºå®šâ†’äºˆç´„ã«æˆ»ã™ï¼ˆGASã® participants:revert ã‚’ä½¿ã†ï¼‰ */
async function apiParticipantsRevert(pid){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"participants:revert", pid })
  });
}

/* ===== UIï¼šã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ ===== */
function fmtDateJa(v){
  if(!v) return "-";
  const d = new Date(v);
  if(Number.isNaN(d.getTime())) return String(v);
  return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
}
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"\"").replaceAll("'","&#039;");
}
function buildEventSelect(){
  const sel = $("eventSel");
  if(!events.length){
    sel.innerHTML = `<option value="">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>`;
    return;
  }
  const sorted = [...events].sort((a,b)=>String(b.date||"").localeCompare(String(a.date||"")));
  sel.innerHTML = sorted.map(e=>{
    const label = `${fmtDateJa(e.date)}ï½œ${e.title||e.name||"(ç„¡é¡Œ)"}ï½œ${e.place||"-"}`;
    return `<option value="${escapeHtml(e.id)}">${escapeHtml(label)}</option>`;
  }).join("");
}

/* ===== é¡§å®¢ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ« ===== */
let autoTimer = null;
function scheduleAutoFill(){
  clearTimeout(autoTimer);
  autoTimer = setTimeout(tryAutoFillFromCustomers, 200);
}
function tryAutoFillFromCustomers(){
  showAutoBadge(false);

  const nameIn = normalizeName($("pName").value);
  const phoneIn = normalizePhoneLike($("pContact").value);
  if(!nameIn && !phoneIn) return;

  let hit = null;
  if(phoneIn) hit = customers.find(c => normalizePhoneLike(c.contact) === phoneIn);
  if(!hit && nameIn) hit = customers.find(c => normalizeName(c.name) === nameIn);
  if(!hit) return;

  if(!$("pAge").value.trim() && hit.age) $("pAge").value = hit.age;
  if(!$("pContact").value.trim() && hit.contact) $("pContact").value = displayPhone(hit.contact);

  // â˜…é¡§å®¢ãƒã‚¹ã‚¿å´ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«åˆã‚ã›ã¦è¤‡æ•°å€™è£œã§èª­è¾¼
  const cw = hit.contactWay ?? hit.contact_method ?? hit.contactMethod ?? hit.method ?? hit["é€£çµ¡æ–¹æ³•"] ?? hit["é€£çµ¡æ‰‹æ®µ"] ?? "";
  if(!$("pContactWay").value && cw) $("pContactWay").value = normalizeContactWay(cw);

  if(!$("pMemo").value.trim() && hit.memo) $("pMemo").value = hit.memo;

  const g = normalizeGender(hit.gender ?? hit.sex ?? "");
  if(!$("pGender").value && g) $("pGender").value = g;

  showAutoBadge(true);
}

/* ===== å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ï¼šé‡è¤‡æ’é™¤ ===== */
function normalizeParticipants(raw){
  const list = raw.map(p=>{
    const pid = String(p.pid ?? p.participantId ?? p.id ?? "").trim();
    return {
      ...p,
      pid,
      gender: normalizeGender(p.gender),
      status: normalizeStatus(p.status),
      contact: displayPhone(p.contact),
      // â˜…è¿½åŠ ï¼šé€£çµ¡æ–¹æ³•
      contactWay: normalizeContactWay(p.contactWay ?? p.contact_method ?? p.contactMethod ?? p.method ?? p["é€£çµ¡æ–¹æ³•"] ?? p["é€£çµ¡æ‰‹æ®µ"] ?? ""),
      updatedAt: p.updatedAt || p.ts || p.timestamp || "",
      createdAt: p.createdAt || ""
    };
  });

  const withPid = list.filter(x=>x.pid);
  const noPid = list.filter(x=>!x.pid);

  const map = {};
  for(const x of withPid){
    const key = x.pid;
    const a = map[key];
    if(!a){ map[key]=x; continue; }
    const ta = Date.parse(a.updatedAt||"") || 0;
    const tb = Date.parse(x.updatedAt||"") || 0;
    map[key] = (tb >= ta) ? x : a;
  }
  return [...Object.values(map), ...noPid];
}

/* ===== å‚åŠ è€…ä¸€è¦§ï¼ˆç¢ºå®šã®ã¿ï¼‰ ===== */
function renderConfirmed(){
  const q = $("q").value.trim().toLowerCase();

  const confirmed = participants.filter(p => normalizeStatus(p.status) === "confirmed");
  const filtered = q
    ? confirmed.filter(p=>{
        const s = `${p.name||""} ${p.contact||""} ${p.contactWay||""}`.toLowerCase();
        return s.includes(q);
      })
    : confirmed;

  $("count").textContent = `${filtered.length}ä»¶`;

  const men = filtered.filter(p => normalizeGender(p.gender) === "M");
  const women = filtered.filter(p => normalizeGender(p.gender) === "F");
  const unknown = filtered.filter(p => !normalizeGender(p.gender));

  $("cntM").textContent = `${men.length}å`;
  $("cntF").textContent = `${women.length}å`;

  const mk = (p, sex)=>`
    <div class="pCard ${sex}">
      <div>
        <div class="pName">${escapeHtml(p.name||"-")}</div>
        <div class="pMeta">
          å¹´é½¢:${escapeHtml(p.age||"-")}
          ï½œé€£çµ¡å…ˆ:${escapeHtml(p.contact||"-")}
          ï½œé€£çµ¡æ–¹æ³•:${escapeHtml(p.contactWay||"-")}
        </div>
      </div>
      <div class="pActions">
        ${p.pid ? `<button class="btn danger" data-del-confirm="${escapeHtml(p.pid)}">äºˆç´„ã«æˆ»ã™</button>` : ``}
      </div>
    </div>
  `;

  $("listM").innerHTML = men.length ? men.map(p=>mk(p,"male")).join("") : `<div class="meta">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>`;
  $("listF").innerHTML = women.length ? women.map(p=>mk(p,"female")).join("") : `<div class="meta">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>`;

  const sexWarn = $("sexWarn");
  if(unknown.length){
    sexWarn.style.display = "block";
    sexWarn.textContent = `âš  æ€§åˆ¥ãŒæœªè¨­å®šã®ç¢ºå®šè€…ãŒ ${unknown.length}åã„ã¾ã™ï¼ˆäºˆç´„ä¸€è¦§ã§æ€§åˆ¥ã‚’ç›´ã—ã¦ã‹ã‚‰ç¢ºå®šã—ã¦ãã ã•ã„ï¼‰`;
  }else{
    sexWarn.style.display = "none";
    sexWarn.textContent = "";
  }
}

/* ===== äºˆç´„ä¸€è¦§ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ===== */
function countReserved(){
  return participants.filter(p => normalizeStatus(p.status) === "reserved").length;
}
function openResModal(){
  $("resBack").style.display = "flex";
  renderReservations();
}
function closeResModal(){
  $("resBack").style.display = "none";
}
$("btnOpenRes").onclick = openResModal;
$("btnCloseRes").onclick = closeResModal;
$("resBack").addEventListener("click", (e)=>{
  if(e.target === $("resBack")) closeResModal();
});

/* â˜…ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã§ãƒœã‚¿ãƒ³åå¿œã‚’å®‰å®šåŒ–ï¼ˆSafariå¯¾ç­–ï¼‰ */
$("resBody").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.confirm) confirmParticipant(btn.dataset.confirm);
  if(btn.dataset.del) deleteReserved(btn.dataset.del);
});
$("listM").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.delConfirm) revertConfirmedToReserved(btn.dataset.delConfirm);
});
$("listF").addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  if(btn.dataset.delConfirm) revertConfirmedToReserved(btn.dataset.delConfirm);
});

async function confirmParticipant(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;

  const p = participants.find(x => x.pid === pid);
  if(!p){
    alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆpidãŒæœªè¨­å®šã®å¯èƒ½æ€§ï¼‰");
    return;
  }

  setError("");
  try{
    setStatus("å‚åŠ ç¢ºå®šä¸­â€¦");

    await apiParticipantsUpsert({
      eventId,
      pid: p.pid,
      name: p.name || "",
      gender: normalizeGender(p.gender),
      age: p.age || "",
      contact: displayPhone(p.contact || ""),
      contactWay: normalizeContactWay(p.contactWay || ""),
      memo: p.memo || "",
      status: "confirmed",
      updatedAt: nowIso()
    });

    await reloadParticipants(eventId);

    setStatus("å‚åŠ ç¢ºå®šã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();

  }catch(err){
    setStatus("-");
    setError("å‚åŠ ç¢ºå®šã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

async function deleteReserved(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  if(!pid) return alert("pidãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ï¼‰");
  if(!confirm("ã“ã®äºˆç´„ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  setError("");
  try{
    setStatus("å‰Šé™¤ä¸­â€¦");
    await apiParticipantsDelete(pid);
    await reloadParticipants(eventId);
    setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();
  }catch(err){
    setStatus("-");
    setError("å‰Šé™¤ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

/* â˜…å¤‰æ›´ï¼šç¢ºå®šè€…ã®ã€Œå‰Šé™¤ã€ã¯å®Œå…¨å‰Šé™¤ã§ã¯ãªãã€GASã® participants:revert ã‚’ä½¿ã£ã¦äºˆç´„ã«æˆ»ã™ */
async function revertConfirmedToReserved(pid){
  const eventId = $("eventSel").value;
  if(!eventId) return;
  if(!pid) return alert("pidãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã®å¯èƒ½æ€§ï¼‰");
  if(!confirm("ã“ã®å‚åŠ ç¢ºå®šè€…ã‚’ã€Œäºˆç´„ä¸€è¦§ã€ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;

  setError("");
  try{
    setStatus("äºˆç´„ã«æˆ»ã—ã¦ã„ã¾ã™â€¦");

    await apiParticipantsRevert(pid);
    await reloadParticipants(eventId);

    setStatus("äºˆç´„ä¸€è¦§ã«æˆ»ã—ã¾ã—ãŸ");
    renderReservations();
    renderConfirmed();
  }catch(err){
    setStatus("-");
    setError("æˆ»ã™å‡¦ç†ã«å¤±æ•—ï¼š " + (err.message || err));
  }
}

function renderReservations(){
  const reserved = participants.filter(p => normalizeStatus(p.status) === "reserved");

  $("cntR").textContent = String(reserved.length);
  $("resMeta").textContent = reserved.length ? `${reserved.length}ä»¶ã®äºˆç´„` : "äºˆç´„ãªã—";

  if(!reserved.length){
    $("resBody").innerHTML = `<div class="meta">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  $("resBody").innerHTML = reserved.map(p=>{
    const g = normalizeGender(p.gender);
    const gLabel = g==="M" ? "ç”·æ€§" : (g==="F" ? "å¥³æ€§" : "æœªè¨­å®š");
    const meta = [
      `æ€§åˆ¥:${gLabel}`,
      `å¹´é½¢:${p.age||"-"}`,
      `é€£çµ¡å…ˆ:${displayPhone(p.contact)||"-"}`,
      `é€£çµ¡æ–¹æ³•:${p.contactWay||"-"}`,
      p.memo ? `ãƒ¡ãƒ¢:${p.memo}` : ""
    ].filter(Boolean).join(" ï½œ ");

    const confirmBtn = p.pid
      ? `<button class="btn primary" data-confirm="${escapeHtml(p.pid)}" type="button">å‚åŠ ç¢ºå®š</button>`
      : `<span class="meta">pidãªã—ï¼ˆå¤ã„äºˆç´„ï¼‰</span>`;

    const delBtn = p.pid
      ? `<button class="btn danger" data-del="${escapeHtml(p.pid)}" type="button">å‰Šé™¤</button>`
      : ``;

    return `
      <div class="rCard">
        <div>
          <div class="rTitle">${escapeHtml(p.name||"-")}</div>
          <div class="rMeta">${escapeHtml(meta)}</div>
        </div>
        <div class="rActions">
          ${confirmBtn}
          ${delBtn}
        </div>
      </div>
    `;
  }).join("");
}

/* ===== æ“ä½œ ===== */
function clearForm(){
  $("pName").value="";
  $("pGender").value="";
  $("pAge").value="";
  $("pContact").value="";
  $("pContactWay").value="";
  $("pMemo").value="";
  showAutoBadge(false);
}
$("btnClear").onclick = ()=>{ setError(""); clearForm(); };

$("btnSave").onclick = async ()=>{
  setError("");
  try{
    const eventId = $("eventSel").value;
    if(!eventId){ alert("ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    const name = $("pName").value.trim();
    if(!name){ alert("åå‰ã¯å¿…é ˆã§ã™"); return; }

    const gender = $("pGender").value;
    if(!gender){ alert("æ€§åˆ¥ï¼ˆç”·æ€§/å¥³æ€§ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

    setStatus("äºˆç´„ç™»éŒ²ä¸­â€¦");

    const p = {
      eventId,
      pid: makePid(),
      name,
      gender,
      age: $("pAge").value.trim(),
      contact: displayPhone($("pContact").value.trim()),
      contactWay: normalizeContactWay($("pContactWay").value),
      memo: $("pMemo").value.trim(),
      status: "reserved",
      createdAt: nowIso(),
      updatedAt: nowIso()
    };

    await apiParticipantsUpsert(p);
    await reloadParticipants(eventId);

    setStatus("äºˆç´„ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ");
    clearForm();
    renderConfirmed();
    renderReservations();

  }catch(err){
    setStatus("-");
    setError("ç™»éŒ²ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};

$("q").oninput = renderConfirmed;

$("eventSel").addEventListener("change", async ()=>{
  setError("");
  try{
    const eventId = $("eventSel").value;
    if(!eventId){
      participantsRaw = [];
      participants = [];
      renderConfirmed();
      $("cntR").textContent = "0";
      return;
    }
    await reloadParticipants(eventId);
    renderConfirmed();
  }catch(err){
    setEvStatus("-");
    setError("å‚åŠ è€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err.message || err));
  }
});

$("pName").addEventListener("input", scheduleAutoFill);
$("pContact").addEventListener("input", scheduleAutoFill);

/* â˜…è¿½è¨˜ï¼šé€£çµ¡æ–¹æ³•ã‚’å¤‰æ›´ã—ãŸã‚‰ã‚ªãƒ¼ãƒˆãƒãƒƒã‚¸è¡¨ç¤ºçŠ¶æ…‹ã‚’ç¶­æŒã—ãŸã„å ´åˆã®ãŸã‚ï¼ˆè»½ã„å†åˆ¤å®šï¼‰ */
$("pContactWay").addEventListener("change", ()=>{ showAutoBadge($("autoBadge").style.display !== "none"); });

/* ===== èª­ã¿è¾¼ã¿ ===== */
async function reloadParticipants(eventId){
  setEvStatus("å‚åŠ è€…èª­è¾¼ä¸­â€¦");
  participantsRaw = await apiParticipantsList(eventId);
  participants = normalizeParticipants(participantsRaw);
  $("cntR").textContent = String(countReserved());
  setEvStatus("OK");
}

/* ===== èµ·å‹• ===== */
(async()=>{
  try{
    initNewFold();

    setEvStatus("èª­è¾¼ä¸­â€¦");
    setStatus("èª­è¾¼ä¸­â€¦");
    setError("");

    customers = await apiCustomers();
    events = await apiEvents();
    buildEventSelect();

    const firstId = $("eventSel").value;
    if(firstId){
      await reloadParticipants(firstId);
    }else{
      participantsRaw = [];
      participants = [];
      $("cntR").textContent = "0";
    }

    $("loadedAt").textContent = "èª­ã¿è¾¼ã¿ï¼š" + new Date().toLocaleString("ja-JP");
    setEvStatus("OK");
    setStatus("OK");
    renderConfirmed();
    renderReservations();

  }catch(err){
    setEvStatus("-");
    setStatus("-");
    setError("åˆæœŸåŒ–ã«å¤±æ•—ï¼š " + (err.message || err));
  }
})();
</script>

</body>
</html>