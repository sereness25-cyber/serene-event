<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted);margin-top:2px}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 10px;border-radius:12px;cursor:pointer;
  font-size:12px;
  text-decoration:none;color:inherit;display:inline-flex;align-items:center;gap:6px;
  box-shadow:0 6px 16px rgba(15,23,42,.06);
}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:#b91c1c}

.week{
  margin-top:10px;
  display:grid;grid-template-columns:repeat(7,1fr);gap:10px;
  font-size:12px;color:var(--muted);
}
.grid{
  margin-top:8px;
  display:grid;grid-template-columns:repeat(7,1fr);gap:10px;
}

/* âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ ãŒå´©ã‚Œãªã„ã‚ˆã†ã«ï¼šdayã‚’flexåŒ–ã—ã€å­è¦ç´ ã®ã¯ã¿å‡ºã—ã‚’æŠ‘åˆ¶ */
.day{
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
  min-height:92px;
  padding:10px;

  display:flex;
  flex-direction:column;
  overflow:hidden; /* é‡è¦ï¼šä¸­èº«ã§æ ãŒå´©ã‚Œãªã„ */
}
.day .num{font-weight:700;font-size:14px;flex:0 0 auto}
.day.muted{opacity:.35}
.day.today{outline:2px solid rgba(79,124,255,.25)}

/* âœ… ãƒãƒƒãƒ—ã¯ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ãƒ»çœç•¥è¡¨ç¤ºãƒ»æ ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ */
.chip{
  margin-top:6px;
  border:1px solid rgba(79,124,255,.25);
  background:rgba(79,124,255,.08);
  color:#1f3b8f;
  border-radius:12px;
  padding:6px 8px;
  font-size:12px;
  cursor:pointer;

  display:block;
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
@media(max-width:520px){
  .chip{font-size:11px; padding:6px 7px;}
}

.moreBtn{
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
  cursor:pointer;
  padding-left:4px;
  flex:0 0 auto;
}

/* ===========================
   âœ… modalï¼ˆã‚¹ãƒãƒ›ã§ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹æœ€é©åŒ–ï¼‰
=========================== */
.modalBack{
  position:fixed; inset:0;
  background:rgba(15,23,42,.35);
  display:none;
  padding:12px;
  z-index:50;

  align-items:flex-start;
  justify-content:center;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.modal{
  width:min(720px,100%);
  max-height:calc(100dvh - 24px);
  background:#fff;border-radius:16px;
  box-shadow:0 18px 60px rgba(15,23,42,.25);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  margin:auto;
}
.modalHd{
  padding:12px 14px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  flex:0 0 auto;
  background:#fff;
}
.modalBd{
  padding:12px 14px;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  flex:1 1 auto;
  min-height:0;
  overscroll-behavior:contain;
}

/* event detail */
.evCard{
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  margin-bottom:10px;
}
.evName{font-weight:800}
.evMeta{font-size:12px;color:var(--muted);margin-top:4px}
.evRow{font-size:13px;margin-top:6px}

/* âœ… è©³ç´° 2ã‚«ãƒ©ãƒ ï¼ˆå³ã‚’åºƒã‚ã«ï¼‰ */
.evLayout{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1fr 1.45fr;
  gap:12px;
  align-items:start;
}
.evLayout.single{grid-template-columns:1fr;}
@media (max-width:740px){
  .evLayout{grid-template-columns:1fr;}
}
.evLeft .evRow{margin-top:6px}
.evRight{
  border-left:1px dashed var(--line);
  padding-left:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
@media (max-width:740px){
  .evRight{border-left:none;padding-left:0;border-top:1px dashed var(--line);padding-top:10px;margin-top:4px;}
}
.summaryBox{
  background:#fafbff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
}
.summaryTtl{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  margin:0 0 6px 0;
  letter-spacing:.02em;
}
.summaryText{
  font-size:13px;
  line-height:1.55;
  white-space:pre-wrap;
  word-break:break-word;
}

/* LINEäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  */
.lineReserveBox{margin-top:14px;padding-top:12px;border-top:1px dashed var(--line);display:flex;flex-direction:column;gap:10px;}
.reserveForm{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fafbff;}
.reserveForm .ttl{font-weight:800;margin:0 0 8px 0;font-size:13px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media (max-width:520px){ .fgrid{grid-template-columns:1fr} }
.fi{display:flex;flex-direction:column;gap:6px;}
.fi label{font-size:12px;color:var(--muted)}
.fi input{padding:10px 10px;border-radius:12px;border:1px solid var(--line);font-size:14px;background:#fff;}
.smallNote{font-size:11px;color:var(--muted);margin-top:6px}
.formBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.formBtns .btnLike{
  flex:1; min-width:220px;
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:12px 14px;border-radius:999px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff;
  box-shadow:0 12px 36px rgba(15,23,42,.18);
  cursor:pointer;
  font-weight:800;
  text-decoration:none;color:inherit;
}
.formBtns .btnLike.secondary{box-shadow:none;background:#fff;border:1px solid var(--line);}
.warnText{font-size:12px;color:#b45309;margin-top:6px}

/* ç”»åƒä¿å­˜ä¸­ */
.saving{opacity:.65;pointer-events:none;filter:grayscale(.15);}

/* ===== ãƒ­ã‚´ï¼‹ã‚¿ã‚¤ãƒˆãƒ« æ¨ªä¸¦ã³èª¿æ•´ï¼ˆæœ€çµ‚ç‰ˆï¼‰ ===== */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
position:relative;
}
.brand{
  display:flex;
  align-items:center;
  gap:12px;
  min-width:240px;
}
.logo{
  width:64px;
  height:64px;
  min-width:64px;
  min-height:64px;
  border-radius:18px;
  background:#fff;
  border:1px solid var(--line);
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.logo img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.brand h1{
  margin:0;
  font-size:20px;
  font-weight:700;
  line-height:1.25;
}

/* ===========================
   âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ï¼ˆãƒšãƒ¼ã‚¸ä¸‹ã«å¸¸æ™‚è¡¨ç¤ºï¼‰
=========================== */
.policyWrap{margin-top:12px}
.policyBox{
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
  padding:12px 14px;
}
.policyLead{
  font-size:12px;
  color:var(--muted);
  margin:0 0 10px 0;
}
.policyImg{
  width:100%;
  border-radius:12px;
  border:1px solid var(--line);
  display:block;
}
.policyText{
  margin-top:10px;
  font-size:13px;
  line-height:1.65;
  white-space:pre-wrap;
  word-break:break-word;
}

/* ===== ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å‘ŠçŸ¥ãƒœã‚¿ãƒ³ï¼ˆæ¨ªä¸¦ã³ã§ç›®ç«‹ã¤ï¼‰ ===== */
.campaignBtn{
  display:inline-flex;
  align-items:center;
  gap:8px;

  padding:10px 14px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;

  background:linear-gradient(135deg,#ef4444,#f59e0b);
  color:#fff;
  text-decoration:none;
  border:none;

  box-shadow:0 10px 26px rgba(239,68,68,.35);
  white-space:nowrap;
}
.campaignBtn:hover{ transform:translateY(-1px) scale(1.02); }
.campaignBtn:hover{
  transform:translateY(-2px) scale(1.03);
  box-shadow:
    0 12px 34px rgba(239,68,68,.65),
    0 0 0 6px rgba(239,68,68,.18);
}

/* ãµã‚ã£ã¨é¼“å‹•ã™ã‚‹ */
@keyframes pulseCampaign{
  0%   { box-shadow:0 8px 24px rgba(239,68,68,.55), 0 0 0 0 rgba(239,68,68,.35); }
  70%  { box-shadow:0 12px 30px rgba(239,68,68,.65), 0 0 0 12px rgba(239,68,68,0); }
  100% { box-shadow:0 8px 24px rgba(239,68,68,.55), 0 0 0 0 rgba(239,68,68,0); }
}
.campaignBtn:hover{
  transform:translateY(-2px);
  box-shadow:0 14px 34px rgba(249,115,22,.55);
}

</style>


</head>

<body>
<div class="wrap">
<header>
  <div class="brand">
    <div class="logo">
      <img src="./logo.png" alt="ãƒ­ã‚´">
    </div>
    <div>
      <h1>ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
  <button class="btn" id="btnReload">æ›´æ–°</button>
  <a class="campaignBtn" href="./campaigns.html">ğŸ“£ ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’è¦‹ã‚‹</a>
</div>

</header>

<section class="card" id="scheduleCard" style="margin-top:12px">
  <div class="hd">
    <button class="btn" id="prev">â€¹</button>
    <div id="monthTitle"></div>
    <button class="btn" id="next">â€º</button>
    <span class="meta" id="status"></span>
    <span class="err" id="err"></span>
  </div>
  <div class="bd">
    <div class="week">
      <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
    </div>
    <div class="grid" id="grid"></div>
  </div>
</section>

<!-- âœ… ãƒšãƒ¼ã‚¸ä¸‹ï¼šå¸¸æ™‚è¡¨ç¤ºã®å…±é€šã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ -->
<section class="policyWrap">
  <div class="policyBox">
    <p class="policyLead"><b>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼</b>ï¼ˆã”äºˆç´„å‰ã«ã”ç¢ºèªãã ã•ã„ï¼‰</p>
    <img class="policyImg" id="policyImg" src="./cancel_policy.png" alt="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ç”»åƒ"
         onerror="this.style.display='none'">
    <div class="policyText" id="policyText"></div>
  </div>
</section>

</div>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHd">
      <div id="mTitle">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="btnBackList" style="display:none">ä¸€è¦§ã«æˆ»ã‚‹</button>
        <button class="btn" id="btnCloseModal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd" id="mBody"></div>
  </div>
</div>

<script>
/* ===========================
   è¨­å®š
=========================== */
const API_URL="https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const LINE_ADD_URL="https://lin.ee/oP0e2Kf";
const LINE_TO = "@820theos";

/* âœ… ãƒšãƒ¼ã‚¸ä¸‹ã®å…±é€šãƒãƒªã‚·ãƒ¼ï¼ˆè‡ªç”±ã«å¤‰æ›´OKï¼‰ */
const CANCEL_POLICY_TEXT = `ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã€‘
ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã”é€£çµ¡ã¯ã§ãã‚‹ã ã‘ãŠæ—©ã‚ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã®æœ‰ç„¡ï¼æœŸé™ã¯ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹ã«ã‚ˆã‚Šç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ãƒ»ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯æ¬¡å›ä»¥é™ã®ã”å‚åŠ ã‚’ãŠæ–­ã‚Šã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
â€»è©³ç´°ã¯ä¸»å‚¬è€…ã‹ã‚‰ã®æ¡ˆå†…ã‚’å„ªå…ˆã—ã¾ã™ã€‚`;

const $=id=>document.getElementById(id);

let events=[];
let view=new Date();
let byDay={};
let byId={};
let lastListDay=null;

/* âœ… iOSå¯¾ç­–ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«æ­¢ã‚ã‚‹ï¼ˆinner scrollã¯ç”Ÿã‹ã™ï¼‰ */
let __lockY = 0;
function lockBody(){
  __lockY = window.scrollY || 0;
  document.body.style.position = "fixed";
  document.body.style.top = `-${__lockY}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
}
function unlockBody(){
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";
  window.scrollTo(0, __lockY);
}

/* ===========================
   å…±é€š
=========================== */
function pad(n){return String(n).padStart(2,"0")}

function openModal(){
  $("modalBack").style.display="flex";
  lockBody();
  $("modalBack").addEventListener("touchmove", preventBackScroll, {passive:false});
}
function closeModal(){
  $("modalBack").style.display="none";
  $("btnBackList").style.display="none";
  lastListDay=null;
  unlockBody();
  $("modalBack").removeEventListener("touchmove", preventBackScroll);
}
function preventBackScroll(e){
  if(e.target === $("modalBack")) e.preventDefault();
}

$("btnCloseModal").onclick = closeModal;

// èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
$("modalBack").addEventListener("click",(e)=>{
  if(e.target === $("modalBack")) closeModal();
});

function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function formatDateJP(ymd){
  if(!ymd) return "";
  const [y,m,d]=String(ymd).split("-");
  if(!y || !m || !d) return String(ymd);
  return `${y}å¹´${Number(m)}æœˆ${Number(d)}æ—¥`;
}

function isIsoLike(v){
  if(!v) return false;
  const s = String(v).trim();
  return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(s);
}
function cleanPay(v){
  if(!v) return "";
  const s = String(v).trim();
  if(!s) return "";
  if(isIsoLike(s)) return "";
  return s;
}
function cleanDeadline(v){
  if(!v) return "";
  const s = String(v).trim();
  if(!s) return "";
  if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)){
    const [y,m,d]=s.split("-");
    return `${y}å¹´${Number(m)}æœˆ${Number(d)}æ—¥`;
  }
  if(isIsoLike(s)) return "";
  return s;
}

/* âœ… ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ç”¨ï¼ˆäºˆç´„ã®ç´ä»˜ã‘ï¼‰ */
async function postApi(body){
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const j = await r.json().catch(()=>({ok:false,error:"JSON parse error"}));
  return j;
}
async function apiReserveUpsert(payload){
  return await postApi({ action:"reg:upsert", payload });
}

function normalizeEvent(e){
  const title = e.title ?? e.name ?? "(ç„¡é¡Œ)";
  const date  = e.date ?? e.eventDate ?? "";
  const time  = e.time ?? "";
  const timeFrom = e.timeFrom ?? "";
  const timeTo   = e.timeTo ?? "";
  const place = e.place ?? "";
  const priceM = e.priceM ?? e.feeM ?? "";
  const priceF = e.priceF ?? e.feeF ?? "";
  const slots  = e.slots ?? "";
  const payMethod = e.payMethod ?? "";
  const pay    = e.pay ?? e.payment ?? payMethod ?? "";
  const age    = e.age ?? "";
  const note   = e.note ?? "";
  const summary = e.summary ?? e.overview ?? e.memo ?? "";

  const target = e.target ?? "";
  const deadline = e.deadline ?? "";
  const id = (e.id!=null)? String(e.id) : "";

  /* âœ… è¿½åŠ ï¼šadminå´ã§å…¥åŠ›ã—ãŸã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦ã€ã‚’åæ˜ 
     - GAS/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå´ã®åˆ—åã«åˆã‚ã›ã¦ã€ã“ã“ã‚’å¢—ã‚„ã›ã¾ã™
     - ä¾‹ï¼šcancelPolicy / cancel / cancelText / cancelNote ãªã©
  */
  const cancel = e.cancelPolicy ?? e.cancel ?? e.cancelText ?? e.cancelNote ?? e.cancelAbout ?? "";

  return {id,title,date,time,timeFrom,timeTo,place,priceM,priceF,slots,pay,payMethod,age,note,summary,target,deadline,cancel};
}

/* ===========================
   ãƒ‡ãƒ¼ã‚¿å–å¾—
=========================== */
async function loadEvents(){
  $("err").textContent="";
  $("status").textContent="èª­ã¿è¾¼ã¿ä¸­â€¦";

  const r = await fetch(API_URL+"?action=list",{cache:"no-store"});
  const j = await r.json();
  events = j.events || [];

  byDay={};
  byId={};

  for(const e of events){
    const n = normalizeEvent(e);
    if(n.id) byId[n.id] = e;
    if(!n.date) continue;
    (byDay[n.date]=byDay[n.date]||[]).push(e);
  }

  Object.keys(byDay).forEach(k=>{
    byDay[k].sort((a,b)=>{
      const ta=(a.timeFrom||a.time||"99:99");
      const tb=(b.timeFrom||b.time||"99:99");
      if(ta<tb) return -1;
      if(ta>tb) return 1;
      const na=(a.title||a.name||"");
      const nb=(b.title||b.name||"");
      return String(na).localeCompare(String(nb));
    });
  });

  $("status").textContent="OK";
}

/* ===========================
   ç”»åƒä¿å­˜
=========================== */
async function saveScheduleAsPng(){
  const target = $("scheduleCard");
  if(!target) return;

  const btn = $("btnSavePng");
  const prevText = btn?.textContent || "";
  if(btn) btn.textContent = "ä½œæˆä¸­â€¦";
  target.classList.add("saving");

  try{
    const canvas = await html2canvas(target, {
      scale: Math.min(2, window.devicePixelRatio || 1),
      useCORS: true,
      backgroundColor: null
    });

    const y=view.getFullYear(), m=view.getMonth()+1;
    const filename = `event-calendar_${y}-${String(m).padStart(2,"0")}.png`;

    canvas.toBlob((blob)=>{
      if(!blob){
        window.open(canvas.toDataURL("image/png"), "_blank");
        return;
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }, "image/png");
  }catch(err){
    alert("ç”»åƒä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
    console.error(err);
  }finally{
    target.classList.remove("saving");
    if(btn) btn.textContent = prevText || "ğŸ“· ç”»åƒä¿å­˜";
  }
}


/* ===========================
   LINE èµ·å‹•
=========================== */
function isMobileLineCapable(){
  const ua = navigator.userAgent || "";
  return /iPhone|iPad|iPod|Android/i.test(ua);
}

function buildLinePrefillMessage(n, form){
  const dateJP = formatDateJP(n.date);
  const timeStr =
    (n.timeFrom || n.timeTo) ? `${n.timeFrom||""}ã€œ${n.timeTo||""}` :
    (n.time ? String(n.time) : "");

  const lines = [
    "ã€ã‚¤ãƒ™ãƒ³ãƒˆäºˆç´„ã€‘",
    `ã‚¤ãƒ™ãƒ³ãƒˆï¼š${n.title || ""}`,
    (dateJP || timeStr) ? `æ—¥æ™‚ï¼š${dateJP} ${timeStr}`.trim() : "",
    n.place ? `å ´æ‰€ï¼š${n.place}` : "",
    "",
    "ã€ãŠå®¢æ§˜æƒ…å ±ã€‘",
    `ãŠåå‰ï¼š${form.name || ""}`,
    `å¹´é½¢ï¼š${form.age || ""}`,
    `é›»è©±ç•ªå·ï¼š${form.tel || ""}`,
    `ãŠä½ã¾ã„ï¼š${form.area || ""}`
  ].filter(Boolean);

  return lines.join("\n");
}

function buildLineDeepLink(message){
  return `line://oaMessage/${encodeURIComponent(LINE_TO)}/?${encodeURIComponent(message)}`;
}

function openLineReserve(message){
  if(isMobileLineCapable()){
    location.href = buildLineDeepLink(message);
    setTimeout(()=>{ location.href = LINE_ADD_URL; }, 900);
  }else{
    window.open(LINE_ADD_URL, "_blank");
  }
}

/* ===========================
   è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
   âœ… è©³ç´°æ¬„ã«ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦ã€ã‚’è¿½åŠ ï¼ˆadminå…¥åŠ›ã‚’åæ˜ ï¼‰
=========================== */
function renderEventDetail(e){
  const n = normalizeEvent(e);

  const dateJP = formatDateJP(n.date);
  const timeStr =
    (n.timeFrom || n.timeTo) ? `${n.timeFrom||""}ã€œ${n.timeTo||""}` :
    (n.time ? String(n.time) : "");

  const priceStr = (n.priceM || n.priceF) ? `ç”·æ€§ï¼š${n.priceM||"-"} / å¥³æ€§ï¼š${n.priceF||"-"}` : "";
  const slotsStr = (n.slots!=="" && n.slots!=null) ? String(n.slots) : "";
  const ageStr   = (n.age!=="" && n.age!=null) ? String(n.age) : "";

  const payStr   = cleanPay(n.payMethod || n.pay);
  const deadlineStr = cleanDeadline(n.deadline);
  const targetStr = String(n.target||"").trim();

  const noteStr = String(n.note||"").trim();
  const summaryStr = String(n.summary||"").trim();
  const cancelStr  = String(n.cancel||"").trim();

  const hasSummary = !!summaryStr;
  const hasCancel  = !!cancelStr;
  const hasRight   = hasSummary || hasCancel;

  $("mTitle").textContent="ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°";
  $("mBody").innerHTML = `
    <div class="evCard">
      <div class="evName">${escapeHtml(n.title)}</div>
      <div class="evMeta">${escapeHtml(dateJP)} ${escapeHtml(timeStr)}</div>

      <div class="evLayout ${hasRight ? "" : "single"}">
        <div class="evLeft">
          ${n.place ? `<div class="evRow">å ´æ‰€ï¼š${escapeHtml(n.place)}</div>` : ``}
          ${priceStr ? `<div class="evRow">æ–™é‡‘ï¼š${escapeHtml(priceStr)}</div>` : ``}
          ${slotsStr ? `<div class="evRow">å‹Ÿé›†ï¼š${escapeHtml(slotsStr)}å</div>` : ``}
          ${ageStr ? `<div class="evRow">å¯¾è±¡å¹´é½¢ï¼š${escapeHtml(ageStr)}</div>` : ``}

          ${targetStr ? `<div class="evRow">å¯¾è±¡ï¼š${escapeHtml(targetStr)}</div>` : ``}
          ${deadlineStr ? `<div class="evRow">ã€†åˆ‡ï¼š${escapeHtml(deadlineStr)}</div>` : ``}
          ${payStr ? `<div class="evRow">æ”¯æ‰•æ–¹æ³•ï¼š${escapeHtml(payStr)}</div>` : ``}

          ${noteStr ? `<div class="evRow">ç¨®é¡ï¼š${escapeHtml(noteStr)}</div>` : ``}
        </div>

        ${
          hasRight
            ? `
              <div class="evRight">
                ${
                  hasSummary
                    ? `
                      <div class="summaryBox">
                        <p class="summaryTtl">æ¦‚è¦</p>
                        <div class="summaryText">${escapeHtml(summaryStr)}</div>
                      </div>
                    `
                    : ``
                }

                ${
                  hasCancel
                    ? `
                      <div class="summaryBox">
                        <p class="summaryTtl">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦</p>
                        <div class="summaryText">${escapeHtml(cancelStr)}</div>
                      </div>
                    `
                    : ``
                }
              </div>
            `
            : ``
        }
      </div>

      <div class="lineReserveBox">
        <div class="reserveForm" id="reserveFormBox">
          <p class="ttl">LINEäºˆç´„ï¼ˆå…¥åŠ›ã—ã¦ã‹ã‚‰é€ä¿¡ï¼‰</p>

          <input type="hidden" id="eventId" value="${escapeHtml(n.id)}">

          <div class="fgrid">
            <div class="fi">
              <label>ãŠåå‰</label>
              <input id="rfName" type="text" placeholder="ä¾‹ï¼šå±±ç”° èŠ±å­">
            </div>
            <div class="fi">
              <label>å¹´é½¢</label>
              <input id="rfAge" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š32">
            </div>
            <div class="fi">
              <label>é›»è©±ç•ªå·</label>
              <input id="rfTel" type="tel" inputmode="tel" placeholder="ä¾‹ï¼š09012345678">
            </div>
            <div class="fi">
              <label>ãŠä½ã¾ã„</label>
              <input id="rfArea" type="text" placeholder="ä¾‹ï¼šç§‹ç”°å¸‚">
            </div>
          </div>

          <div class="smallNote">
            â€»ã‚¹ãƒãƒ›ï¼šå…¬å¼LINEï¼ˆ${escapeHtml(LINE_TO)}ï¼‰ã®ãƒˆãƒ¼ã‚¯ãŒé–‹ãã€å…¥åŠ›æ¬„ã«äºˆç´„æ–‡ãŒå…¥ã‚Šã¾ã™ï¼ˆé€ä¿¡ã¯ã‚ãªãŸãŒè¡Œã„ã¾ã™ï¼‰ã€‚<br>
            â€»PCï¼šå‹ã ã¡è¿½åŠ ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚
          </div>

          <div class="formBtns">
            <a class="btnLike" id="btnLinePrefill" href="#">
              <span class="dot" style="width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-weight:900">LINE</span>
              LINEäºˆç´„ã‚’é–‹ã
            </a>
            <a class="btnLike secondary" href="${LINE_ADD_URL}" target="_blank" rel="noopener noreferrer">
              å‹ã ã¡è¿½åŠ ï¼ˆã¾ã ã®æ–¹ï¼‰
            </a>
          </div>

          <div class="warnText" id="rfWarn" style="display:none"></div>
          <div class="err" id="rfSaveErr" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  `;

  const btn = document.getElementById("btnLinePrefill");
  const warn = document.getElementById("rfWarn");
  const saveErr = document.getElementById("rfSaveErr");

  function updateActions(){
    const form = {
      name: (document.getElementById("rfName")?.value || "").trim(),
      age:  (document.getElementById("rfAge")?.value || "").trim(),
      tel:  (document.getElementById("rfTel")?.value || "").trim(),
      area: (document.getElementById("rfArea")?.value || "").trim(),
    };
    const msg = buildLinePrefillMessage(n, form);

    btn.onclick = async (ev)=>{
      ev.preventDefault();

      saveErr.textContent = "";
      try{
        const eventId = document.getElementById("eventId")?.value || "";
        if(eventId && form.tel){
          const res = await apiReserveUpsert({
            eventId,
            eventTitle: n.title,
            eventDate: n.date,
            eventTime: (n.timeFrom||n.timeTo) ? `${n.timeFrom||""}ã€œ${n.timeTo||""}` : (n.time||""),
            name: form.name,
            age: form.age,
            tel: form.tel,
            area: form.area,
            status: "pending"
          });
          if(res && res.ok === false){
            saveErr.textContent = "ï¼ˆå‚è€ƒï¼‰ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ã«å¤±æ•—ï¼š " + (res.error||"");
          }
        }
      }catch(e){
        saveErr.textContent = "ï¼ˆå‚è€ƒï¼‰ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ã«å¤±æ•—ï¼š " + (e.message||e);
      }

      openLineReserve(msg);
    };

    const missing = [];
    if(!form.name) missing.push("ãŠåå‰");
    if(!form.age)  missing.push("å¹´é½¢");
    if(!form.tel)  missing.push("é›»è©±ç•ªå·");
    if(!form.area) missing.push("ãŠä½ã¾ã„");

    if(missing.length){
      warn.style.display="block";
      warn.textContent = `æœªå…¥åŠ›ï¼š${missing.join(" / ")}ï¼ˆç©ºã§ã‚‚é€ã‚Œã¾ã™ãŒã€å…¥åŠ›ã™ã‚‹ã¨å—ä»˜ãŒæ—©ã„ã§ã™ï¼‰`;
    }else{
      warn.style.display="none";
      warn.textContent="";
    }
  }

  ["rfName","rfAge","rfTel","rfArea"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateActions);
  });
  updateActions();

  if(lastListDay){
    $("btnBackList").style.display="inline-flex";
  }else{
    $("btnBackList").style.display="none";
  }

  openModal();
}

function openEventById(id){
  const e = byId[String(id)];
  if(!e) return;
  renderEventDetail(e);
}

function openDayList(day){
  const evs = byDay[day] || [];
  lastListDay = day;

  $("mTitle").textContent = `${formatDateJP(day)} ã®ã‚¤ãƒ™ãƒ³ãƒˆ`;
  $("btnBackList").style.display="none";

  if(!evs.length){
    $("mBody").innerHTML = `<div class="meta">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    openModal();
    return;
  }

  $("mBody").innerHTML = evs.map(e=>{
    const n = normalizeEvent(e);
    const timeStr =
      (n.timeFrom || n.timeTo) ? `${n.timeFrom||""}ã€œ${n.timeTo||""}` :
      (n.time ? String(n.time) : "");

    const deadlineStr = cleanDeadline(n.deadline);
    const payStr = cleanPay(n.payMethod || n.pay);

    const sub = [
      timeStr ? `ğŸ•’ ${timeStr}` : "",
      n.place ? `ğŸ“ ${n.place}` : "",
      (n.priceM||n.priceF) ? `ğŸ’° ç”·${n.priceM||"-"} / å¥³${n.priceF||"-"}` : "",
      n.target ? `ğŸ¯ ${n.target}` : "",
      deadlineStr ? `â³ ã€†åˆ‡ ${deadlineStr}` : "",
      payStr ? `ğŸ’³ ${payStr}` : ""
    ].filter(Boolean).join("  ");

    return `
      <div class="evCard" style="cursor:pointer" data-open-eid="${escapeHtml(n.id)}">
        <div class="evName">${escapeHtml(n.title)}</div>
        ${sub ? `<div class="evMeta">${escapeHtml(sub)}</div>` : `<div class="evMeta"></div>`}
      </div>
    `;
  }).join("");

  $("mBody").querySelectorAll("[data-open-eid]").forEach(card=>{
    card.onclick = ()=>{
      const eid = card.dataset.openEid;
      $("btnBackList").style.display="inline-flex";
      openEventById(eid);
    };
  });

  openModal();
}
$("btnBackList").onclick = ()=>{ if(lastListDay) openDayList(lastListDay); };

/* ===========================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
=========================== */
function render(){
  const y=view.getFullYear(), m=view.getMonth();
  $("monthTitle").textContent=`${y}å¹´${m+1}æœˆ`;

  const first=new Date(y,m,1), last=new Date(y,m+1,0);
  const todayStr = `${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}-${pad(new Date().getDate())}`;

  let html="";
  for(let i=0;i<42;i++){
    const d=i-first.getDay()+1;
    const inM=d>0 && d<=last.getDate();
    const day=inM?`${y}-${pad(m+1)}-${pad(d)}`:"";
    const evs=inM?(byDay[day]||[]):[];

    let chips="";
    evs.slice(0,2).forEach(e=>{
      const n = normalizeEvent(e);
      const label = n.title; // ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿
      chips += `<div class="chip" data-eid="${escapeHtml(n.id)}" title="${escapeHtml(n.title)}">${escapeHtml(label)}</div>`;
    });
    if(evs.length>2){
      chips+=`<div class="moreBtn" data-day="${escapeHtml(day)}">+${evs.length-2}ä»¶</div>`;
    }

    const cls = ["day", inM?"":"muted", (day && day===todayStr)?"today":""].join(" ");
    html+=`<div class="${cls}"><div class="num">${inM?d:""}</div>${chips}</div>`;
  }

  $("grid").innerHTML=html;

  $("grid").querySelectorAll("[data-eid]").forEach(el=>{
    el.onclick=()=>{ lastListDay=null; openEventById(el.dataset.eid); };
  });
  $("grid").querySelectorAll("[data-day]").forEach(el=>{
    el.onclick=()=>{ openDayList(el.dataset.day); };
  });
}

/* ===========================
   æ“ä½œ
=========================== */
$("prev").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()-1,1);render()}
$("next").onclick=()=>{view=new Date(view.getFullYear(),view.getMonth()+1,1);render()}
$("btnReload").onclick=async()=>{await loadEvents();render()}

/* ===========================
   èµ·å‹•
=========================== */
(function initPolicy(){
  const el = document.getElementById("policyText");
  if(el) el.textContent = CANCEL_POLICY_TEXT;
})();

(async()=>{
  await loadEvents();
  render();
})();
</script>
</body>
</html>