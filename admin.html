<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px}

header{
  display:flex;justify-content:space-between;align-items:center;
  gap:12px;flex-wrap:wrap;padding-bottom:12px
}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 12px;border-radius:999px;cursor:pointer;
  font-size:12px; text-decoration:none; color:inherit;
  display:inline-flex;align-items:center;gap:6px;
}
.btn.primary{
  background:linear-gradient(135deg,var(--pri),var(--pri2));
  color:#fff;border:none;
}
.btn.danger{border-color:#fca5a5;color:#b91c1c}

.input{
  border:1px solid var(--line);
  padding:10px 12px;border-radius:999px;
  width:100%;
  font-size:13px;
  background:#fff;
}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:#b91c1c}
.list{display:flex;flex-direction:column;gap:10px}

.item{
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 14px;
  display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
}
.item .title{font-weight:800}
.item .subline{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.5}
.actions{display:flex;gap:8px;flex-wrap:wrap}

/* âœ… æŠ˜ã‚ŠãŸãŸã¿ï¼ˆdetails/summaryï¼‰ */
.evItem{
  border:1px solid var(--line);
  border-radius:14px;
  background:#fff;
}
.evSum{
  cursor:pointer;
  list-style:none;
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
  padding:12px 14px;
}
.evSum::-webkit-details-marker{display:none;}
.evHead{min-width:260px;flex:1}
.evHead .title{font-weight:800}
.evHead .subline{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.5}
.evChevron{
  flex:0 0 auto;
  font-size:12px;
  color:var(--muted);
  user-select:none;
  transform-origin:center;
  transition:transform .15s ease;
  margin-top:2px;
}
details[open] .evChevron{transform:rotate(180deg);}
.evBody{
  padding:0 14px 12px;
}
.evBodyInner{
  padding-top:10px;
  border-top:1px dashed var(--line);
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.evBodyLeft{min-width:260px;flex:1}
.evBodyActions{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}

/* âœ… æ–‡å­—ã‚’è¦‹ã‚„ã™ãæ•´ç†ï¼ˆè¿½è¨˜ï¼‰ */
.evMetaLine{
  font-size:12px;
  color:var(--muted);
  line-height:1.6;
  margin-top:6px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#fafbff;
  color:#334155;
  font-size:12px;
  white-space:nowrap;
}
.badge.pri{ border-color:rgba(79,124,255,.25); background:rgba(79,124,255,.08); color:#1f3b8f; }
.badge.ok{ border-color:rgba(45,212,191,.35); background:rgba(45,212,191,.10); color:#0f766e; }

.evSections{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.box{
  border:1px solid var(--line);
  background:#fff;
  border-radius:12px;
  padding:10px 12px;
}
.boxTitle{
  font-size:12px;
  color:var(--muted);
  font-weight:800;
  margin:0 0 6px 0;
  letter-spacing:.02em;
}
.boxText{
  font-size:13px;
  line-height:1.7;
  white-space:pre-wrap;
  word-break:break-word;
}
.kv{
  display:grid;
  grid-template-columns:88px 1fr;
  gap:6px 10px;
  font-size:13px;
  line-height:1.65;
}
.kv .k{ color:var(--muted); font-weight:700; }
.kv .v{ color:var(--text); }

.clamp{
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
details.longText summary{
  cursor:pointer;
  list-style:none;
  color:var(--pri);
  font-weight:800;
  font-size:12px;
  margin-top:6px;
}
details.longText summary::-webkit-details-marker{display:none;}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modalBack{
  position:fixed;inset:0;background:rgba(15,23,42,.35);
  display:none;align-items:center;justify-content:center;
  padding:18px; z-index:50;
}
.modal{
  width:min(860px,100%);
  background:#fff;border:1px solid var(--line);border-radius:18px;
  box-shadow:var(--shadow);
}
.modalHd{
  padding:12px 14px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;gap:10px;
}
.modalHd strong{font-size:14px}
.modalBd{padding:12px 14px}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
@media(max-width:900px){ .grid{grid-template-columns:1fr 1fr} }
@media(max-width:520px){ .grid{grid-template-columns:1fr} }
.fieldLabel{font-size:12px;color:var(--muted);margin:6px 0 6px}
.field{
  border:1px solid var(--line);
  padding:10px 12px;border-radius:12px;width:100%;
  font-size:13px;
}
textarea.field{border-radius:12px;min-height:78px;resize:vertical}
hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h1>
      <div class="sub">å…±æœ‰DBï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™</div>
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <a class="btn" id="linkPast" href="./past.html">éå»ã‚¤ãƒ™ãƒ³ãƒˆ</a>
    <a class="btn" id="linkParticipants" href="./participants/participants.html">å‚åŠ è€…ç®¡ç†</a>
    <a class="btn" id="linkCustomers" href="./customers/customers.html">é¡§å®¢ãƒã‚¹ã‚¿</a>

    <button class="btn" id="btnReload" type="button">æ›´æ–°</button>
    <button class="btn primary" id="btnNew" type="button">æ–°è¦ç™»éŒ²</button>
  </div>
</header>

<section class="card">
  <div class="hd">
    <strong>ç™»éŒ²æ¸ˆã¿ã‚¤ãƒ™ãƒ³ãƒˆ</strong>
    <span class="meta" id="count">-</span>
    <span class="meta" id="loadedAt">-</span>
  </div>
  <div class="bd">
    <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆåº—å/Discord/æ‹æ´»/æ¦‚è¦â€¦ï¼‰">
  </div>
</section>

<section class="card" style="margin-top:14px">
  <div class="bd">
    <div class="list" id="list"></div>
    <div class="err" id="err" style="margin-top:10px"></div>
  </div>
</section>

<!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ–°è¦/ç·¨é›†ï¼‰ ===== -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHd">
      <strong id="modalTitle">æ–°è¦ç™»éŒ²</strong>
      <button class="btn" id="btnClose" type="button">é–‰ã˜ã‚‹</button>
    </div>
    <div class="modalBd">
      <input type="hidden" id="eid">

      <div class="grid">

        <div>
          <div class="fieldLabel">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰</div>
          <input class="field" id="title" placeholder="ä¾‹ï¼‰æ‹æ´»">
        </div>
        <div>
          <div class="fieldLabel">æ—¥ä»˜ï¼ˆå¿…é ˆï¼‰</div>
          <input class="field" id="date" type="date">
        </div>
        <div>
          <div class="fieldLabel">å ´æ‰€</div>
          <input class="field" id="place" placeholder="ä¾‹ï¼‰Yellow Flag">
        </div>

        <div>
          <div class="fieldLabel">é–‹å§‹</div>
          <input class="field" id="timeFrom" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰1330" autocomplete="off">
        </div>
        <div>
          <div class="fieldLabel">çµ‚äº†</div>
          <input class="field" id="timeTo" type="text" inputmode="numeric" placeholder="ä¾‹ï¼‰1430" autocomplete="off">
        </div>
        <div>
          <div class="fieldLabel">ç¨®åˆ¥/ã‚¿ã‚°</div>
          <input class="field" id="note" placeholder="ä¾‹ï¼‰Discord / æ‹æ´»">
        </div>

        <div>
          <div class="fieldLabel">æ–™é‡‘ï¼ˆç”·æ€§ï¼‰</div>
          <input class="field" id="priceM" inputmode="numeric" placeholder="ä¾‹ï¼‰1000">
        </div>
        <div>
          <div class="fieldLabel">æ–™é‡‘ï¼ˆå¥³æ€§ï¼‰</div>
          <input class="field" id="priceF" inputmode="numeric" placeholder="ä¾‹ï¼‰500">
        </div>

        <div style="grid-column:1 / -1">
          <div class="fieldLabel">æ¦‚è¦</div>
          <textarea class="field" id="summary" placeholder="ä¾‹ï¼‰åˆå‚åŠ æ­“è¿ã€‚å°‘äººæ•°ã§ã‚†ã£ãã‚Šä¼šè©±ã€‚"></textarea>
        </div>

        <div>
          <div class="fieldLabel">ã€†åˆ‡ï¼ˆä»»æ„ï¼‰</div>
          <input class="field" id="deadline" type="date">
        </div>

        <div>
          <div class="fieldLabel">å¯¾è±¡ï¼ˆä¾‹ï¼šç‹¬èº«é™å®š / 30-45æ­³ ãªã©ï¼‰</div>
          <input class="field" id="target" placeholder="ä¾‹ï¼‰ç‹¬èº«é™å®š / 30ã€œ45æ­³ / åˆå‚åŠ æ­“è¿">
        </div>

        <div>
          <div class="fieldLabel">æ”¯æ‰•æ–¹æ³•</div>
          <input class="field" id="payMethod" placeholder="ä¾‹ï¼‰PayPay / ç¾é‡‘ / äº‹å‰æ±ºæ¸ˆ / å½“æ—¥æ‰•ã„">
        </div>

        <div style="grid-column:1 / -1">
          <div class="fieldLabel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦</div>
          <textarea class="field" id="cancelPolicy" placeholder="ä¾‹ï¼‰å‰æ—¥ã¾ã§ç„¡æ–™ï¼å½“æ—¥100%ï¼é€£çµ¡ãªã—100% ãªã©"></textarea>
        </div>
      </div>

      <hr class="sep">

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="btnSave" type="button">ä¿å­˜</button>
        <button class="btn danger" id="btnDelete" type="button" style="display:none">å‰Šé™¤</button>
        <span class="meta" id="status">-</span>
      </div>
    </div>
  </div>
</div>

<script>
/* â˜…ã‚ãªãŸã® /exec ã«å›ºå®š */
const API_URL = "https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const $ = (id)=>document.getElementById(id);

let events = [];

function setError(msg){ $("err").textContent = msg || ""; }
function setStatus(msg){ $("status").textContent = msg || "-"; }

async function fetchJson(url, opt){
  const res = await fetch(url, Object.assign({cache:"no-store"}, opt||{}));
  const j = await res.json().catch(()=> ({}));
  if(j && j.ok === false && j.error) throw new Error(j.error);
  return j;
}

/* ===== API ===== */
async function apiList(){
  const j = await fetchJson(API_URL + "?action=list");
  return j.events || [];
}
async function apiUpsert(ev){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"upsert", event: ev })
  });
}
async function apiDelete(id){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"delete", id })
  });
}

/* ===== é·ç§»ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ç¢ºå®Ÿã«é£›ã°ã™ï¼‰ ===== */
function forceNavigate(href){
  try{ window.location.assign(href); }
  catch(_){ window.location.href = href; }
}
function bindNav(id, href){
  const el = $(id);
  if(!el) return;
  el.addEventListener("click",(e)=>{ e.preventDefault(); forceNavigate(href); });
  el.addEventListener("auxclick",()=>forceNavigate(href));
}
bindNav("linkPast","./past.html");
bindNav("linkParticipants","./participants/participants.html");
bindNav("linkCustomers","./customers/customers.html");

/* ===== æ™‚åˆ»å…¥åŠ›ï¼š4æ¡â†’HH:mm ã«è‡ªå‹•æ•´å½¢ï¼‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹• ===== */
function digitsOnly(s){ return String(s||"").replace(/[^\d]/g,""); }
function toHHMMFromDigits(d){
  const x = digitsOnly(d).slice(0,4);
  if(x.length <= 2) return x;
  return x.slice(0,2) + ":" + x.slice(2,4);
}
function setValueKeepCaret(el, newVal){
  const start = el.selectionStart ?? newVal.length;
  const before = el.value;
  el.value = newVal;
  const delta = newVal.length - before.length;
  const pos = Math.max(0, Math.min(newVal.length, start + delta));
  try{ el.setSelectionRange(pos, pos); }catch(_){}
}
function bindTimeSmart(fromId, toId){
  const from = document.getElementById(fromId);
  const to = document.getElementById(toId);

  function onInput(el, nextEl){
    const raw = el.value;
    const formatted = toHHMMFromDigits(raw);
    if(formatted !== raw){
      setValueKeepCaret(el, formatted);
    }
    const dig = digitsOnly(el.value);
    if(dig.length >= 4 && nextEl){
      nextEl.focus();
    }
  }

  from.addEventListener("input", ()=>onInput(from,to));
  to.addEventListener("input", ()=>onInput(to,null));

  function onBlur(el){
    const dig = digitsOnly(el.value);
    if(dig.length === 4){
      el.value = dig.slice(0,2) + ":" + dig.slice(2,4);
    }else if(dig.length === 0){
      el.value = "";
    }
  }
  from.addEventListener("blur", ()=>onBlur(from));
  to.addEventListener("blur", ()=>onBlur(to));
}
bindTimeSmart("timeFrom","timeTo");

function normalizeTimeField(id){
  const el = document.getElementById(id);
  const dig = digitsOnly(el.value);
  if(dig.length === 4) return dig.slice(0,2)+":"+dig.slice(2,4);
  const s = String(el.value||"").trim();
  if(/^\d{1,2}:\d{2}$/.test(s)){
    const [h,m]=s.split(":");
    return String(Number(h)).padStart(2,"0")+":"+m;
  }
  return s;
}

/* âœ… ä¸¦ã³æ›¿ãˆç”¨ï¼ˆé–‹å‚¬æ—¥ãŒè¿‘ã„é †ï¼‰ */
function toDateSafe(dateStr, timeStr){
  if(!dateStr) return null;
  const s = String(dateStr).trim().replaceAll("/", "-");

  // timeStr ãŒ "10:00ã€œ12:00" ãªã©ã§ã‚‚å…ˆé ­ã ã‘æ‹¾ã†
  let t = (timeStr && String(timeStr).includes(":")) ? String(timeStr).trim() : "00:00";
  if(t.includes("ã€œ") || t.includes("-") || t.includes("â€“")){
    const first = t.split("ã€œ")[0].split("-")[0].split("â€“")[0].trim();
    if(first) t = first;
  }

  const d = new Date(`${s}T${t}:00`);
  if (isNaN(d.getTime())) return null;
  return d;
}
function sortBySoonest(a, b){
  const da = toDateSafe(a.date, (a.timeFrom||a.time||""));
  const db = toDateSafe(b.date, (b.timeFrom||b.time||""));
  if(!da && !db) return 0;
  if(!da) return 1;
  if(!db) return -1;
  const diff = da - db;
  if(diff !== 0) return diff;
  return String(a.title||"").localeCompare(String(b.title||""));
}

/* ===== UI ===== */
function openModal(mode, ev){
  $("modalBack").style.display="flex";
  $("modalBack").setAttribute("aria-hidden","false");
  setStatus("-"); setError("");

  if(mode==="new"){
    $("modalTitle").textContent="æ–°è¦ç™»éŒ²";
    $("eid").value="";
    $("title").value="";
    $("date").value="";
    $("timeFrom").value="";
    $("timeTo").value="";
    $("place").value="";
    $("priceM").value="";
    $("priceF").value="";
    $("note").value="";

    $("summary").value="";

    $("deadline").value="";
    $("target").value="";
    $("payMethod").value="";
    $("cancelPolicy").value="";

    $("btnDelete").style.display="none";
  }else{
    $("modalTitle").textContent="ç·¨é›†";
    $("eid").value=ev.id||"";
    $("title").value=ev.title||"";
    $("date").value=toDateValue(ev.date);

    const t = String(ev.time||"");
    const m = t.match(/(\d{1,2}:\d{2})\s*[ã€œ\-â€“]\s*(\d{1,2}:\d{2})/);

    $("timeFrom").value = (ev.timeFrom || (m ? m[1] : "")) || "";
    $("timeTo").value   = (ev.timeTo   || (m ? m[2] : "")) || "";
    $("place").value=ev.place||"";
    $("priceM").value=ev.priceM||"";
    $("priceF").value=ev.priceF||"";
    $("note").value=ev.note||"";

    $("summary").value = ev.summary || ev.memo || "";

    $("deadline").value = toDateValue(ev.deadline);
    $("target").value = ev.target || "";
    $("payMethod").value = ev.payMethod || ev.pay || "";
    $("cancelPolicy").value = ev.cancelPolicy || "";

    $("btnDelete").style.display="inline-flex";
  }
}
function closeModal(){
  $("modalBack").style.display="none";
  $("modalBack").setAttribute("aria-hidden","true");
}
$("btnClose").onclick = closeModal;
$("modalBack").addEventListener("click",(e)=>{
  if(e.target === $("modalBack")) closeModal();
});

$("btnNew").onclick = ()=> openModal("new");
$("btnReload").onclick = ()=> location.reload();

function toDateValue(v){
  if(!v) return "";
  try{
    const d = (v instanceof Date) ? v : new Date(v);
    if(Number.isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }catch(e){ return ""; }
}
function fmtDateJa(v){
  if(!v) return "-";
  const d = (v instanceof Date) ? v : new Date(v);
  if(Number.isNaN(d.getTime())) return String(v);
  const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
  return `${y}å¹´${m}æœˆ${dd}æ—¥`;
}
function fmtMoney(v){ return (v===0 || v==="0" || v) ? String(v) : "-"; }

/* âœ… ç›´è¿‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’è‡ªå‹•ã§é–‹ãã‹ï¼ˆä»»æ„ï¼‰ */
const AUTO_OPEN_SOON_EVENTS = true;
const AUTO_OPEN_SOON_DAYS = 7; // ä¾‹ï¼š7æ—¥ä»¥å†…ã¯é–‹ã

function isSoonEvent(ev){
  const d = toDateSafe(ev.date, ev.timeFrom || ev.time || "");
  if(!d) return false;
  const now = new Date();
  const diffDays = (d - now) / (1000*60*60*24);
  return diffDays >= -1 && diffDays <= AUTO_OPEN_SOON_DAYS;
}

function render(){
  const q = $("q").value.trim();

  // âœ… é–‹å‚¬æ—¥ãŒè¿‘ã„é †ã«è‡ªå‹•ã‚½ãƒ¼ãƒˆ
  const sorted = [...events].sort(sortBySoonest);

  const list = q
    ? sorted.filter(e=>{
        const s = `${e.title||""} ${e.place||""} ${e.note||""} ${e.summary||e.memo||""} ${e.target||""} ${e.payMethod||e.pay||""} ${e.deadline||""} ${e.cancelPolicy||""}`.toLowerCase();
        return s.includes(q.toLowerCase());
      })
    : sorted;

  $("count").textContent = `è¡¨ç¤º ${list.length}ä»¶ / å…¨${events.length}ä»¶`;

  if(!list.length){
    $("list").innerHTML = `<div class="meta">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  $("list").innerHTML = list.map(e=>{
    const payTxt = e.payMethod || e.pay || "";
    const targetTxt = e.target || "";
    const cancelTxt = e.cancelPolicy || "";
    const deadlineTxt = e.deadline ? fmtDateJa(e.deadline) : "";
    const summaryTxt = String(e.summary || e.memo || "").trim();

    const openAttr = (AUTO_OPEN_SOON_EVENTS && isSoonEvent(e)) ? " open" : "";
    const isLong = summaryTxt.length > 140 || summaryTxt.split("\n").length >= 4;

    return `
    <details class="evItem"${openAttr}>
      <summary class="evSum">
        <div class="evHead">
          <div class="title">${escapeHtml(fmtDateJa(e.date))}ï½œ${escapeHtml(e.title||"-")}</div>

          <div class="evMetaLine">
            <span class="badge pri">ğŸ•’ ${escapeHtml(e.timeFrom||"-")}ã€œ${escapeHtml(e.timeTo||"-")}</span>
            <span class="badge">ğŸ’° ç”· ${escapeHtml(fmtMoney(e.priceM))} / å¥³ ${escapeHtml(fmtMoney(e.priceF))}</span>
            ${e.place ? `<span class="badge ok">ğŸ“ ${escapeHtml(e.place)}</span>` : ``}
            ${e.note ? `<span class="badge">ğŸ·ï¸ ${escapeHtml(e.note)}</span>` : ``}
          </div>
        </div>
        <div class="evChevron">â–¼</div>
      </summary>

      <div class="evBody">
        <div class="evBodyInner">
          <div class="evBodyLeft">

            <div class="evSections">
              <div class="box">
                <p class="boxTitle">æ¦‚è¦</p>
                ${
                  !summaryTxt
                    ? `<div class="boxText" style="color:var(--muted)">æœªè¨­å®š</div>`
                    : (
                        !isLong
                          ? `<div class="boxText">${escapeHtml(summaryTxt)}</div>`
                          : `
                            <div class="boxText clamp">${escapeHtml(summaryTxt)}</div>
                            <details class="longText">
                              <summary>å…¨æ–‡ã‚’è¡¨ç¤º</summary>
                              <div class="boxText" style="margin-top:8px">${escapeHtml(summaryTxt)}</div>
                            </details>
                          `
                      )
                }
              </div>

              <div class="box">
                <p class="boxTitle">æ¡ä»¶</p>
                <div class="kv">
                  ${deadlineTxt ? `<div class="k">ã€†åˆ‡</div><div class="v">${escapeHtml(deadlineTxt)}</div>` : ``}
                  ${targetTxt ? `<div class="k">å¯¾è±¡</div><div class="v">${escapeHtml(targetTxt)}</div>` : ``}
                  ${payTxt ? `<div class="k">æ”¯æ‰•</div><div class="v">${escapeHtml(payTxt)}</div>` : ``}
                  ${cancelTxt ? `<div class="k">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div><div class="v">${escapeHtml(cancelTxt)}</div>` : ``}
                  ${(!deadlineTxt && !targetTxt && !payTxt && !cancelTxt) ? `<div class="v" style="grid-column:1/-1;color:var(--muted)">æœªè¨­å®š</div>` : ``}
                </div>
              </div>
            </div>

          </div>

          <div class="evBodyActions">
            <button class="btn" data-edit="${escapeHtml(e.id)}" type="button">ç·¨é›†</button>
            <button class="btn" data-copy="${escapeHtml(e.id)}" type="button">ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>
      </div>
    </details>
    `;
  }).join("");

  document.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick = ()=>{
      const ev = events.find(x=>String(x.id)===String(b.dataset.edit));
      if(ev) openModal("edit", ev);
    };
  });

  document.querySelectorAll("[data-copy]").forEach(b=>{
    b.onclick = ()=>{
      const ev = events.find(x=>String(x.id)===String(b.dataset.copy));
      if(!ev) return;
      openModal("new");
      $("title").value = ev.title||"";
      $("date").value = toDateValue(ev.date);
      $("timeFrom").value = ev.timeFrom||"";
      $("timeTo").value = ev.timeTo||"";
      $("place").value = ev.place||"";
      $("priceM").value = ev.priceM||"";
      $("priceF").value = ev.priceF||"";
      $("note").value = ev.note||"";

      $("summary").value = ev.summary || ev.memo || "";

      $("deadline").value = toDateValue(ev.deadline);
      $("target").value = ev.target || "";
      $("payMethod").value = ev.payMethod || ev.pay || "";
      $("cancelPolicy").value = ev.cancelPolicy || "";
    };
  });
}

$("q").oninput = render;

/* ===== ä¿å­˜/å‰Šé™¤ï¼ˆä¿å­˜å¾Œã«å¿…ãš list å†å–å¾—ï¼‰ ===== */
async function refreshList(){
  events = await apiList();

  // âœ… å¸¸ã«è¿‘ã„é †ã§ä¿æŒ
  events.sort(sortBySoonest);

  $("loadedAt").textContent = "èª­ã¿è¾¼ã¿ï¼š" + new Date().toLocaleString("ja-JP");
  render();
}

$("btnSave").onclick = async ()=>{
  setError("");
  try{
    const title = $("title").value.trim();
    const date  = $("date").value;
    if(!title){ alert("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™"); return; }
    if(!date){ alert("æ—¥ä»˜ã¯å¿…é ˆã§ã™"); return; }

    setStatus("ä¿å­˜ä¸­â€¦");

    const tFrom = normalizeTimeField("timeFrom");
    const tTo   = normalizeTimeField("timeTo");
    const timeSingle = (tFrom && tTo) ? `${tFrom}ã€œ${tTo}` : (tFrom || "");

    const ev = {
      id: $("eid").value.trim(),
      title,
      date,
      timeFrom: tFrom,
      timeTo: tTo,
      time: timeSingle,

      place: $("place").value.trim(),
      priceM: $("priceM").value.trim(),
      priceF: $("priceF").value.trim(),
      note: $("note").value.trim(),

      summary: $("summary").value.trim(),

      deadline: $("deadline").value || "",
      target: $("target").value.trim(),
      payMethod: $("payMethod").value.trim(),
      cancelPolicy: $("cancelPolicy").value.trim()
    };

    await apiUpsert(ev);
    await refreshList();

    setStatus("ä¿å­˜ã—ã¾ã—ãŸ");
    closeModal();
  }catch(err){
    setStatus("-");
    setError("ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};

$("btnDelete").onclick = async ()=>{
  setError("");
  const id = $("eid").value.trim();
  if(!id) return;
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try{
    setStatus("å‰Šé™¤ä¸­â€¦");
    await apiDelete(id);
    await refreshList();

    setStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
    closeModal();
  }catch(err){
    setStatus("-");
    setError("å‰Šé™¤ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};

function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* ===== èµ·å‹• ===== */
(async()=>{
  try{
    setError("");
    await refreshList();
  }catch(err){
    setError("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err.message || err));
  }
})();
</script>

</body>
</html>