<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --line: #e5e7eb;
      --pri: #4f7cff;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
      --danger:#ef4444;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", sans-serif;
      padding: 20px;
    }

    header{
      max-width:1100px;
      margin:0 auto 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    h1 {
      text-align: center;
      font-size: 24px;
      margin: 0;
      flex:1;
    }

    .topRight{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      gap:6px;
      user-select:none;
    }
    .btn.primary{
      background: var(--pri);
      color:#fff;
      border:1px solid var(--pri);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .meta{
      max-width:1100px;
      margin:0 auto 12px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .err{
      max-width:1100px;
      margin:0 auto 12px;
      font-size:12px;
      color:#b91c1c;
      white-space:pre-wrap;
    }

    .toolbar{
      max-width:1100px;
      margin:0 auto 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#334155;
      font-size:12px;
      line-height:1;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .badge.active{
      border-color:rgba(79,124,255,.55);
      box-shadow: 0 0 0 3px rgba(79,124,255,.15);
    }
    .badge.type-all{ background:#fff; }
    .badge.type-event{
      border-color:rgba(99,102,241,.35);
      background:rgba(99,102,241,.10);
      color:#3730a3;
    }
    .badge.type-consulting{
      border-color:rgba(16,185,129,.35);
      background:rgba(16,185,129,.10);
      color:#065f46;
    }
    .badge.type-other{
      border-color:rgba(245,158,11,.35);
      background:rgba(245,158,11,.12);
      color:#92400e;
    }

    .sortBox{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .select{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      outline:none;
    }

    .campaign-list{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      gap:16px;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      justify-content:center;
    }

    .campaign-card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border:1px solid rgba(0,0,0,0.03);
      max-width: 360px;
      margin: 0 auto;
      width: 100%;
    }

    .thumb{
      width: 100%;
      height: 180px;
      background:#eef2ff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      position:relative;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .noimg{ padding:10px; }

    .campaign-card .content { padding: 16px; }

    .titleRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin:0 0 8px;
    }
    .campaign-card h2 {
      font-size: 18px;
      margin: 0;
      line-height:1.3;
      flex:1;
      min-width:0;
      word-break:break-word;
    }
    .cardTypeBadge{ flex:0 0 auto; cursor:default; }

    .campaign-card p {
      margin: 0 0 8px;
      color: var(--muted);
      line-height:1.6;
    }

    .campaign-card .period {
      font-size: 14px;
      color: var(--pri);
      margin-bottom:10px;
    }

    .campaign-card a {
      display: inline-block;
      padding: 8px 12px;
      background: var(--pri);
      color: #fff;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
    }

    #modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding:18px;
    }

    #modalContent {
      background: #fff;
      padding: 20px;
      max-width: 680px;
      width: 100%;
      border-radius: 12px;
      position: relative;
      box-shadow: var(--shadow);
      max-height: 90vh;
      overflow:auto;
    }

    #modalContent h2 { margin-top: 0; margin-bottom: 6px; }

    #modalContent p {
      margin-top: 10px;
      line-height:1.7;
      white-space:pre-wrap;
      word-break:break-word;
    }

    #modalContent button.closeBtn {
      position: sticky;
      top: 0;
      float:right;
      background: #eee;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      cursor: pointer;
    }

    .kv{
      margin-top:10px;
      border-top:1px solid var(--line);
      padding-top:10px;
      font-size:14px;
    }
    .kvRow{
      display:flex;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed var(--line);
    }
    .kvRow:last-child{border-bottom:none}
    .k{width:90px;color:var(--muted);font-weight:700;flex:0 0 auto}
    .v{flex:1}
    .v a{color:var(--pri)}

    .detailModal .heroImg{
      width: 100%;
      max-height: 320px;
      object-fit: contain;
      display: block;
      margin: 10px auto 0;
      border-radius: 14px;
    }
  </style>
</head>
<body>

<header>
  <h1>é–‹å‚¬ä¸­ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä¸€è¦§</h1>
  <div class="topRight">
    <button class="btn primary" id="btnReload" type="button">æ›´æ–°</button>
  </div>
</header>

<div class="meta">
  <div id="count">-</div>
  <div id="loadedAt">-</div>
</div>
<div class="err" id="err"></div>

<div class="toolbar">
  <div class="chips" id="typeChips">
    <span class="badge type-all active" data-type="all">ã™ã¹ã¦</span>
    <span class="badge type-event" data-type="event">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
    <span class="badge type-consulting" data-type="consulting">ç›¸è«‡æ‰€</span>
    <span class="badge type-other" data-type="other">ãã®ä»–</span>
  </div>

  <div class="sortBox">
    <span>ä¸¦ã³æ›¿ãˆ</span>
    <select class="select" id="sortSel">
      <option value="soonest">é–‹å§‹æ—¥ï¼ˆè¿‘ã„é †ï¼‰</option>
      <option value="type">ç¨®é¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆâ†’ç›¸è«‡æ‰€â†’ãã®ä»–ï¼‰</option>
    </select>
  </div>
</div>

<div class="campaign-list" id="campaignList">
  <div style="color:#6b7280">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>

<div id="modal" onclick="if(event.target.id==='modal') closeModal();">
  <div id="modalContent" class="detailModal">
    <button class="closeBtn" onclick="closeModal()">Ã—</button>
    <h2 id="modalTitle"></h2>
    <p id="modalPeriod" style="color:#4f7cff;font-size:14px;margin:0 0 10px;"></p>
    <div id="modalImageWrap"></div>
    <p id="modalDetails"></p>

    <div class="kv" id="modalKV" style="display:none">
      <div class="kvRow" id="rowConditions" style="display:none">
        <div class="k">æ¡ä»¶</div><div class="v" id="modalConditions"></div>
      </div>
      <div class="kvRow" id="rowLink" style="display:none">
        <div class="k">ãƒªãƒ³ã‚¯</div><div class="v" id="modalLink"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbwiSMKMDvHIZ2l8hs9ogCPLKmX6eNPpn5jKDvHbMxwFbqVw7zGLFZIcarAsmO88D_L4/exec";
  const $ = (id)=>document.getElementById(id);

  // ç”»é¢ã«ã€ŒJSã‚¨ãƒ©ãƒ¼ã€ã‚’å‡ºã™ï¼ˆçœŸã£ç™½å¯¾ç­–ï¼‰
  window.addEventListener("error", (ev)=>{
    try{
      const msg = (ev && ev.message) ? ev.message : "unknown error";
      $("err").textContent = "JSã‚¨ãƒ©ãƒ¼: " + msg;
    }catch(_){}
  });

  let campaigns = [];
  let typeFilter = "all";
  let sortMode = "soonest";

  // âœ… å³è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  const CACHE_KEY = "campaign_list_cache_v1";
  const CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6æ™‚é–“

  function setError(msg){ $("err").textContent = msg || ""; }

  function str(v){
    if(v === null || v === undefined) return "";
    if(typeof v === "string") return v;
    try{ return String(v); }catch(_){ return ""; }
  }

  function escapeHtml(s){
    return str(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  // replaceAll ã‚’ä½¿ã‚ãªã„ï¼ˆSafariã§è½ã¡ã‚‹ã®ã‚’é˜²ãï¼‰
  function normalizeDateStr_(s){
    return str(s).trim().replace(/\//g, "-");
  }

  async function fetchJson(url, opt){
    const res = await fetch(url, Object.assign({
      cache:"no-store",
      redirect:"follow",
    }, opt || {}));

    const text = await res.text();
    if(!res.ok){
      throw new Error("HTTP " + res.status + " " + res.statusText + "\n" + text.slice(0,600));
    }
    let j;
    try{ j = JSON.parse(text); }
    catch(_){ throw new Error("JSONã§ã¯ãªã„å¿œç­”ï¼ˆHTMLç­‰ï¼‰:\n" + text.slice(0,600)); }
    if(j && j.ok === false && j.error) throw new Error(j.error);
    return j;
  }

  async function apiList(){
    const j = await fetchJson(API_URL + "?action=list_campaigns&t=" + Date.now());
    return j.campaigns || [];
  }

  function toDateSafe(dateStr){
    const s = normalizeDateStr_(dateStr);
    if(!s) return null;
    const d = new Date(s + "T00:00:00");
    if(isNaN(d.getTime())) return null;
    return d;
  }

  function fmtDateJa(v){
    const s = str(v).trim();
    if(!s) return "-";
    const d = (v instanceof Date) ? v : new Date(s);
    if(isNaN(d.getTime())) return s;
    const y=d.getFullYear(), m=d.getMonth()+1, dd=d.getDate();
    return y + "å¹´" + m + "æœˆ" + dd + "æ—¥";
  }

  function linkify_(text){
    const s = str(text || "");
    const escaped = escapeHtml(s);
    const urlRe = /https?:\/\/[^\s<>"']+/g;

    return escaped.replace(urlRe, (url)=>{
      const m = url.match(/^(.*?)([)\]\}.,ã€ã€‚]+)?$/);
      const clean = m ? m[1] : url;
      const tail  = (m && m[2]) ? m[2] : "";
      return '<a href="' + clean + '" target="_blank" rel="noopener noreferrer">' + clean + "</a>" + tail;
    });
  }

  function typeNorm(t){
    const v = str(t).trim().toLowerCase();
    if(v === "event") return "event";
    if(v === "consulting") return "consulting";
    return "other";
  }
  function typeLabel(t){
    const v = typeNorm(t);
    if(v === "event") return "ã‚¤ãƒ™ãƒ³ãƒˆ";
    if(v === "consulting") return "ç›¸è«‡æ‰€";
    return "ãã®ä»–";
  }
  function typeBadgeClass(t){
    const v = typeNorm(t);
    if(v === "event") return "type-event";
    if(v === "consulting") return "type-consulting";
    return "type-other";
  }
  function typeOrder(t){
    const v = typeNorm(t);
    if(v === "event") return 0;
    if(v === "consulting") return 1;
    return 2;
  }

  function isActiveCampaign(c){
    const st = str(c.status).toLowerCase().trim();
    if(st === "hidden") return false;
    if(st === "ended") return false;

    const sd = toDateSafe(c.startDate);
    const ed = toDateSafe(c.endDate);
    if(!sd || !ed) return true;

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return (sd <= today && today <= ed);
  }

  function sortBySoonest(a,b){
    const da = toDateSafe(a.startDate);
    const db = toDateSafe(b.startDate);
    if(!da && !db) return 0;
    if(!da) return 1;
    if(!db) return -1;
    const diff = da - db;
    if(diff !== 0) return diff;
    return str(a.title).localeCompare(str(b.title));
  }

  function sortByTypeThenDate(a,b){
    const ta = typeOrder(a.type);
    const tb = typeOrder(b.type);
    if(ta !== tb) return ta - tb;
    return sortBySoonest(a,b);
  }

  function buildPeriod(c){
    return fmtDateJa(c.startDate) + "ã€œ" + fmtDateJa(c.endDate);
  }

  function getImageSrc(c){
    const d = str(c.imageData).trim();
    if(d && d.indexOf("data:image") === 0) return d;
    const u = str(c.imageUrl).trim();
    if(u) return u;
    return "";
  }

  function imgTag(src, alt){
    return '<img loading="lazy" src="' + src + '" alt="' + escapeHtml(alt) + '"' +
      ' onerror="this.closest(\\\'.thumb\\\') && (this.closest(\\\'.thumb\\\').innerHTML=\\\'<div class=&quot;noimg&quot;>ç”»åƒãªã—</div>\\\');">';
  }

  function getActiveList(){
    let active = campaigns.filter(isActiveCampaign);

    if(typeFilter !== "all"){
      active = active.filter(c => typeNorm(c.type) === typeFilter);
    }

    if(sortMode === "type") active.sort(sortByTypeThenDate);
    else active.sort(sortBySoonest);

    return active;
  }

  function render(){
    const container = $("campaignList");
    if(!container) return;
    container.innerHTML = "";

    const active = getActiveList();
    const activeAll = campaigns.filter(isActiveCampaign).length;
    const filterLabel = (typeFilter === "all") ? "ã™ã¹ã¦" : typeLabel(typeFilter);
    $("count").textContent = "è¡¨ç¤º " + active.length + "ä»¶ï¼ˆ" + filterLabel + "ï¼‰ / é–‹å‚¬ä¸­" + activeAll + "ä»¶ / å…¨" + campaigns.length + "ä»¶";

    if(!active.length){
      container.innerHTML = '<div style="color:#6b7280">ç¾åœ¨ã€é–‹å‚¬ä¸­ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    active.forEach((c, index)=>{
      const img = getImageSrc(c);
      const title = str(c.title).trim() || "ï¼ˆç„¡é¡Œï¼‰";
      const desc = str(c.shortDesc).trim() || str(c.details).trim() || "";
      const period = buildPeriod(c);

      const tCls = typeBadgeClass(c.type);
      const tLbl = typeLabel(c.type);

      const card = document.createElement("div");
      card.className = "campaign-card";

      const thumbHtml = img
        ? '<div class="thumb">' + imgTag(img, title) + "</div>"
        : '<div class="thumb"><div class="noimg">ç”»åƒãªã—</div></div>';

      card.innerHTML =
        thumbHtml +
        '<div class="content">' +
          '<div class="titleRow">' +
            "<h2>" + escapeHtml(title) + "</h2>" +
            '<span class="badge ' + tCls + ' cardTypeBadge">ğŸ·ï¸ ' + escapeHtml(tLbl) + "</span>" +
          "</div>" +
          "<p>" + escapeHtml(desc) + "</p>" +
          '<p class="period">' + escapeHtml(period) + "</p>" +
          '<a href="#" data-open="' + index + '">è©³ã—ãè¦‹ã‚‹</a>' +
        "</div>";

      container.appendChild(card);
    });

    container.querySelectorAll("[data-open]").forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        const idx = Number(a.getAttribute("data-open"));
        openModalByIndex(idx);
      });
    });
  }

  function openModalByIndex(activeIndex){
    const active = getActiveList();
    const c = active[activeIndex];
    if(!c) return;

    $("modalTitle").innerText = str(c.title).trim();
    $("modalPeriod").innerText = buildPeriod(c);

    const img = getImageSrc(c);
    $("modalImageWrap").innerHTML = img ? '<img class="heroImg" src="' + img + '" alt="">' : "";

    const details = str(c.details).trim() || str(c.shortDesc).trim();
    $("modalDetails").innerHTML = linkify_(details || "ï¼ˆè©³ç´°ã¯æº–å‚™ä¸­ã§ã™ï¼‰");

    const conditions = str(c.conditions).trim();
    const link = str(c.link).trim();

    const showKV = !!(conditions || link);
    $("modalKV").style.display = showKV ? "block" : "none";

    $("rowConditions").style.display = conditions ? "flex" : "none";
    $("modalConditions").innerText = conditions;

    $("rowLink").style.display = link ? "flex" : "none";
    $("modalLink").innerHTML = link
      ? '<a href="' + escapeHtml(link) + '" target="_blank" rel="noopener">' + escapeHtml(link) + "</a>"
      : "";

    $("modal").style.display = "flex";
  }

  function closeModal() {
    $("modal").style.display = "none";
  }
  window.closeModal = closeModal;

  function bindTypeChips(){
    const chips = document.querySelectorAll("#typeChips [data-type]");
    chips.forEach(chip=>{
      chip.addEventListener("click", ()=>{
        typeFilter = str(chip.getAttribute("data-type")).trim() || "all";
        chips.forEach(x=>x.classList.remove("active"));
        chip.classList.add("active");
        render();
      });
    });
  }

  $("sortSel").addEventListener("change", ()=>{
    sortMode = str($("sortSel").value).trim() || "soonest";
    render();
  });

  function loadCacheAndRender_(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      const ts = Number(obj.ts || 0);
      const list = Array.isArray(obj.campaigns) ? obj.campaigns : null;
      if(!list || !ts) return false;

      campaigns = list;
      render();

      const ageMin = Math.floor((Date.now() - ts)/60000);
      $("loadedAt").textContent = "è¡¨ç¤ºï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ" + ageMin + "åˆ†å‰ï¼‰";
      return true;
    }catch(_){
      return false;
    }
  }

  function saveCache_(){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), campaigns }));
    }catch(_){}
  }

  async function refresh({silent=false} = {}){
    if(!silent){
      setError("");
      $("btnReload").disabled = true;
      $("btnReload").textContent = "æ›´æ–°ä¸­â€¦";
    }

    try{
      const list = await apiList();
      campaigns = list || [];
      saveCache_();
      $("loadedAt").textContent = "èª­ã¿è¾¼ã¿ï¼š" + new Date().toLocaleString("ja-JP");
      render();
      setError("");
    }catch(err){
      const msg = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err && err.message ? err.message : err);
      setError(msg);

      if(!campaigns.length){
        $("campaignList").innerHTML = '<div style="color:#6b7280">èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ›´æ–°ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>';
      }
    }finally{
      if(!silent){
        $("btnReload").disabled = false;
        $("btnReload").textContent = "æ›´æ–°";
      }
    }
  }

  $("btnReload").addEventListener("click", ()=>refresh({silent:false}));

  // èµ·å‹•ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥å³è¡¨ç¤º â†’ è£ã§å–å¾—
  bindTypeChips();
  const hasCache = loadCacheAndRender_();
  if(!hasCache){
    $("campaignList").innerHTML = '<div style="color:#6b7280">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
    $("loadedAt").textContent = "èª­ã¿è¾¼ã¿ï¼šé–‹å§‹â€¦";
  } else {
    // å¸¸ã«è£æ›´æ–°ï¼ˆå³è¡¨ç¤ºã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ‹…å½“ï¼‰
    refresh({silent:true});
  }
})();
</script>

</body>
</html>