<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é¡§å®¢ãƒã‚¹ã‚¿</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 10px;border-radius:10px;cursor:pointer;
  font-size:12px;
  text-decoration:none;color:inherit;display:inline-flex;align-items:center;gap:6px;
}
.btn.primary{
  background:linear-gradient(135deg,var(--pri),var(--pri2));
  color:#fff;border:none;
}
.btn.danger{border-color:#fca5a5;color:#b91c1c}
.input{
  border:1px solid var(--line);
  padding:8px 10px;
  border-radius:10px;
  width:100%;
  background:#fff;
}
.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{font-size:12px;color:#b91c1c}
.list{display:flex;flex-direction:column;gap:10px}

.row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media(max-width:800px){ .row{grid-template-columns:1fr 1fr} }
@media(max-width:480px){ .row{grid-template-columns:1fr} }

.item{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.item .title{font-weight:800}
.item .subline{font-size:12px;color:var(--muted);margin-top:4px}
.actions{display:flex;gap:6px;flex-wrap:wrap}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.modalBack{
  position:fixed;inset:0;background:rgba(15,23,42,.35);
  display:none;align-items:center;justify-content:center;
  padding:18px; z-index:50;
}
.modal{
  width:min(920px,100%);
  background:#fff;border:1px solid var(--line);border-radius:18px;
  box-shadow:var(--shadow);
}
.modalHd{
  padding:12px 14px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
}
.modalBd{padding:12px 14px}

/* =========================
   âœ… ç”·å¥³ã‚¿ãƒ–ï¼ˆè¿½è¨˜ï¼‰
========================= */
.tabRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.tabBtn{
  border:1px solid var(--line);
  background:#fff;
  padding:8px 10px;
  border-radius:999px;
  cursor:pointer;
  font-weight:900;
  font-size:12px;
}
.tabBtn.on{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;border:none}
.tabCnt{font-size:11px;color:var(--muted);font-weight:800}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>é¡§å®¢ãƒã‚¹ã‚¿</h1>
      <div class="sub">å‚åŠ è€…ã®åŸºæœ¬æƒ…å ±ã‚’ç®¡ç†ã—ã¾ã™</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn" href="../admin.html">ç®¡ç†ã¸æˆ»ã‚‹</a>
    <a class="btn" href="../participants/participants.html">å‚åŠ è€…ç®¡ç†</a>
    <button class="btn primary" id="btnNew" type="button">æ–°è¦ç™»éŒ²</button>
  </div>
</header>

<section class="card">
  <div class="hd">
    <strong>é¡§å®¢ä¸€è¦§</strong>
    <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆåå‰/é€£çµ¡å…ˆï¼‰" style="max-width:240px">
    <span class="meta" id="count">-</span>
    <span class="meta" id="status">-</span>
    <span class="err" id="err"></span>
  </div>
  <div class="bd">

    <!-- âœ… ç”·å¥³ã‚¿ãƒ–ï¼ˆè¿½è¨˜ï¼‰ -->
    <div class="tabRow">
      <button class="tabBtn on" id="tabAll" type="button">å…¨ã¦ <span class="tabCnt" id="tabCntAll">(0)</span></button>
      <button class="tabBtn" id="tabM" type="button">ğŸ‘¨ ç”·æ€§ <span class="tabCnt" id="tabCntM">(0)</span></button>
      <button class="tabBtn" id="tabF" type="button">ğŸ‘© å¥³æ€§ <span class="tabCnt" id="tabCntF">(0)</span></button>
      <button class="tabBtn" id="tabU" type="button">æœªè¨­å®š <span class="tabCnt" id="tabCntU">(0)</span></button>
    </div>

    <div class="list" id="list"></div>
  </div>
</section>

</div>

<!-- ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHd">
      <strong id="modalTitle">æ–°è¦ç™»éŒ²</strong>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnClose" type="button">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd">
      <input type="hidden" id="cid">

      <div class="row">
        <input class="input" id="cName" placeholder="åå‰ï¼ˆå¿…é ˆï¼‰">

        <input class="input" id="cAge" placeholder="å¹´é½¢" inputmode="numeric" pattern="[0-9]*">

        <!-- âœ… å…ˆé ­0ä¿æŒï¼štext + inputmode -->
        <input class="input" id="cContact" placeholder="é€£çµ¡å…ˆï¼ˆä¾‹: 09012345678ï¼‰"
               type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="tel">

        <select class="input" id="cContactMethod">
          <option value="">é€£çµ¡æ–¹æ³•ï¼ˆæœªè¨­å®šï¼‰</option>
          <option value="é›»è©±">é›»è©±</option>
          <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
          <option value="LINE">LINE</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>

        <input class="input" id="cJoinCount" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ å›æ•°" inputmode="numeric" pattern="[0-9]*">
        <input class="input" id="cMemo" placeholder="ãƒ¡ãƒ¢">
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn primary" id="btnSave" type="button">ä¿å­˜</button>
        <button class="btn danger" id="btnDelete" type="button" style="display:none">å‰Šé™¤</button>
        <button class="btn" id="btnClear" type="button">ã‚¯ãƒªã‚¢</button>
        <span class="meta" id="mStatus">-</span>
        <span class="err" id="mErr"></span>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const ADMIN_KEY = "kei591117";

const $ = id => document.getElementById(id);
let customers = [];

/* =========================
   âœ… ç”·å¥³ã‚¿ãƒ–çŠ¶æ…‹ï¼ˆè¿½è¨˜ï¼‰
========================= */
let sexTab = "all"; // all / M / F / U

function normalizeGender(v){
  const s = String(v??"").trim().toUpperCase();
  if(s==="M" || s==="MALE" || s==="ç”·" || s==="ç”·æ€§") return "M";
  if(s==="F" || s==="FEMALE" || s==="å¥³" || s==="å¥³æ€§") return "F";
  return "";
}
function setSexTab(next){
  sexTab = next;
  const map = {all:"tabAll", M:"tabM", F:"tabF", U:"tabU"};
  ["tabAll","tabM","tabF","tabU"].forEach(id=>$(id).classList.remove("on"));
  $(map[next]).classList.add("on");
  render();
}
$("tabAll").onclick = ()=>setSexTab("all");
$("tabM").onclick   = ()=>setSexTab("M");
$("tabF").onclick   = ()=>setSexTab("F");
$("tabU").onclick   = ()=>setSexTab("U");

function setStatus(msg){ $("status").textContent = msg || "-"; }
function setError(msg){ $("err").textContent = msg || ""; }
function setMStatus(msg){ $("mStatus").textContent = msg || "-"; }
function setMError(msg){ $("mErr").textContent = msg || ""; }

function pickCustomers(j){
  if(!j) return [];
  return j.customers || j.data?.customers || j["é¡§å®¢"] || j["customer"] || [];
}

async function fetchJson(url, opt){
  const res = await fetch(url, Object.assign({cache:"no-store"}, opt||{}));
  const j = await res.json().catch(()=> ({}));
  if(j && j.ok === false && j.error) throw new Error(j.error);
  return j;
}

/* ===== API ===== */
async function apiList(){
  const j = await fetchJson(API_URL + "?action=customers:list&nocache=1");
  return pickCustomers(j);
}
async function apiUpsert(c){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ key: ADMIN_KEY, action:"customers:upsert", customer:c })
  });
}
async function apiDelete(cid){
  await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ key: ADMIN_KEY, action:"customers:delete", cid })
  });
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ===== */
function openModal(mode, c){
  $("modalBack").style.display="flex";
  $("modalBack").setAttribute("aria-hidden","false");
  setMError(""); setMStatus("-");

  if(mode==="new"){
    $("modalTitle").textContent="æ–°è¦ç™»éŒ²";
    fillForm({cid:"",name:"",age:"",contact:"",contactMethod:"",joinCount:"",memo:""});
    $("btnDelete").style.display="none";
  }else{
    $("modalTitle").textContent="ç·¨é›†";
    fillForm(c);
    $("btnDelete").style.display="inline-flex";
  }
}
function closeModal(){
  $("modalBack").style.display="none";
  $("modalBack").setAttribute("aria-hidden","true");
}
$("btnClose").onclick = closeModal;
$("modalBack").addEventListener("click",(e)=>{
  if(e.target === $("modalBack")) closeModal();
});

$("btnNew").onclick = ()=> openModal("new");

/* ===== ãƒ•ã‚©ãƒ¼ãƒ  ===== */
function normalizeContactKeepZero(v){
  // å…ˆé ­0ä¿æŒã®ãŸã‚æ–‡å­—åˆ—åŒ–ã€å…¨è§’â†’åŠè§’ã€ç©ºç™½é™¤å»ï¼ˆå¿…è¦æœ€ä½é™ï¼‰
  const s = String(v ?? "").trim()
    .replace(/[ï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
    .replace(/\s+/g,"");
  return s;
}

function fillForm(c){
  $("cid").value = c.cid || "";
  $("cName").value = c.name || "";
  $("cAge").value = c.age || "";
  $("cContact").value = normalizeContactKeepZero(c.contact || "");
  $("cContactMethod").value = c.contactMethod || "";
  $("cJoinCount").value = (c.joinCount ?? "");
  $("cMemo").value = c.memo || "";
}

function clearForm(){
  fillForm({cid:"",name:"",age:"",contact:"",contactMethod:"",joinCount:"",memo:""});
}

/* ===== ä¿å­˜/å‰Šé™¤ ===== */
$("btnSave").onclick = async ()=>{
  setMError("");
  const name = $("cName").value.trim();
  if(!name){ alert("åå‰ã¯å¿…é ˆã§ã™"); return; }

  const joinCountRaw = $("cJoinCount").value.trim();
  const joinCount = joinCountRaw === "" ? "" : String(Math.max(0, parseInt(joinCountRaw,10) || 0));

  const c = {
    cid: $("cid").value.trim(),
    name,
    age: $("cAge").value.trim(),
    // âœ… å…ˆé ­0ä¿æŒ
    contact: normalizeContactKeepZero($("cContact").value),
    contactMethod: $("cContactMethod").value.trim(),
    joinCount,
    memo: $("cMemo").value.trim()
  };

  try{
    setMStatus("ä¿å­˜ä¸­â€¦");
    await apiUpsert(c);
    customers = await apiList();
    setMStatus("ä¿å­˜ã—ã¾ã—ãŸ");
    setStatus("OK");
    render();
    closeModal();
  }catch(err){
    setMStatus("-");
    setMError("ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};

$("btnClear").onclick = ()=>{ setMError(""); clearForm(); };

$("btnDelete").onclick = async ()=>{
  setMError("");
  const cid = ($("cid").value||"").trim();
  if(!cid){ setMError("å‰Šé™¤ã§ãã¾ã›ã‚“ï¼šcid ãŒç©ºã§ã™"); return; }
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  try{
    setMStatus("å‰Šé™¤ä¸­â€¦");
    await apiDelete(cid);
    customers = await apiList();
    setMStatus("å‰Šé™¤ã—ã¾ã—ãŸ");
    setStatus("OK");
    render();
    closeModal();
  }catch(err){
    setMStatus("-");
    setMError("å‰Šé™¤ã«å¤±æ•—ï¼š " + (err.message || err));
  }
};

/* ===== è¡¨ç¤º ===== */
function render(){
  const q = $("q").value.trim().toLowerCase();

  // âœ… ã¾ãšæ¤œç´¢
  let list = q
    ? customers.filter(c=>{
        const s = `${c.name||""} ${c.contact||""}`.toLowerCase();
        return s.includes(q);
      })
    : [...customers];

  // âœ… æ€§åˆ¥ã‚¿ãƒ–ã§çµã‚Šè¾¼ã¿ï¼ˆgender ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æƒ³å®šï¼‰
  const men = list.filter(c => normalizeGender(c.gender ?? c.sex ?? "") === "M");
  const women = list.filter(c => normalizeGender(c.gender ?? c.sex ?? "") === "F");
  const unknown = list.filter(c => !normalizeGender(c.gender ?? c.sex ?? ""));

  $("tabCntAll").textContent = `(${list.length})`;
  $("tabCntM").textContent   = `(${men.length})`;
  $("tabCntF").textContent   = `(${women.length})`;
  $("tabCntU").textContent   = `(${unknown.length})`;

  if(sexTab==="M") list = men;
  if(sexTab==="F") list = women;
  if(sexTab==="U") list = unknown;

  $("count").textContent = list.length + "ä»¶";

  if(!list.length){
    $("list").innerHTML = `<div class="meta">é¡§å®¢ãŒã„ã¾ã›ã‚“</div>`;
    return;
  }

  $("list").innerHTML = list.map(c=>{
    const origIdx = customers.indexOf(c);
    const g = normalizeGender(c.gender ?? c.sex ?? "");
    const gLabel = g==="M" ? "ç”·æ€§" : g==="F" ? "å¥³æ€§" : "æœªè¨­å®š";
    return `
      <div class="item">
        <div>
          <div class="title">${escapeHtml(c.name||"")}</div>
          <div class="subline">
            æ€§åˆ¥:${escapeHtml(gLabel)}
            ï½œå¹´é½¢:${escapeHtml(c.age||"-")}
            ï½œé€£çµ¡å…ˆ:${escapeHtml(c.contact||"-")}
            ï½œæ–¹æ³•:${escapeHtml(c.contactMethod||"-")}
            ï½œå‚åŠ :${escapeHtml(c.joinCount||"0")}å›
            ${c.memo ? "ï½œ" + escapeHtml(c.memo) : ""}
          </div>
        </div>
        <div class="actions">
          <button class="btn" type="button"
            data-edit-cid="${escapeHtml(c.cid||"")}"
            data-edit-name="${escapeHtml(c.name||"")}"
            data-orig-idx="${origIdx}">ç·¨é›†</button>
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll("[data-edit-name]").forEach(b=>{
    b.onclick = ()=>{
      const cid = (b.dataset.editCid||"").trim();
      const name = (b.dataset.editName||"").trim();
      const origIdx = parseInt(b.dataset.origIdx,10);

      let c = null;
      if(cid) c = customers.find(x=>String(x.cid||"")===cid);
      if(!c && name) c = customers.find(x=>String(x.name||"")===name);
      if(!c && Number.isFinite(origIdx) && origIdx >= 0) c = customers[origIdx];
      if(!c) return;

      openModal("edit", c);
    };
  });
}

function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

$("q").oninput = render;

/* ===== èµ·å‹• ===== */
(async()=>{
  try{
    setError("");
    setStatus("èª­ã¿è¾¼ã¿ä¸­â€¦");
    customers = await apiList();

    // âœ… é€£çµ¡å…ˆã®å…ˆé ­0ãŒè½ã¡ã¦ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã£ã¦ã‚‚è¡¨ç¤ºã¯æ–‡å­—åˆ—ã¨ã—ã¦å‡ºã™
    customers = customers.map(c=>({
      ...c,
      contact: normalizeContactKeepZero(c.contact || "")
    }));

    setStatus("OK");
    render();
  }catch(err){
    setStatus("-");
    setError("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err.message || err));
  }
})();
</script>

</body>
</html>