<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>éå»ã‚¤ãƒ™ãƒ³ãƒˆ</title>

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
  --line:#e5e7eb; --pri:#4f7cff; --pri2:#2dd4bf;
  --shadow:0 10px 26px rgba(15,23,42,.08);
  --radius:16px; --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#f6f7fb 0%, #eef2ff 100%);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,sans-serif;
}
.wrap{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;padding-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--pri),var(--pri2));box-shadow:var(--shadow)}
h1{font-size:18px;margin:0}
.sub{font-size:12px;color:var(--muted)}

.btn{
  border:1px solid var(--line);background:#fff;
  padding:8px 10px;border-radius:10px;cursor:pointer;
  font-size:12px;
  text-decoration:none;color:inherit;display:inline-flex;align-items:center;gap:6px;
}
.btn.primary{border-color:rgba(79,124,255,.35);background:rgba(79,124,255,.06);color:#1f3b8f}
.btn.danger{border-color:#fca5a5;color:#b91c1c}
.btn.small{padding:6px 8px;border-radius:9px;font-size:12px}

.input, .select, .textarea{
  border:1px solid var(--line);padding:8px 10px;border-radius:10px;width:100%;
  font-size:14px;background:#fff;
}
.textarea{min-height:86px;resize:vertical}

.card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.bd{padding:12px 14px}
.meta{font-size:12px;color:var(--muted)}
.err{color:#b91c1c;font-size:12px}

.main{
  display:grid;
  grid-template-columns: 1fr 1fr; /* å·¦ï¼šéå»ã‚¤ãƒ™ãƒ³ãƒˆ / å³ï¼šå‚åŠ è€… */
  gap:12px;
  align-items:start;
}
@media (max-width: 920px){
  .main{grid-template-columns:1fr}
}

/* list */
.list{display:flex;flex-direction:column;gap:10px}
.item{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;
}
.item.active{outline:2px solid rgba(79,124,255,.22);border-color:rgba(79,124,255,.45)}
.item .title{font-weight:800}
.item .subline{font-size:12px;color:var(--muted);margin-top:4px}
.actions{display:flex;gap:6px;flex-wrap:wrap}

/* âœ… ä¸­æ­¢ã‚¤ãƒ™ãƒ³ãƒˆã®è¦‹ãŸç›®ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰ */
.item.canceled{
  opacity:.55;
  filter:grayscale(1);
}

/* right panel */
.sideEmpty{
  padding:18px;
  color:var(--muted);
  font-size:13px;
}
.sideHeader{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.sideTitle{font-weight:900}
.badge{
  font-size:11px;padding:4px 8px;border-radius:999px;
  border:1px solid var(--line);background:#fff;color:var(--muted);
}
.badge.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08);color:#065f46}
/* âœ… ä¸­æ­¢ãƒãƒƒã‚¸ */
.badge.cancel{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#991b1b}

.pList{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.pItem{
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.pName{font-weight:800;display:flex;align-items:center;gap:8px}
.pMeta{font-size:12px;color:var(--muted);margin-top:4px}
.heart{font-size:14px;line-height:1}
.pRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

/* modal */
.modalBack{
  position:fixed; inset:0;
  background:rgba(15,23,42,.35);
  display:none;
  align-items:center; justify-content:center;
  z-index:50;
}
.modal{
  width:min(840px, calc(100% - 18px));
  background:#fff;border-radius:16px;
  box-shadow:0 18px 60px rgba(15,23,42,.25);
  overflow:hidden;
}
.modalHd{
  padding:12px 14px;border-bottom:1px solid var(--line);
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
}
.modalBd{padding:12px 14px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:640px){ .grid2{grid-template-columns:1fr} }
.fi{display:flex;flex-direction:column;gap:6px}
.fi label{font-size:12px;color:var(--muted)}
.hr{height:1px;background:var(--line);margin:12px 0}

/* right-half popup (drawer) */
.drawerBack{
  position:fixed; inset:0;
  background:rgba(15,23,42,.25);
  display:none;
  z-index:60;
}
.drawer{
  position:absolute; top:0; right:0; height:100%;
  width:min(50vw, 720px); /* âœ… å³åŠåˆ† */
  background:#fff;
  box-shadow:-12px 0 40px rgba(15,23,42,.22);
  display:flex;flex-direction:column;
}
@media (max-width:920px){
  .drawer{width:100%;}
}
.drawerHd{
  padding:12px 14px;border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.drawerBd{padding:12px 14px;overflow:auto}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>éå»ã‚¤ãƒ™ãƒ³ãƒˆ</h1>
        <div class="sub">éå»ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†ï¼å‚åŠ è€…ç¢ºèªï¼ˆã‚«ãƒƒãƒ—ãƒ«æˆç«‹ã¯è‰²ãƒãƒ¼ãƒˆã§è¡¨ç¤ºï¼‰</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <a class="btn" id="backAdmin" href="./admin.html">ç®¡ç†ã¸æˆ»ã‚‹</a>

      <label class="meta" style="display:flex;gap:6px;align-items:center;user-select:none">
        <input type="checkbox" id="copyToToday">
        ã‚³ãƒ”ãƒ¼æ™‚ã«æ—¥ä»˜ã‚’ã€Œä»Šæ—¥ã€ã«ã™ã‚‹
      </label>

      <button class="btn" id="btnReload">æ›´æ–°</button>
    </div>
  </header>

  <div class="main">

    <!-- å·¦ï¼šéå»ã‚¤ãƒ™ãƒ³ãƒˆ -->
    <section class="card">
      <div class="hd">
        <div style="font-weight:900">éå»ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</div>
        <div class="meta" id="count">-</div>
        <div style="flex:1"></div>
        <input class="input" id="q" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«/å ´æ‰€/ãƒ¡ãƒ¢â€¦ï¼‰">
        <div class="meta" id="status">-</div>
      </div>
      <div class="bd">
        <div class="list" id="list"></div>
        <div class="err" id="err" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- å³ï¼šé¸æŠã‚¤ãƒ™ãƒ³ãƒˆã®å‚åŠ è€…ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
    <section class="card" id="rightCard">
      <div class="hd">
        <div style="font-weight:900">å‚åŠ è€…</div>
        <div class="meta" id="pStatus">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div style="flex:1"></div>
        <button class="btn" id="btnPop" style="display:none">å³åŠåˆ†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è¡¨ç¤º</button>
      </div>
      <div class="bd" id="rightBody">
        <div class="sideEmpty">å·¦ã®ä¸€è¦§ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã¶ã¨ã€å‚åŠ è€…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </div>
    </section>

  </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modalBack" id="editBack">
  <div class="modal">
    <div class="modalHd">
      <div style="font-weight:900" id="editTitle">ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="btn" id="btnEditClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBd">
      <div class="grid2">
        <div class="fi">
          <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input class="input" id="fTitle" placeholder="ä¾‹ï¼šã‚«ãƒ©ã‚ªã‚±æ‹æ´»">
        </div>
        <div class="fi">
          <label>æ—¥ä»˜ï¼ˆYYYY-MM-DD / 2026/01/24 / 2026å¹´1æœˆ24æ—¥ ã§ã‚‚OKï¼‰</label>
          <input class="input" id="fDate" placeholder="ä¾‹ï¼š2026-01-24">
        </div>

        <div class="fi">
          <label>é–‹å§‹ï¼ˆtimeFromï¼‰</label>
          <input class="input" id="fFrom" placeholder="ä¾‹ï¼š19:30">
        </div>
        <div class="fi">
          <label>çµ‚äº†ï¼ˆtimeToï¼‰</label>
          <input class="input" id="fTo" placeholder="ä¾‹ï¼š21:00">
        </div>

        <div class="fi">
          <label>å ´æ‰€</label>
          <input class="input" id="fPlace" placeholder="ä¾‹ï¼šã‚¤ã‚¨ãƒ­ãƒ¼ãƒ•ãƒ©ãƒƒã‚°">
        </div>
        <div class="fi">
          <label>ç¨®é¡ï¼ˆnoteï¼‰</label>
          <input class="input" id="fNote" placeholder="ä¾‹ï¼šã‚«ãƒ©ã‚ªã‚±æ‹æ´»">
        </div>

        <div class="fi">
          <label>ç”·æ€§æ–™é‡‘ï¼ˆpriceMï¼‰</label>
          <input class="input" id="fPriceM" placeholder="ä¾‹ï¼š4000">
        </div>
        <div class="fi">
          <label>å¥³æ€§æ–™é‡‘ï¼ˆpriceFï¼‰</label>
          <input class="input" id="fPriceF" placeholder="ä¾‹ï¼š3000">
        </div>

        <div class="fi">
          <label>å‹Ÿé›†äººæ•°ï¼ˆslotsï¼‰</label>
          <input class="input" id="fSlots" placeholder="ä¾‹ï¼š20">
        </div>
        <div class="fi">
          <label>å¯¾è±¡ï¼ˆtargetï¼‰</label>
          <input class="input" id="fTarget" placeholder="ä¾‹ï¼š30ã€œ45æ­³ä¸­å¿ƒ">
        </div>
      </div>

      <div class="fi" style="margin-top:10px">
        <label>æ¦‚è¦ï¼ˆsummary / memo / overviewï¼‰</label>
        <textarea class="textarea" id="fSummary" placeholder="ä¾‹ï¼š2å¯¾2ã€œå°‘äººæ•°ã§â€¦"></textarea>
      </div>

      <div class="hr"></div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn primary" id="btnEditSave">ä¿å­˜</button>
      </div>

      <div class="err" id="editErr" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- å³åŠåˆ†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆå‚åŠ è€…ï¼‰ -->
<div class="drawerBack" id="drawerBack">
  <div class="drawer">
    <div class="drawerHd">
      <div style="font-weight:900" id="drawerTitle">å‚åŠ è€…</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="btnDrawerClose">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="drawerBd" id="drawerBody"></div>
  </div>
</div>

<script>
/* ========= è¨­å®š ========= */
const API_URL = "https://script.google.com/macros/s/AKfycbyQkxsI-5zHH4f5BcFz_bkvDEdPwWF3stmmALEEYga8x0VrJBzcF8Fr61UjITWm0BK7/exec";
const ADMIN_KEY = "kei591117";
const $ = id => document.getElementById(id);

let events = [];
let selectedEventId = null;
let selectedParticipants = [];

/* ========= ç®¡ç†ã¸æˆ»ã‚‹ï¼šåŒéšå±¤ã¸å¼·åˆ¶ ========= */
const ADMIN_PAGE = "./admin.html";
$("backAdmin").setAttribute("href", ADMIN_PAGE);
$("backAdmin").addEventListener("click",(e)=>{
  e.preventDefault();
  window.location.assign(ADMIN_PAGE);
});

/* ========= util ========= */
function escapeHtml(s){
  return String(s??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function pad2(n){return String(n).padStart(2,"0")}

/* âœ… ä¸­æ­¢åˆ¤å®šï¼ˆadmin ã¨æƒãˆã‚‹ï¼‰ */
function isCanceled(e){
  return e?.status === "canceled" || e?.isCanceled === true || e?.canceled === "1";
}

/* ========= æ—¥ä»˜å‡¦ç†ï¼ˆå®Œå…¨å¯¾å¿œï¼‰ ========= */
function parseDateFlex(v){
  if(v===null||v===undefined||v==="") return null;

  if(Object.prototype.toString.call(v)==="[object Date]" && !isNaN(v.getTime())) return v;

  if(typeof v==="number"){
    if(v>20000 && v<80000){
      const base=new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime()+v*86400000);
    }
    const d=new Date(v);
    return isNaN(d)?null:d;
  }

  const s=String(v).trim();

  if(/^\d{4,6}$/.test(s)){
    const n=Number(s);
    if(n>20000 && n<80000){
      const base=new Date(Date.UTC(1899,11,30));
      return new Date(base.getTime()+n*86400000);
    }
  }

  const jp=s.match(/^(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if(jp) return new Date(jp[1],jp[2]-1,jp[3]);

  const m=s.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
  if(m) return new Date(m[1],m[2]-1,m[3]);

  const d=new Date(s);
  return isNaN(d)?null:d;
}
function isPastEvent(e){
  const raw = e.date ?? e.eventDate ?? e.startDate ?? "";
  const d=parseDateFlex(raw);
  if(!d) return false;
  const today=new Date(); today.setHours(0,0,0,0);
  d.setHours(0,0,0,0);
  return d<today;
}
function fmtJP(v){
  const d=parseDateFlex(v);
  if(!d) return String(v||"-");
  return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
}
function sortByDateDesc(a,b){
  const da=parseDateFlex(a.date ?? a.eventDate ?? a.startDate), db=parseDateFlex(b.date ?? b.eventDate ?? b.startDate);
  const ta=da?da.getTime():0, tb=db?db.getTime():0;
  return tb-ta;
}

function normalizeEvent(e){
  const title = e.title ?? e.name ?? "(ç„¡é¡Œ)";
  const date  = e.date ?? e.eventDate ?? e.startDate ?? "";
  const timeFrom = e.timeFrom ?? "";
  const timeTo   = e.timeTo ?? "";
  const time  =
    (timeFrom || timeTo) ? `${timeFrom||""}${timeTo?("ã€œ"+timeTo):"ã€œ"}` :
    (e.time ?? "");
  const place = e.place ?? "";
  const note  = e.note ?? e.memo ?? e.description ?? "";
  return {title,date,time,timeFrom,timeTo,place,note};
}

/* ========= ãƒãƒ¼ãƒˆï¼ˆã‚«ãƒƒãƒ—ãƒ«æˆç«‹ï¼‰ ========= */
const HEARTS = ["â¤ï¸","ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ©·","ğŸ¤","ğŸ–¤"];

/* â˜…è¿½è¨˜ï¼šæ—¥æœ¬èªâ†’è‹±èªãƒˆãƒ¼ã‚¯ãƒ³å¤‰æ› */
function normalizeColorToken_(s){
  const v = String(s||"").trim();
  if(!v) return "";
  const map = {
    "èµ¤":"red",
    "ãƒ”ãƒ³ã‚¯":"pink",
    "ç´«":"purple",
    "é’":"blue",
    "ç·‘":"green",
    "é»„":"yellow",
    "é»„è‰²":"yellow",
    "ã‚ªãƒ¬ãƒ³ã‚¸":"orange",
    "é»’":"black",
    "èŒ¶":"brown",
    "ãªã—":"",
    "ç„¡ã—":"",
    "ç„¡":""
  };
  if(map[v] !== undefined) return map[v];
  return v.toLowerCase();
}
function pickHeartColorToken(p){
  const raw = (p.coupleColor ?? p.heartColor ?? p.color ?? "");
  return normalizeColorToken_(raw);
}
function colorToHeart(token){
  const t = normalizeColorToken_(token);
  if(!t) return "";
  if(t.includes("red")) return "â¤ï¸";
  if(t.includes("orange")) return "ğŸ§¡";
  if(t.includes("yellow")) return "ğŸ’›";
  if(t.includes("green")) return "ğŸ’š";
  if(t.includes("blue")) return "ğŸ’™";
  if(t.includes("purple")) return "ğŸ’œ";
  if(t.includes("pink")) return "ğŸ©·";
  if(t.includes("brown")) return "ğŸ¤";
  if(t.includes("black")) return "ğŸ–¤";
  if(/^#?[0-9a-f]{6}$/i.test(t)){
    const n = parseInt(t.replace("#","").slice(-2),16);
    return HEARTS[n % HEARTS.length];
  }
  return "";
}
function coupleHeart(p){
  const token = pickHeartColorToken(p);
  if(token){
    const h = colorToHeart(token);
    if(h) return h;
  }
  const no = (p.coupleNo ?? p.coupleId ?? p.couple ?? p.matchNo);
  const n = Number(no);
  if(!isNaN(n) && n>0) return HEARTS[(n-1) % HEARTS.length];
  const flag = p.isCouple ?? p.matched ?? p.isMatched ?? "";
  if(flag === true || String(flag).toLowerCase()==="true" || String(flag)==="1"){
    return "â¤ï¸";
  }
  return "";
}

/* ========= API ========= */
async function fetchJson(url, opt){
  const r = await fetch(url, Object.assign({cache:"no-store"}, opt||{}));
  const j = await r.json().catch(()=> ({}));
  if(j && j.ok === false && j.error) throw new Error(j.error);
  return j;
}

async function apiPastList(){
  try{
    const j = await fetchJson(API_URL + "?action=past:list");
    return j.events || j.data?.events || [];
  }catch(_){
    const j = await fetchJson(API_URL + "?action=list");
    return j.events || j.data?.events || [];
  }
}

async function apiUpsert(ev){
  const j = await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ key: ADMIN_KEY, action:"upsert", event: ev })
  });
  return j.events || j.data?.events || [];
}
async function apiDelete(id){
  const j = await fetchJson(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ key: ADMIN_KEY, action:"delete", id })
  });
  return j.events || j.data?.events || [];
}

/* ===== å‚åŠ è€…å–å¾—ï¼ˆè¤‡æ•°å€™è£œã‚’é †ã«è©¦ã™ï¼‰ ===== */
async function apiParticipantsByEvent(eventId){
  const tries = [
    `${API_URL}?action=participants:list&eventId=${encodeURIComponent(eventId)}`,
    `${API_URL}?action=participants:byEvent&eventId=${encodeURIComponent(eventId)}`,
    `${API_URL}?action=participant:list&eventId=${encodeURIComponent(eventId)}`,
    `${API_URL}?action=attendees:list&eventId=${encodeURIComponent(eventId)}`
  ];
  let lastErr = null;
  for(const u of tries){
    try{
      const j = await fetchJson(u);
      const ps = j.participants || j.attendees || j.data?.participants || j.data?.attendees || j.items || [];
      if(Array.isArray(ps)) return ps;
      if(ps && Array.isArray(ps.list)) return ps.list;
      return [];
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("å‚åŠ è€…APIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆGASå´ã« action=participants:list ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰");
}

/* ========= å³å´ã®å‚åŠ è€…è¡¨ç¤º ========= */
function participantLabel(p){
  const name = p.name ?? p.fullName ?? p.nickname ?? "(åå‰ãªã—)";
  const age  = p.age ?? p.Age ?? "";
  const sex  = p.sex ?? p.gender ?? p.Gender ?? "";
  const tel  = p.tel ?? p.phone ?? "";
  const contact = p.contact ?? p.contactWay ?? p.contactMethod ?? "";
  const perk = p.perk ?? p.benefit ?? p.special ?? "";
  const memo = p.memo ?? p.note ?? "";
  return {name,age,sex,tel,contact,perk,memo};
}

function renderParticipantsPanel(ev, participants){
  const n = normalizeEvent(ev);
  const title = `${fmtJP(n.date)}ï½œ${n.title}`;
  const canceled = isCanceled(ev);

  const listHtml = (participants||[]).map(p=>{
    const pp = participantLabel(p);
    const h = coupleHeart(p);
    const badge = h ? `<span class="badge ok">ã‚«ãƒƒãƒ—ãƒ«æˆç«‹</span>` : ``;

    const metaParts = [];
    if(pp.sex) metaParts.push(`æ€§åˆ¥ï¼š${pp.sex}`);
    if(pp.age) metaParts.push(`å¹´é½¢ï¼š${pp.age}`);
    if(pp.contact) metaParts.push(`é€£çµ¡ï¼š${pp.contact}`);
    if(pp.tel) metaParts.push(`TELï¼š${pp.tel}`);
    if(pp.perk) metaParts.push(`ç‰¹å…¸ï¼š${pp.perk}`);
    if(pp.memo) metaParts.push(`ãƒ¡ãƒ¢ï¼š${pp.memo}`);

    return `
      <div class="pItem">
        <div>
          <div class="pName">
            ${h ? `<span class="heart" title="ã‚«ãƒƒãƒ—ãƒ«æˆç«‹">${h}</span>` : ``}
            ${escapeHtml(pp.name)}
          </div>
          <div class="pMeta">${escapeHtml(metaParts.join(" / ") || "â€”")}</div>
        </div>
        <div class="pRight">
          ${badge}
        </div>
      </div>
    `;
  }).join("");

  const head = `
    <div class="sideHeader">
      <div>
        <div class="sideTitle">${escapeHtml(title)} ${canceled ? `<span class="badge cancel" style="margin-left:6px">ä¸­æ­¢</span>` : ``}</div>
        <div class="meta">${escapeHtml(n.time||"-")}ãƒ»${escapeHtml(n.place||"-")}${n.note?("ãƒ»"+escapeHtml(n.note)):""}</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <span class="badge">${participants.length}å</span>
      </div>
    </div>
  `;

  const body = `
    ${head}
    <div class="pList">
      ${participants.length ? listHtml : `<div class="meta" style="padding:6px 2px">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>`}
    </div>
    <div class="meta" style="margin-top:10px">
      â€»ãƒãƒ¼ãƒˆè‰²ã¯ã€ŒcoupleColor / coupleNo / isCoupleã€ç­‰ã®å€¤ã‹ã‚‰è‡ªå‹•åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚
    </div>
  `;

  $("rightBody").innerHTML = body;
  $("btnPop").style.display = "inline-flex";
}

/* ========= å³åŠåˆ†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ========= */
function openDrawer(title, html){
  $("drawerTitle").textContent = title || "å‚åŠ è€…";
  $("drawerBody").innerHTML = html || "";
  $("drawerBack").style.display = "block";
}
function closeDrawer(){ $("drawerBack").style.display="none"; }
$("btnDrawerClose").onclick = closeDrawer;
$("drawerBack").addEventListener("click",(e)=>{
  if(e.target.id==="drawerBack") closeDrawer();
});

/* ========= ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ========= */
let editingEvent = null;

function openEditModal(ev){
  editingEvent = ev;

  const n = normalizeEvent(ev);
  $("editTitle").textContent = `ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†ï¼š${fmtJP(n.date)}ï½œ${n.title}`;

  $("editErr").textContent = "";

  $("fTitle").value = (ev.title ?? ev.name ?? "");
  $("fDate").value  = (ev.date ?? ev.eventDate ?? ev.startDate ?? "");
  $("fFrom").value  = (ev.timeFrom ?? "");
  $("fTo").value    = (ev.timeTo ?? "");
  $("fPlace").value = (ev.place ?? "");
  $("fNote").value  = (ev.note ?? "");
  $("fPriceM").value= (ev.priceM ?? ev.feeM ?? "");
  $("fPriceF").value= (ev.priceF ?? ev.feeF ?? "");
  $("fSlots").value = (ev.slots ?? "");
  $("fTarget").value= (ev.target ?? "");
  $("fSummary").value= (ev.summary ?? ev.overview ?? ev.memo ?? "");

  $("editBack").style.display="flex";
}
function closeEditModal(){
  $("editBack").style.display="none";
  editingEvent = null;
}
$("btnEditClose").onclick = closeEditModal;
$("editBack").addEventListener("click",(e)=>{
  if(e.target.id==="editBack") closeEditModal();
});

$("btnEditSave").onclick = async ()=>{
  if(!editingEvent) return;

  $("editErr").textContent = "";
  $("status").textContent = "ä¿å­˜ä¸­â€¦";

  const ev = {...editingEvent};

  ev.title = ($("fTitle").value||"").trim();

  const dRaw = ($("fDate").value||"").trim();
  if(dRaw){
    ev.date = dRaw;
    ev.eventDate = dRaw;
    ev.startDate = dRaw;
  }

  ev.timeFrom = ($("fFrom").value||"").trim();
  ev.timeTo   = ($("fTo").value||"").trim();

  if(ev.timeFrom || ev.timeTo){
    ev.time = `${ev.timeFrom||""}${ev.timeTo?("ã€œ"+ev.timeTo):"ã€œ"}`;
  }

  ev.place  = ($("fPlace").value||"").trim();
  ev.note   = ($("fNote").value||"").trim();

  const pm = ($("fPriceM").value||"").trim();
  const pf = ($("fPriceF").value||"").trim();
  ev.priceM = pm; ev.feeM = pm;
  ev.priceF = pf; ev.feeF = pf;

  ev.slots  = ($("fSlots").value||"").trim();
  ev.target = ($("fTarget").value||"").trim();

  const sum = ($("fSummary").value||"").trim();
  ev.summary = sum;
  ev.overview = sum;
  ev.memo = sum;

  try{
    await apiUpsert(ev);
    closeEditModal();
    await reload();
    if(selectedEventId && String(selectedEventId)===String(ev.id)){
      await selectEvent(ev.id, {skipHighlight:false});
    }
    $("status").textContent = "OK";
  }catch(err){
    $("status").textContent = "å¤±æ•—";
    $("editErr").textContent = "ä¿å­˜ã«å¤±æ•—ï¼š " + (err.message || err);
  }
};

/* ========= æç”»ï¼ˆå·¦ãƒªã‚¹ãƒˆï¼‰ ========= */
function render(){
  $("err").textContent = "";

  const q=($("q").value||"").toLowerCase();

  // âœ… ã€Œéå»ã€ã¾ãŸã¯ã€Œä¸­æ­¢ã€ã¯ã“ã“ã«å‡ºã™
  const past = events
    .filter(e => isPastEvent(e) || isCanceled(e))
    .filter(e=>{
      if(!q) return true;
      const n = normalizeEvent(e);
      const s = `${n.title} ${n.place} ${n.note}`.toLowerCase();
      return s.includes(q);
    })
    .sort(sortByDateDesc);

  $("count").textContent=`${past.length}ä»¶`;

  if(!past.length){
    $("list").innerHTML=`<div class="meta">éå»ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }

  $("list").innerHTML=past.map(e=>{
    const n = normalizeEvent(e);
    const active = (selectedEventId && String(selectedEventId)===String(e.id)) ? "active" : "";
    const canceled = isCanceled(e) ? "canceled" : "";
    const cancelBadge = isCanceled(e) ? `<span class="badge cancel">ä¸­æ­¢</span>` : ``;

    return `
      <div class="item ${active} ${canceled}" data-sel="${escapeHtml(e.id)}">
        <div style="min-width:220px">
          <div class="title">${fmtJP(n.date)}ï½œ${escapeHtml(n.title)} ${cancelBadge}</div>
          <div class="subline">${escapeHtml(n.time||"-")}ãƒ»${escapeHtml(n.place||"-")}${n.note?("ãƒ»"+escapeHtml(n.note)):""}</div>
        </div>
        <div class="actions">
          <button class="btn small primary" data-viewp="${escapeHtml(e.id)}">å‚åŠ è€…</button>
          <button class="btn small" data-edit="${escapeHtml(e.id)}">ç·¨é›†</button>
          <button class="btn small" data-copy="${escapeHtml(e.id)}">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn small danger" data-del="${escapeHtml(e.id)}">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }).join("");

  document.querySelectorAll("[data-sel]").forEach(row=>{
    row.onclick = (ev)=>{
      if(ev.target && ev.target.closest("button")) return;
      selectEvent(row.dataset.sel);
    };
  });

  document.querySelectorAll("[data-viewp]").forEach(b=>{
    b.onclick = async ()=>{
      await selectEvent(b.dataset.viewp);
      openParticipantsPopup();
    };
  });

  document.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick=()=>{
      const ev = events.find(x=>String(x.id)===String(b.dataset.edit));
      if(!ev) return;
      openEditModal(ev);
    };
  });

  document.querySelectorAll("[data-copy]").forEach(b=>{
    b.onclick=async()=>{
      const src=events.find(x=>String(x.id)===String(b.dataset.copy));
      if(!src) return;

      const c = {...src, id:""};

      if($("copyToToday").checked){
        const t = new Date(); t.setHours(0,0,0,0);
        const y=t.getFullYear();
        const m=pad2(t.getMonth()+1);
        const d=pad2(t.getDate());
        c.date = `${y}-${m}-${d}`;
        c.eventDate = c.date;
        c.startDate = c.date;
      }

      try{
        $("status").textContent="ã‚³ãƒ”ãƒ¼ä¸­â€¦";
        await apiUpsert(c);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆç®¡ç†ç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
        $("status").textContent="OK";
      }catch(err){
        $("status").textContent="å¤±æ•—";
        $("err").textContent = "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ï¼š " + (err.message || err);
      }
    };
  });

  document.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick=async()=>{
      if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      try{
        $("status").textContent="å‰Šé™¤ä¸­â€¦";
        await apiDelete(b.dataset.del);
        if(selectedEventId && String(selectedEventId)===String(b.dataset.del)){
          selectedEventId = null;
          selectedParticipants = [];
          $("pStatus").textContent = "ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„";
          $("rightBody").innerHTML = `<div class="sideEmpty">å·¦ã®ä¸€è¦§ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã¶ã¨ã€å‚åŠ è€…ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>`;
          $("btnPop").style.display="none";
        }
        await reload();
      }catch(err){
        $("status").textContent="å¤±æ•—";
        $("err").textContent = "å‰Šé™¤ã«å¤±æ•—ï¼š " + (err.message || err);
      }
    };
  });
}

/* ========= é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ â†’ å‚åŠ è€…å–å¾— ========= */
async function selectEvent(eventId, opt){
  selectedEventId = eventId;
  render();

  const ev = events.find(x=>String(x.id)===String(eventId));
  if(!ev){
    $("pStatus").textContent = "ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
    return;
  }

  $("pStatus").textContent = "å‚åŠ è€…ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
  $("rightBody").innerHTML = `<div class="meta">èª­ã¿è¾¼ã¿ä¸­â€¦</div>`;
  $("btnPop").style.display="none";

  try{
    const ps = await apiParticipantsByEvent(eventId);
    selectedParticipants = ps || [];
    $("pStatus").textContent = "OK";
    renderParticipantsPanel(ev, selectedParticipants);
  }catch(err){
    selectedParticipants = [];
    $("pStatus").textContent = "èª­è¾¼å¤±æ•—";
    $("rightBody").innerHTML = `
      <div class="err">å‚åŠ è€…ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š${escapeHtml(err.message||err)}</div>
      <div class="meta" style="margin-top:8px">
        â€»GASå´ã«ã€Œaction=participants:list&amp;eventId=...ã€ã®APIãŒå¿…è¦ã§ã™ã€‚
      </div>
    `;
    $("btnPop").style.display="none";
  }
}

/* ========= å³åŠåˆ†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆå‚åŠ è€…ï¼‰ ========= */
function openParticipantsPopup(){
  if(!selectedEventId){
    alert("å…ˆã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„");
    return;
  }
  const ev = events.find(x=>String(x.id)===String(selectedEventId));
  if(!ev) return;

  const n = normalizeEvent(ev);
  const title = `å‚åŠ è€…ï¼ˆ${fmtJP(n.date)}ï½œ${n.title}${isCanceled(ev) ? "ï½œä¸­æ­¢" : ""}ï¼‰`;

  const html = $("rightBody").innerHTML || "";
  openDrawer(title, html);
}
$("btnPop").onclick = openParticipantsPopup;

/* ========= èµ·å‹• ========= */
async function reload(){
  $("status").textContent="èª­è¾¼ä¸­â€¦";
  $("err").textContent="";
  try{
    events = await apiPastList();
    $("status").textContent="OK";
    render();
  }catch(err){
    $("status").textContent="èª­è¾¼å¤±æ•—";
    $("err").textContent = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š " + (err.message || err);
  }
}
$("btnReload").onclick=reload;
$("q").oninput=render;

reload();
</script>
</body>
</html>